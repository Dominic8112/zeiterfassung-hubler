<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a1628">
<title>Zeiterfassung - Hubler Metallbau</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--primary:#FF6B35;--primary-glow:rgba(255,107,53,.25);--primary-dim:rgba(255,107,53,.08);--secondary:#004E89;--accent:#F7B801;--bg-deep:#0a1628;--bg-card:#111d33;--bg-card-hover:#162440;--bg-input:#0d1a2e;--bg-surface:#1a2a45;--border:rgba(255,255,255,.06);--border-active:rgba(255,107,53,.3);--text:#e8edf5;--text-dim:#7a8ba8;--text-muted:#4a5a75;--success:#22c55e;--success-glow:rgba(34,197,94,.2);--danger:#ef4444;--danger-glow:rgba(239,68,68,.15);--warning:#F7B801;--radius:12px;--radius-sm:8px;--radius-lg:16px;--shadow:0 4px 24px rgba(0,0,0,.3);--shadow-lg:0 8px 40px rgba(0,0,0,.4);--transition:.2s cubic-bezier(.4,0,.2,1);--font-ui:'DM Sans',sans-serif;--font-mono:'JetBrains Mono',monospace}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}html{font-size:16px;scroll-behavior:smooth}body{font-family:var(--font-ui);background:var(--bg-deep);color:var(--text);min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}body::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse at 20% 20%,rgba(0,78,137,.15) 0%,transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(255,107,53,.08) 0%,transparent 50%);pointer-events:none;z-index:0}::-webkit-scrollbar{width:6px}::-webkit-scrollbar-thumb{background:var(--text-muted);border-radius:3px}
#login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100dvh;padding:2rem;position:relative;z-index:1}.login-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:3rem 2.5rem;max-width:420px;width:100%;text-align:center;box-shadow:var(--shadow-lg);animation:fadeUp .6s ease}@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.login-logo{font-size:2.5rem;margin-bottom:.5rem}.login-title{font-size:1.5rem;font-weight:700;margin-bottom:.25rem;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.login-subtitle{color:var(--text-dim);font-size:.9rem;margin-bottom:2rem}
.ms-login-btn{display:flex;align-items:center;justify-content:center;gap:12px;width:100%;padding:14px 24px;background:#2f2f2f;color:#fff;border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);font-size:1rem;font-weight:500;font-family:var(--font-ui);cursor:pointer;transition:var(--transition)}.ms-login-btn:hover{background:#3a3a3a;transform:translateY(-1px)}.ms-login-btn svg{width:20px;height:20px}
.login-divider{display:flex;align-items:center;gap:1rem;margin:1.5rem 0;color:var(--text-muted);font-size:.8rem}.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.demo-section{margin-top:8px}.demo-pin{display:flex;gap:8px;justify-content:center;margin-bottom:12px}.demo-pin input{width:44px;height:44px;text-align:center;font-size:1.2rem;font-family:var(--font-mono);background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);outline:none}.demo-pin input:focus{border-color:var(--primary)}.demo-users{display:none;flex-direction:column;gap:6px;max-height:280px;overflow-y:auto}.demo-users.show{display:flex}.demo-user-btn{display:flex;align-items:center;gap:10px;width:100%;padding:10px 14px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:var(--font-ui);font-size:.875rem;cursor:pointer;transition:var(--transition);text-align:left}.demo-user-btn:hover{border-color:var(--border-active);background:var(--bg-card-hover)}.demo-user-btn .uid{color:var(--text-muted);font-family:var(--font-mono);font-size:.72rem;min-width:52px}
#app{display:none;min-height:100dvh;position:relative;z-index:1}
.topbar{position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:rgba(10,22,40,.85);backdrop-filter:blur(20px);border-bottom:1px solid var(--border)}.topbar-brand{font-weight:700;font-size:1.1rem;color:var(--primary)}.topbar-right{display:flex;align-items:center;gap:10px}.topbar-avatar{width:32px;height:32px;border-radius:50%;background:var(--primary-dim);border:2px solid var(--primary);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.75rem;color:var(--primary)}.topbar-name{font-size:.85rem;color:var(--text-dim)}
.sync-status{font-size:.7rem;padding:3px 8px;border-radius:10px;font-weight:500}.sync-status.online{background:var(--success-glow);color:var(--success)}.sync-status.offline{background:var(--danger-glow);color:var(--danger)}.sync-status.syncing{background:rgba(247,184,1,.15);color:var(--warning);animation:blink 1s infinite}@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.logout-btn{background:none;border:1px solid var(--border);color:var(--text-dim);padding:6px 12px;border-radius:var(--radius-sm);font-family:var(--font-ui);font-size:.8rem;cursor:pointer}.logout-btn:hover{border-color:var(--danger);color:var(--danger)}
.nav-tabs{display:flex;flex-wrap:wrap;gap:2px;padding:8px 12px;background:rgba(10,22,40,.5);border-bottom:1px solid var(--border)}.nav-tab{flex:0 0 calc(25% - 2px);min-width:0;padding:10px 6px;border:none;background:transparent;color:var(--text-dim);font-family:var(--font-ui);font-size:.75rem;font-weight:500;cursor:pointer;border-radius:var(--radius-sm);white-space:nowrap;text-align:center}.nav-tab:hover{color:var(--text);background:var(--bg-surface)}.nav-tab.active{color:var(--primary);background:var(--primary-dim);font-weight:600}
.tab-content{display:none;padding:20px;max-width:800px;margin:0 auto}.tab-content.active{display:block;animation:fadeIn .3s ease}@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.timer-display{text-align:center;padding:2rem 0}.timer-time{font-family:var(--font-mono);font-size:4rem;font-weight:700;letter-spacing:-2px;line-height:1;margin-bottom:.5rem}.timer-time.running{color:var(--success)}.timer-time.paused{color:var(--warning);animation:blink 1s infinite}.timer-date{color:var(--text-dim);font-size:.9rem;margin-bottom:.25rem}.timer-project-display{color:var(--primary);font-size:.85rem;font-weight:500;min-height:1.2em}.timer-controls{display:flex;justify-content:center;gap:12px;margin-top:1.5rem}
.timer-btn{width:64px;height:64px;border-radius:50%;border:2px solid;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.4rem;background:transparent;font-family:var(--font-ui)}.timer-btn.start{border-color:var(--success);color:var(--success)}.timer-btn.start:hover{background:var(--success);color:#fff;transform:scale(1.05)}.timer-btn.pause{border-color:var(--warning);color:var(--warning)}.timer-btn.pause:hover{background:var(--warning);color:#000}.timer-btn.stop{border-color:var(--danger);color:var(--danger)}.timer-btn.stop:hover{background:var(--danger);color:#fff}
.form-group{margin-bottom:1rem}.form-label{display:block;font-size:.8rem;font-weight:500;color:var(--text-dim);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}.form-label .req{color:var(--primary)}.form-input,.form-select{width:100%;padding:12px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:var(--font-ui);font-size:.95rem;outline:none}.form-input:focus,.form-select:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}.form-select{appearance:none;cursor:pointer}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.autocomplete-wrapper{position:relative}.autocomplete-list{position:absolute;top:100%;left:0;right:0;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);max-height:220px;overflow-y:auto;z-index:50;display:none;box-shadow:var(--shadow-lg)}.autocomplete-list.show{display:block}.autocomplete-item{padding:10px 14px;cursor:pointer;font-size:.85rem;border-bottom:1px solid var(--border)}.autocomplete-item:hover,.autocomplete-item.hl{background:var(--primary-dim);color:var(--primary)}.autocomplete-item .pn{font-family:var(--font-mono);color:var(--accent);font-weight:600;margin-right:6px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 24px;border:none;border-radius:var(--radius-sm);font-family:var(--font-ui);font-size:.9rem;font-weight:600;cursor:pointer}.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{transform:translateY(-1px)}.btn-secondary{background:var(--bg-surface);color:var(--text);border:1px solid var(--border)}.btn-secondary:hover{border-color:var(--border-active)}.btn-danger{background:rgba(239,68,68,.1);color:var(--danger);border:1px solid rgba(239,68,68,.2)}.btn-success{background:rgba(34,197,94,.1);color:var(--success);border:1px solid rgba(34,197,94,.2)}.btn-block{width:100%}.btn-sm{padding:8px 16px;font-size:.8rem}
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px}.card-title{font-size:.8rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;text-align:center}.stat-box{background:var(--bg-surface);padding:12px;border-radius:8px}.stat-num{font-family:var(--font-mono);font-size:1.3rem;font-weight:700}.stat-label{font-size:.7rem;color:var(--text-dim);margin-top:2px}
.stat-total{font-family:var(--font-mono);font-size:2rem;font-weight:700;color:var(--primary)}.stat-bar-item{display:flex;align-items:center;gap:12px;margin-bottom:10px}.stat-bar-label{width:90px;font-size:.8rem;color:var(--text-dim);flex-shrink:0}.stat-bar-track{flex:1;height:8px;background:var(--bg-surface);border-radius:4px;overflow:hidden}.stat-bar-fill{height:100%;border-radius:4px}.stat-bar-value{width:50px;text-align:right;font-family:var(--font-mono);font-size:.8rem}
.calendar-nav{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:20px}.cal-btn{width:40px;height:40px;border-radius:50%;border:1px solid var(--border);background:var(--bg-card);color:var(--text);font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center}.cal-btn:hover{border-color:var(--primary);color:var(--primary)}.cal-btn:disabled{opacity:.3}.cal-date{font-family:var(--font-mono);font-size:1.05rem;font-weight:600;min-width:180px;text-align:center}
.entry-card{background:var(--bg-surface);border-radius:var(--radius-sm);padding:12px 16px;margin-bottom:8px;border-left:3px solid var(--primary);display:flex;justify-content:space-between;align-items:flex-start;gap:8px}.entry-info{flex:1;min-width:0}.entry-time{font-family:var(--font-mono);font-size:.85rem;font-weight:500}.entry-meta{font-size:.78rem;color:var(--text-dim);margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.entry-right{display:flex;align-items:center;gap:6px;flex-shrink:0}.entry-duration{font-family:var(--font-mono);font-size:.85rem;color:var(--accent);font-weight:600}.entry-action{width:28px;height:28px;border-radius:6px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;font-size:.85rem;display:flex;align-items:center;justify-content:center}.entry-action:hover{background:var(--bg-card);color:var(--text)}
.week-row{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)}.week-day{width:30px;font-size:.75rem;font-weight:600;color:var(--text-dim)}.week-bar{flex:1;height:24px;background:var(--bg-surface);border-radius:4px;overflow:hidden;display:flex}.week-seg{height:100%}.week-hrs{width:45px;text-align:right;font-family:var(--font-mono);font-size:.8rem}
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}.modal-overlay.show{display:flex}.modal{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;max-width:500px;width:100%;box-shadow:var(--shadow-lg);max-height:90vh;overflow-y:auto}.modal-title{font-size:1.1rem;font-weight:700;margin-bottom:16px}.modal-actions{display:flex;gap:12px;margin-top:20px;justify-content:flex-end;flex-wrap:wrap}
.pause-opt{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:var(--radius-sm);cursor:pointer;border:1px solid var(--border);margin-bottom:8px}.pause-opt:hover{border-color:var(--border-active)}.pause-opt.sel{border-color:var(--primary);background:var(--primary-dim)}.pause-opt input{accent-color:var(--primary)}.pause-opt label{cursor:pointer;flex:1;font-size:.9rem}.pause-opt .pt{font-family:var(--font-mono);color:var(--text-dim);font-size:.8rem}
.pause-summary{background:var(--bg-surface);border-radius:var(--radius-sm);padding:14px}.pause-row{display:flex;justify-content:space-between;font-size:.9rem;margin-bottom:4px}.pause-row.total{border-top:1px solid var(--border);padding-top:8px;margin-top:8px;font-weight:700;font-size:1rem;color:var(--primary)}
.export-card{display:flex;align-items:center;gap:16px;padding:20px;cursor:pointer}.export-card:hover{background:var(--bg-card-hover)}.export-icon{font-size:2rem}.export-info h3{font-size:1rem;margin-bottom:4px}.export-info p{font-size:.8rem;color:var(--text-dim)}
.proj-list-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);font-size:.85rem}.proj-list-item .proj-id{font-family:var(--font-mono);color:var(--accent);font-weight:600;min-width:35px}.proj-list-item .proj-name{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.proj-list-item .proj-badge{font-size:.7rem;padding:2px 8px;border-radius:10px}.proj-scroll{max-height:400px;overflow-y:auto}.proj-count{font-size:.8rem;color:var(--text-dim);margin-bottom:8px}
.sp-info{background:var(--bg-surface);border-radius:var(--radius-sm);padding:14px;font-size:.85rem;margin-bottom:16px;line-height:1.5}
.abs-badge{font-size:.7rem;padding:2px 10px;border-radius:10px;font-weight:600}.abs-badge.pending{background:rgba(247,184,1,.15);color:var(--warning)}.abs-badge.approved{background:var(--success-glow);color:var(--success)}.abs-badge.rejected{background:var(--danger-glow);color:var(--danger)}
.abs-btn{padding:6px 14px;border:none;border-radius:6px;font-family:var(--font-ui);font-size:.8rem;font-weight:600;cursor:pointer}.abs-btn.yes{background:var(--success-glow);color:var(--success)}.abs-btn.yes:hover{background:var(--success);color:#fff}.abs-btn.no{background:var(--danger-glow);color:var(--danger)}.abs-btn.no:hover{background:var(--danger);color:#fff}
.day-check{display:inline-flex;align-items:center;gap:4px;padding:8px 12px;background:var(--bg-surface);border-radius:6px;cursor:pointer;font-size:.85rem}.day-check input{accent-color:var(--primary)}
.toast-container{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:300;display:flex;flex-direction:column;gap:8px;pointer-events:none}.toast{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:12px 20px;font-size:.875rem;box-shadow:var(--shadow-lg);animation:toastIn .3s ease;pointer-events:auto;white-space:nowrap}.toast.success{border-left:3px solid var(--success)}.toast.error{border-left:3px solid var(--danger)}.toast.warning{border-left:3px solid var(--warning)}.toast.info{border-left:3px solid var(--secondary)}@keyframes toastIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.empty-state{text-align:center;padding:3rem 1rem;color:var(--text-dim)}.empty-icon{font-size:3rem;margin-bottom:1rem;opacity:.5}
.timer-indicator{position:fixed;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--success),var(--primary));z-index:999;display:none}.timer-indicator.on{display:block;animation:pulse-bar 2s infinite}@keyframes pulse-bar{0%,100%{opacity:1}50%{opacity:.4}}
@media(max-width:600px){.topbar{padding:10px 14px}.topbar-name{display:none}.nav-tab{flex:0 0 calc(25% - 2px);padding:8px 4px;font-size:.68rem}.tab-content{padding:14px}.timer-time{font-size:3rem}.timer-btn{width:56px;height:56px}.form-row{grid-template-columns:1fr}}

.weekly-report{margin-bottom:24px;border-bottom:2px solid var(--border);padding-bottom:16px}
.report-header{border-bottom:3px solid var(--accent);padding-bottom:10px;margin-bottom:12px}
.report-header h3{margin:0;color:var(--accent);font-size:1.1rem}
.report-period{color:var(--text-dim);font-size:.8rem}
.report-day{border:1px solid var(--border);border-radius:var(--radius);padding:10px;margin-bottom:8px;background:var(--bg-card)}
.report-day.has-warning{border-left:4px solid #f59e0b}
.report-day-header{display:flex;justify-content:space-between;font-weight:700;margin-bottom:6px;padding-bottom:5px;border-bottom:1px solid var(--border)}
.report-day-name{color:var(--text)}
.report-day-hours{color:var(--accent)}
.report-entry{padding:4px 0 4px 12px;border-left:2px solid var(--border);margin:4px 0;font-size:.8rem}
.report-entry.empty{color:var(--text-dim);font-style:italic}
.report-entry-time{font-weight:600;color:#4A90D9}
.report-entry-detail{color:var(--text)}
.report-entry-pause{color:var(--text-dim);font-size:.75rem}
.report-entry-note{color:var(--text-dim);font-size:.75rem;font-style:italic}
.report-warning{padding:4px 8px;border-radius:4px;font-size:.75rem;margin-top:4px}
.report-warning.warn{background:rgba(245,158,11,.15);color:#f59e0b}
.report-warning.info{background:rgba(59,130,246,.1);color:#60a5fa}
.report-summary{background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-top:10px}
.report-sum-row{display:flex;justify-content:space-between;padding:3px 0;font-size:.85rem}
.report-sum-row.positive strong{color:#22c55e}
.report-sum-row.negative strong{color:#ef4444}
.report-sum-row.warn{color:#f59e0b}

/* Month Calendar Grid */
.month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.month-grid .mg-header{font-size:.7rem;font-weight:600;text-align:center;padding:6px 2px;color:var(--text-dim)}
.month-grid .mg-header.weekend{color:var(--text-muted);opacity:.6}
.month-cell{min-height:52px;padding:4px;border-radius:6px;cursor:pointer;transition:background .15s;font-size:.75rem;position:relative;background:var(--bg-surface);border:1px solid transparent}
.month-cell:hover{background:var(--bg-hover)}
.month-cell.today{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent)}
.month-cell.selected{background:var(--accent);color:#fff}
.month-cell.selected .mc-hours{color:#fff}
.month-cell.weekend{background:rgba(255,255,255,.03);opacity:.7}
.month-cell.other-month{opacity:.3}
.month-cell .mc-day{font-weight:600;font-size:.8rem}
.month-cell .mc-hours{font-family:var(--font-mono);font-size:.68rem;color:var(--success);margin-top:2px}
.month-cell .mc-badge{font-size:.6rem;padding:1px 3px;border-radius:3px;display:inline-block;margin-top:1px}
.month-cell .mc-badge.holiday{background:var(--danger);color:#fff}
.month-cell .mc-badge.absence{background:var(--warning);color:#000}
.month-cell .mc-badge.has-entries{background:var(--success);color:#fff}

/* MA-Edit Tab */
.mae-table{width:100%;font-size:.8rem;border-collapse:collapse}
.mae-table th{text-align:left;padding:8px 6px;border-bottom:2px solid var(--border);font-weight:600;font-size:.72rem;color:var(--text-dim);text-transform:uppercase}
.mae-table td{padding:6px;border-bottom:1px solid var(--border);vertical-align:middle}
.mae-table tr:hover{background:var(--bg-hover)}
.mae-actions{display:flex;gap:4px}
.mae-actions button{padding:2px 6px;font-size:.8rem;background:none;border:none;cursor:pointer;border-radius:4px}
.mae-actions button:hover{background:var(--bg-hover)}
.mae-import-row{padding:6px 4px;border-bottom:1px solid var(--border);font-size:.78rem}
.mae-import-row.error{background:rgba(239,68,68,.1)}
.mae-import-row.warn{background:rgba(251,191,36,.1)}
.mae-import-row.ok{background:rgba(34,197,94,.05)}

</style>
</head>
<body>
<div class="timer-indicator" id="timerIndicator"></div>
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">â±ï¸</div><h1 class="login-title">Zeiterfassung</h1><p class="login-subtitle">Hubler Metallbau AG</p>
    <button class="ms-login-btn" id="msLoginBtn"><svg viewBox="0 0 23 23"><path fill="#f25022" d="M1 1h10v10H1z"/><path fill="#00a4ef" d="M1 12h10v10H1z"/><path fill="#7fba00" d="M12 1h10v10H12z"/><path fill="#ffb900" d="M12 12h10v10H12z"/></svg>Mit Microsoft anmelden</button>
    <div id="authDebug" style="display:none;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:8px;padding:12px;margin:12px 0;text-align:left;font-size:.75rem;color:#f87171;font-family:var(--font-mono);word-break:break-all;max-height:120px;overflow-y:auto"></div>
    <div class="login-divider">Demo-Modus</div>
    <div class="demo-section">
      <div class="demo-pin" id="demoPin">
        <input type="password" maxlength="1" inputmode="numeric" id="pin1" autocomplete="off">
        <input type="password" maxlength="1" inputmode="numeric" id="pin2" autocomplete="off">
        <input type="password" maxlength="1" inputmode="numeric" id="pin3" autocomplete="off">
        <input type="password" maxlength="1" inputmode="numeric" id="pin4" autocomplete="off">
        <input type="password" maxlength="1" inputmode="numeric" id="pin5" autocomplete="off">
      </div>
      <div class="demo-users" id="demoUsers"></div>
    </div>
  </div>
</div>
<div id="app">
  <div class="topbar"><span class="topbar-brand">â± Hubler</span><div class="topbar-right"><span class="sync-status" id="syncStatus">âš¡ Lokal</span><div class="topbar-avatar" id="userAvatar"></div><span class="topbar-name" id="userName"></span><button class="logout-btn" id="logoutBtn">â»</button></div></div>
  <nav class="nav-tabs" id="navTabs">
    <button class="nav-tab active" data-tab="timer">â± Timer</button>
    <button class="nav-tab" data-tab="manual">âœï¸ Manuell</button>
    <button class="nav-tab" data-tab="today">ğŸ“Š Heute</button>
    <button class="nav-tab" data-tab="week">ğŸ“ˆ Woche</button>
    <button class="nav-tab" data-tab="calendar">ğŸ“… Kalender</button>
    <button class="nav-tab" data-tab="absence">ğŸ– Abwesenheit</button>
    <button class="nav-tab" data-tab="report" style="display:none">ğŸ“Š Report</button>
    <button class="nav-tab" data-tab="export">ğŸ’¾ Export</button>
    <button class="nav-tab" data-tab="dashboard" style="display:none">ğŸ“Š Dashboard</button>
    <button class="nav-tab" data-tab="maedit" style="display:none">ğŸ‘¥ MA-Edit</button>
    <button class="nav-tab" data-tab="admin" style="display:none">âš™ï¸ Admin</button>
  </nav>

  <!-- TIMER -->
  <div class="tab-content active" id="tab-timer">
    <div class="timer-display"><div class="timer-date" id="timerDate"></div><div class="timer-time" id="timerDisplay">00:00:00</div><div class="timer-project-display" id="timerProjDisp"></div></div>
    <div class="timer-controls"><button class="timer-btn start" id="btnStart">â–¶</button><button class="timer-btn pause" id="btnPause" style="display:none">â¸</button><button class="timer-btn stop" id="btnStop" style="display:none">â¹</button></div>
    <div style="text-align:center;margin-top:8px"><button class="btn btn-secondary btn-sm" id="btnSwitch" style="display:none" onclick="switchProject()">ğŸ”„ Projekt wechseln</button></div>
    <div id="segmentInfo"></div>
    <div style="margin-top:1.5rem">
      <div class="form-group autocomplete-wrapper"><label class="form-label">Projekt <span class="req">*</span></label><input type="text" class="form-input" id="timerProject" placeholder="Nummer oder Name..." autocomplete="off"><div class="autocomplete-list" id="timerProjectAC"></div></div>
      <div class="form-group"><label class="form-label">Kostenstelle <span class="req">*</span></label><select class="form-select" id="timerKS"><option value="">â€” Bitte wÃ¤hlen â€”</option><option>BÃ¼ro</option><option>Zuschnitt</option><option>BAZ</option><option>Werkstatt</option><option>Montage</option></select></div>
      <div class="form-group"><label class="form-label">Bemerkung</label><input type="text" class="form-input" id="timerNote" placeholder="Optional..."></div>
    </div>
    <!-- Personal Notifications -->
    <div class="card" style="margin-top:24px">
      <div class="card-title">ğŸ”” Benachrichtigungen</div>
      <div class="sp-info"><strong>Status:</strong> <span id="myNotifStatus">...</span></div>
      <div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn btn-primary btn-sm" id="myNotifEnableBtn">ğŸ”” Aktivieren</button><button class="btn btn-secondary btn-sm" id="myNotifTestBtn">ğŸ§ª Test</button></div>
      <div class="form-group"><label class="form-label">â° Morgen-Erinnerung</label><div class="form-row"><input type="time" class="form-input" id="myNotifMorning" value="06:55"><select class="form-select" id="myNotifMorningOn"><option value="1">An</option><option value="0">Aus</option></select></div></div>
      <div class="form-group"><label class="form-label">ğŸ  Feierabend-Erinnerung</label><div class="form-row"><input type="time" class="form-input" id="myNotifEvening" value="16:45"><select class="form-select" id="myNotifEveningOn"><option value="1">An</option><option value="0">Aus</option></select></div></div>
      <button class="btn btn-primary btn-block btn-sm" id="myNotifSaveBtn">ğŸ’¾ Speichern</button>
    </div>
  </div>

  <!-- MANUAL -->
  <div class="tab-content" id="tab-manual">
    <h2 style="font-size:1.1rem;margin-bottom:16px">Manuelle Zeiterfassung</h2>
    <div class="form-group"><label class="form-label">Datum <span class="req">*</span></label><input type="date" class="form-input" id="manDate"></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Start <span class="req">*</span></label><input type="time" class="form-input" id="manStart" value="07:00"></div><div class="form-group"><label class="form-label">Ende <span class="req">*</span></label><input type="time" class="form-input" id="manEnd" value="17:00"></div></div>
    <div class="form-group autocomplete-wrapper"><label class="form-label">Projekt <span class="req">*</span></label><input type="text" class="form-input" id="manProject" placeholder="Suchen..." autocomplete="off"><div class="autocomplete-list" id="manProjectAC"></div></div>
    <div class="form-group"><label class="form-label">Kostenstelle <span class="req">*</span></label><select class="form-select" id="manKS"><option value="">â€” WÃ¤hlen â€”</option><option>BÃ¼ro</option><option>Zuschnitt</option><option>BAZ</option><option>Werkstatt</option><option>Montage</option></select></div>
    <div class="form-group"><label class="form-label">Bemerkung</label><input type="text" class="form-input" id="manNote" placeholder="Optional..."></div>
    <div class="card" style="padding:12px;margin-bottom:12px;background:var(--bg-surface)">
      <div class="form-label" style="margin-bottom:8px">â˜• Pausen</div>
      <div class="form-row">
        <div class="form-group"><label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:.85rem"><input type="checkbox" id="manZnueni" checked> ZnÃ¼ni-Pause (15 Min)</label></div>
        <div class="form-group"><label class="form-label">Mittagspause</label><select class="form-select" id="manMittag"><option value="60min">1 Stunde</option><option value="30min">30 Minuten</option><option value="none">Durchgearbeitet</option></select></div>
      </div>
    </div>
    <button class="btn btn-primary btn-block" id="manSaveBtn">ğŸ’¾ Speichern</button>
  </div>

  <!-- TODAY -->
  <div class="tab-content" id="tab-today"><div class="card"><div class="card-title" id="todayTitle">Heute</div><div class="stat-total" id="todayTotal">0.0h</div><div id="todayBars" style="margin-top:12px"></div></div><div id="todayEntries"></div></div>

  <!-- WEEK -->
  <div class="tab-content" id="tab-week"><div class="card"><div class="card-title">Diese Woche</div><div class="stat-total" id="weekTotal">0.0h</div><div id="weekDayBars" style="margin-top:16px"></div></div><div class="card"><div class="card-title">Nach Kostenstelle</div><div id="weekKSBars"></div></div></div>

  <!-- CALENDAR -->
  <div class="tab-content" id="tab-calendar">
    <div class="calendar-nav">
      <button class="cal-btn" id="calPrev">â€¹</button>
      <div class="cal-date" id="calMonthTitle"></div>
      <button class="cal-btn" id="calNext">â€º</button>
      <button class="btn btn-secondary btn-sm" id="calToday" style="margin-left:8px;font-size:.75rem">Heute</button>
    </div>
    <div class="card" style="padding:8px;overflow-x:auto">
      <div class="month-grid" id="calMonthGrid"></div>
    </div>
    <div id="calDayDetail" style="display:none">
      <div class="card">
        <div class="card-title" id="calDayTitle">EintrÃ¤ge</div>
        <div class="stat-total" id="calDayTotal">0.0h</div>
        <div id="calDayKS" style="margin-top:8px"></div>
      </div>
      <div class="card">
        <div class="card-title" id="calDayEntriesTitle">EintrÃ¤ge</div>
        <div id="calDayEntries"></div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="tab-content" id="tab-dashboard">
    <h2 style="font-size:1.1rem;margin-bottom:16px">ğŸ“Š Firmen-Dashboard</h2>
    <div class="card">
      <div class="form-row">
        <div class="form-group"><label class="form-label">Zeitraum</label><select class="form-select" id="dashPeriod"><option value="month">Aktueller Monat</option><option value="quarter">Quartal</option><option value="year" selected>Ganzes Jahr</option><option value="custom">Benutzerdefiniert</option></select></div>
        <div class="form-group" style="flex:2"><label class="form-label">Projekte filtern</label><input type="text" class="form-input" id="dashProjSearch" placeholder="ğŸ” Suchen..." oninput="dashFilterProjects()"></div>
      </div>
      <div id="dashProjPicker" style="max-height:180px;overflow-y:auto;padding:8px;margin:8px 0;border:1px solid var(--border);border-radius:8px">
        <div style="display:flex;gap:8px;margin-bottom:6px;align-items:center"><button class="btn btn-secondary btn-sm" onclick="dashSelectAll()" style="font-size:.72rem">Alle</button><button class="btn btn-secondary btn-sm" onclick="dashSelectNone()" style="font-size:.72rem">Keine</button><span id="dashProjCount" style="font-size:.75rem;color:var(--text-dim)"></span></div>
        <div id="dashProjCheckboxes"></div>
      </div>
      <div id="dashCustomRange" style="display:none" class="form-row"><div class="form-group"><label class="form-label">Von</label><input type="date" class="form-input" id="dashFrom"></div><div class="form-group"><label class="form-label">Bis</label><input type="date" class="form-input" id="dashTo"></div></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-primary btn-sm" onclick="loadDashboard()">ğŸ“Š Laden</button><button class="btn btn-secondary btn-sm" onclick="exportDashboardHTML()">ğŸ–¨ Report Export</button><button class="btn btn-secondary btn-sm" onclick="exportDashboardCSV()">ğŸ“¤ CSV Export</button></div>
    </div>
    <div id="dashKPIs"></div>
    <div id="dashKS" class="card" style="display:none"><div class="card-title">Kostenstellen-Verteilung</div><div id="dashKSContent"></div></div>
    <div id="dashProjects" class="card" style="display:none"><div class="card-title" id="dashProjTitle">Projekt-Ãœbersicht</div><div id="dashProjectsList"></div></div>
    <div id="dashAbsence" class="card" style="display:none"><div class="card-title">Abwesenheiten & Ferien-Stand</div><div id="dashAbsContent"></div></div>
  </div>

  <!-- MA-EDIT (Admin only) -->
  <div class="tab-content" id="tab-maedit">
    <h2 style="font-size:1.1rem;margin-bottom:16px">ğŸ‘¥ Mitarbeiter-EintrÃ¤ge editieren</h2>
    <div class="card">
      <div class="form-row">
        <div class="form-group"><label class="form-label">Mitarbeiter</label><select class="form-select" id="maeEmp"></select></div>
        <div class="form-group"><label class="form-label">Monat</label><input type="month" class="form-input" id="maeMonth"></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-primary btn-sm" onclick="maeLoad()">ğŸ“‹ Laden</button>
        <button class="btn btn-secondary btn-sm" onclick="maeAddEntry()">+ Eintrag hinzufÃ¼gen</button>
        <button class="btn btn-secondary btn-sm" onclick="maeAddAbsence()">+ Abwesenheit</button>
        <button class="btn btn-secondary btn-sm" onclick="maeShowImport()">ğŸ“¥ CSV Import</button>
        <button class="btn btn-secondary btn-sm" onclick="maeDownloadTemplate()">ğŸ“„ CSV Vorlage</button>
        <button class="btn btn-secondary btn-sm" onclick="maeShowAbsImport()">ğŸ“¥ Abwesenheiten CSV</button>
        <button class="btn btn-secondary btn-sm" onclick="maeDownloadAbsTemplate()">ğŸ“„ Abw. Vorlage</button>
      </div>
    </div>
    <div id="maeImportArea" style="display:none" class="card">
      <div class="card-title">ğŸ“¥ CSV Import</div>
      <input type="file" id="maeCSVFile" accept=".csv,.txt" style="margin-bottom:8px" onchange="maeParseCSV()">
      <div id="maeImportPreview"></div>
      <button class="btn btn-primary btn-sm" id="maeImportBtn" style="display:none" onclick="maeDoImport()">âœ… Importieren</button>
    </div>
    <div id="maeAbsImportArea" style="display:none" class="card">
      <div class="card-title">ğŸ“¥ Abwesenheiten CSV Import</div>
      <input type="file" id="maeAbsCSVFile" accept=".csv,.txt" style="margin-bottom:8px" onchange="maeParseAbsCSV()">
      <div id="maeAbsImportPreview"></div>
      <button class="btn btn-primary btn-sm" id="maeAbsImportBtn" style="display:none" onclick="maeDoAbsImport()">âœ… Importieren</button>
    </div>
    <div id="maeEntries" class="card" style="display:none">
      <div class="card-title" id="maeEntriesTitle">ZeiteintrÃ¤ge</div>
      <div id="maeEntriesList"></div>
    </div>
    <div id="maeAbsences" class="card" style="display:none">
      <div class="card-title">Abwesenheiten</div>
      <div id="maeAbsencesList"></div>
    </div>
  </div>

  <!-- MAE Edit Modal -->
  <div class="modal-overlay" id="maeEditModal"><div class="modal"><div class="modal-title">âœï¸ <span id="maeEditTitle">Eintrag bearbeiten</span></div>
    <div class="form-group"><label class="form-label">Datum</label><input type="date" class="form-input" id="maeEditDate"></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Start</label><input type="time" class="form-input" id="maeEditStart"></div><div class="form-group"><label class="form-label">Ende</label><input type="time" class="form-input" id="maeEditEnd"></div></div>
    <div class="form-group autocomplete-wrapper"><label class="form-label">Projekt</label><input type="text" class="form-input" id="maeEditProject" placeholder="Suchen..." autocomplete="off"><div class="autocomplete-list" id="maeEditProjectAC"></div></div>
    <div class="form-group"><label class="form-label">Kostenstelle</label><select class="form-select" id="maeEditKS"><option value="">â€” WÃ¤hlen â€”</option><option>BÃ¼ro</option><option>Zuschnitt</option><option>BAZ</option><option>Werkstatt</option><option>Montage</option></select></div>
    <div class="form-row"><div class="form-group"><label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:.85rem"><input type="checkbox" id="maeEditZnueni" checked> ZnÃ¼ni</label></div><div class="form-group"><label class="form-label">Mittagspause</label><select class="form-select" id="maeEditMittag"><option value="60min">1 Stunde</option><option value="30min">30 Min</option><option value="none">Durchgearbeitet</option></select></div></div>
    <div class="form-group"><label class="form-label">Bemerkung</label><input type="text" class="form-input" id="maeEditNote"></div>
    <div class="modal-actions"><button class="btn btn-secondary" onclick="$('maeEditModal').classList.remove('show')">Abbrechen</button><button class="btn btn-primary" onclick="maeSaveEdit()">ğŸ’¾ Speichern</button></div>
  </div></div>

  <!-- MAE Absence Edit Modal -->
  <div class="modal-overlay" id="maeAbsEditModal"><div class="modal"><div class="modal-title">âœï¸ Abwesenheit bearbeiten</div>
    <div class="form-group"><label class="form-label">Typ</label><select class="form-select" id="maeAbsType"><option value="Ferien">ğŸ–ï¸ Ferien</option><option value="Krankheit">ğŸ¤’ Krankheit</option><option value="Unfall">ğŸ¤• Unfall</option><option value="MilitÃ¤r/Zivildienst">ğŸ–ï¸ MilitÃ¤r/Zivildienst</option><option value="Mutterschaft/Vaterschaft">ğŸ‘¶ Mutterschaft/Vaterschaft</option><option value="Umzug">ğŸ“¦ Umzug</option><option value="Unbezahlt">ğŸš« Unbezahlt</option><option value="Sonstiges">ğŸ“‹ Sonstiges</option></select></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Von</label><input type="date" class="form-input" id="maeAbsFrom"></div><div class="form-group"><label class="form-label">Bis</label><input type="date" class="form-input" id="maeAbsTo"></div></div>
    <div class="form-group"><label class="form-label">Dauer</label><select class="form-select" id="maeAbsDuration"><option value="full">Ganzer Tag</option><option value="morning">Vormittag</option><option value="afternoon">Nachmittag</option></select></div>
    <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="maeAbsStatus"><option value="pending">Pendent</option><option value="approved">Genehmigt</option><option value="rejected">Abgelehnt</option></select></div>
    <div class="form-group"><label class="form-label">Bemerkung</label><input type="text" class="form-input" id="maeAbsNote"></div>
    <div class="modal-actions"><button class="btn btn-secondary" onclick="$('maeAbsEditModal').classList.remove('show')">Abbrechen</button><button class="btn btn-primary" onclick="maeSaveAbsEdit()">ğŸ’¾ Speichern</button></div>
  </div></div>

  <!-- Employee Manage Modal -->
  <div class="modal-overlay" id="empManageModal"><div class="modal"><div class="modal-title">âœï¸ Mitarbeiter bearbeiten</div>
    <div class="form-group"><label class="form-label">MA-Nr</label><input type="text" class="form-input" id="empMgId" disabled></div>
    <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="empMgName"></div>
    <div class="form-group"><label class="form-label">E-Mail</label><input type="email" class="form-input" id="empMgEmail" placeholder="name@firma.ch oder privat"></div>
    <div class="form-group"><label class="form-label">Rolle</label><select class="form-select" id="empMgRole"><option value="employee">Mitarbeiter</option><option value="approver">Approver</option><option value="admin">Admin</option></select></div>
    <div class="modal-actions"><button class="btn btn-secondary" onclick="$('empManageModal').classList.remove('show')">Abbrechen</button><button class="btn btn-primary" onclick="saveEmpManageModal()">ğŸ’¾ Speichern</button></div>
  </div></div>

  <!-- ABSENCE -->
  <div class="tab-content" id="tab-absence">
    <h2 style="font-size:1.1rem;margin-bottom:16px">ğŸ– Abwesenheiten & Ferien</h2>
    <div class="card">
      <div class="card-title">Neue Abwesenheit beantragen</div>
      <div class="form-group"><label class="form-label">Typ <span class="req">*</span></label><select class="form-select" id="absType"><option value="">â€” Bitte wÃ¤hlen â€”</option><option value="Ferien">ğŸ–ï¸ Ferien</option><option value="Krankheit">ğŸ¤’ Krankheit</option><option value="Unfall">ğŸ¤• Unfall</option><option value="MilitÃ¤r/Zivildienst">ğŸ–ï¸ MilitÃ¤r/Zivildienst</option><option value="Mutterschaft/Vaterschaft">ğŸ‘¶ Mutterschaft/Vaterschaft</option><option value="Umzug">ğŸ“¦ Umzug</option><option value="Unbezahlt">ğŸš« Unbezahlt</option><option value="Sonstiges">ğŸ“‹ Sonstiges</option></select></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Von <span class="req">*</span></label><input type="date" class="form-input" id="absFrom"></div><div class="form-group"><label class="form-label">Bis <span class="req">*</span></label><input type="date" class="form-input" id="absTo"></div></div>
      <div class="form-group"><label class="form-label">Dauer</label><select class="form-select" id="absDuration"><option value="full">Ganzer Tag</option><option value="morning">Nur Vormittag (halber Tag)</option><option value="afternoon">Nur Nachmittag (halber Tag)</option></select></div>
      <div class="form-group"><label class="form-label">Bemerkung</label><input type="text" class="form-input" id="absNote" placeholder="Optional..."></div>
      <button class="btn btn-primary btn-block" id="absSaveBtn">ğŸ“¨ Antrag einreichen</button>
    </div>
    <div class="card"><div class="card-title">FerienÃ¼bersicht <span id="absYear"></span></div><div id="absStats"></div></div>
    <div class="card" id="absApprovalCard" style="display:none"><div class="card-title">âœ… AntrÃ¤ge zur Freigabe</div><div id="absPendingList"></div></div>
    <div class="card"><div class="card-title">Meine Abwesenheiten</div><div id="absList"></div></div>
  </div>

  <!-- EXPORT -->
  <div class="tab-content" id="tab-report">
<div class="card" id="weeklyReportCard" style="display:none">
  <h3 style="margin-bottom:8px">ğŸ“‹ Wochenreport</h3>
  <p style="color:var(--text-dim);font-size:.8rem;margin-bottom:12px">Detaillierter Report pro Mitarbeiter: Alle EintrÃ¤ge, Pausen-Kontrolle und Warnhinweise.</p>
  <div class="form-row">
    <div class="form-group"><label>Kalenderwoche</label><input type="week" id="weeklyReportWeek" class="form-input"></div>
    <div class="form-group"><label>Mitarbeiter</label><select id="weeklyReportEmp" class="form-input"><option value="all">Alle Mitarbeiter</option></select></div>
  </div>
  <div style="display:flex;gap:8px;margin-top:12px">
    <button class="btn btn-primary" onclick="showWeeklyReports()">ğŸ“‹ Report anzeigen</button>
    <button class="btn" style="background:var(--bg-card);border:1px solid var(--border);color:var(--text)" onclick="exportWeeklyReportPrint()">ğŸ–¨ Druckversion</button>
  </div>
  <div id="weeklyReportResult" style="margin-top:16px"></div>
</div>

    <h2 style="font-size:1.1rem;margin-bottom:16px">ğŸ“Š Mitarbeiter-Report</h2>
    <div class="card">
      <div class="card-title">Auswertung fÃ¼r QualifikationsgesprÃ¤che</div>
      <div id="reportContent"></div>
    </div>
  </div>
  <div class="tab-content" id="tab-export"><h2 style="font-size:1.1rem;margin-bottom:16px">Export & Backup</h2><div class="card export-card" id="expWeek"><div class="export-icon">ğŸ“Š</div><div class="export-info"><h3>Diese Woche</h3><p>CSV der aktuellen Woche</p></div></div><div class="card export-card" id="expMonth"><div class="export-icon">ğŸ“…</div><div class="export-info"><h3>Dieser Monat</h3><p>CSV des aktuellen Monats</p></div></div><div class="card export-card" id="expAll"><div class="export-icon">ğŸ’¾</div><div class="export-info"><h3>Alle Daten</h3><p>Alle ZeiteintrÃ¤ge</p></div></div></div>

  <!-- ADMIN -->
  <div class="tab-content" id="tab-admin">
    <h2 style="font-size:1.1rem;margin-bottom:16px">âš™ï¸ Administration</h2>

    <!-- EMPLOYEE SETTINGS -->
    <div class="card"><div class="card-title">ğŸ‘¥ Mitarbeiter-Einstellungen</div><div class="sp-info"><p style="color:var(--text-dim)">Pensum, Arbeitstage, Ferienanspruch und Vorjahres-Guthaben pro Mitarbeiter.</p></div><div id="empSettingsList"></div></div>

    <!-- BETRIEBSFERIEN -->
    <div class="card"><div class="card-title">ğŸ¢ Betriebsferien & BrÃ¼ckentage</div>

    <!-- EMPLOYEE MANAGEMENT -->
    </div><div class="card"><div class="card-title">ğŸ‘¥ Mitarbeiter verwalten</div>
      <div id="empManageList"></div>
      <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:12px">
        <div style="font-weight:600;font-size:.85rem;margin-bottom:8px">Neuer Mitarbeiter</div>
        <div class="form-row"><div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="newEmpName" placeholder="Vorname Nachname"></div><div class="form-group"><label class="form-label">E-Mail</label><input type="email" class="form-input" id="newEmpEmail" placeholder="name@firma.ch oder privat"></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Rolle</label><select class="form-select" id="newEmpRole"><option value="employee">Mitarbeiter</option><option value="approver">Approver</option><option value="admin">Admin</option></select></div><div class="form-group"><label class="form-label">MA-Nr</label><input type="text" class="form-input" id="newEmpId" placeholder="Auto (HM-009)"></div></div>
        <button class="btn btn-primary btn-sm" onclick="addNewEmployee()">+ Mitarbeiter hinzufÃ¼gen</button>
      </div>
    </div>

    <div class="card"><div class="card-title">ğŸ¢ Betriebsferien & BrÃ¼ckentage</div>
      <p style="font-size:.78rem;color:var(--text-dim);margin-bottom:12px">Tage an denen die Firma geschlossen ist. Werden allen MA als Ferientag angerechnet â€“ ausser sie arbeiten an dem Tag.</p>
      <div id="bfList"></div>
      <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:12px">
        <div class="form-row"><div class="form-group"><label class="form-label">Typ</label><select class="form-select" id="bfType"><option value="Betriebsferien">ğŸ¢ Betriebsferien</option><option value="BrÃ¼ckentag">ğŸŒ‰ BrÃ¼ckentag</option></select></div><div class="form-group"><label class="form-label">Bezeichnung</label><input type="text" class="form-input" id="bfLabel" placeholder="z.B. Weihnachtsferien"></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Von</label><input type="date" class="form-input" id="bfFrom"></div><div class="form-group"><label class="form-label">Bis</label><input type="date" class="form-input" id="bfTo"></div></div>
        <button class="btn btn-primary btn-sm" onclick="addBetriebsferien()">+ HinzufÃ¼gen</button>
      </div>
    </div>

    <!-- ABSENCE OVERVIEW (all employees) -->
    <div class="card"><div class="card-title">ğŸ– Abwesenheiten aller Mitarbeiter</div><div id="adminAbsList"></div><button class="btn btn-secondary btn-sm" id="exportAbsBtn" style="margin-top:12px">ğŸ“¤ CSV Export</button></div>

    <!-- SHAREPOINT -->
    <div class="card"><div class="card-title">ğŸ“¡ SharePoint</div><div class="sp-info"><strong>Status:</strong> <span id="spStatusText">âš¡ Lokal</span></div><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-secondary btn-sm" id="syncNowBtn">ğŸ”„ Sync</button><button class="btn btn-secondary btn-sm" id="forceSPUpload">ğŸ“¤ Upload</button></div></div>

    <!-- PROJECTS -->
    <div class="card"><div class="card-title">ğŸ“‹ Projekte (<span id="projCountDisp">0</span>)</div><div class="form-row" style="margin-bottom:12px"><input type="text" class="form-input" id="projSearch" placeholder="ğŸ” Filtern..."><div><button class="btn btn-success btn-sm" id="addProjBtn">+ Neu</button></div></div><div class="proj-count" id="projFilterCount"></div><div class="proj-scroll" id="projList"></div></div>

    <!-- PROJECT IMPORT/EXPORT -->
    <div class="card"><div class="card-title">ğŸ“¥ Projekte Import/Export</div><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-secondary btn-sm" id="loadSPProj">ğŸ“¡ SP laden</button><label class="btn btn-secondary btn-sm" style="cursor:pointer">ğŸ“ JSON<input type="file" accept=".json" id="importProjFile" style="display:none"></label><button class="btn btn-secondary btn-sm" id="exportProjBtn">ğŸ“¤ JSON</button></div></div>

    <!-- NOTIFICATIONS -->
    <div class="card"><div class="card-title">ğŸ”” Push-Benachrichtigungen</div><div class="sp-info"><strong>Status:</strong> <span id="notifStatus">...</span></div><div style="display:flex;gap:8px;margin-bottom:16px"><button class="btn btn-primary btn-sm" id="notifEnableBtn">ğŸ”” Aktivieren</button><button class="btn btn-secondary btn-sm" id="notifTestBtn">ğŸ§ª Test</button></div>
      <div class="form-group"><label class="form-label">â° Morgen</label><div class="form-row"><input type="time" class="form-input" id="notifMorning" value="06:55"><select class="form-select" id="notifMorningOn"><option value="1">An</option><option value="0">Aus</option></select></div></div>
      <div class="form-group"><label class="form-label">ğŸ½ Mittag</label><div class="form-row"><input type="time" class="form-input" id="notifLunch" value="12:00"><select class="form-select" id="notifLunchOn"><option value="1">An</option><option value="0">Aus</option></select></div></div>
      <div class="form-group"><label class="form-label">ğŸ  Feierabend Moâ€“Do</label><div class="form-row"><input type="time" class="form-input" id="notifEveningMoDo" value="16:45"><select class="form-select" id="notifEveningOn"><option value="1">An</option><option value="0">Aus</option></select></div></div>
      <div class="form-group"><label class="form-label">ğŸŒŸ Freitag</label><div class="form-row"><input type="time" class="form-input" id="notifEveningFr" value="13:45"><select class="form-select" id="notifFridayOn"><option value="1">An</option><option value="0">Aus</option></select></div></div>
      <div class="form-group"><label class="form-label">âš ï¸ Ãœberlauf (h)</label><div class="form-row"><input type="number" class="form-input" id="notifOverflow" value="10" min="6" max="14"><select class="form-select" id="notifOverflowOn"><option value="1">An</option><option value="0">Aus</option></select></div></div>
      <button class="btn btn-primary btn-block btn-sm" id="notifSaveBtn">ğŸ’¾ Speichern</button>
    </div>
  </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="pauseModal"><div class="modal"><div class="modal-title">â± Arbeitszeit bestÃ¤tigen</div><div id="pauseBody"></div><div class="modal-actions"><button class="btn btn-secondary" id="pauseCancel">Korrigieren</button><button class="btn btn-primary" id="pauseConfirm">âœ“ Speichern</button></div></div></div>
<div class="modal-overlay" id="editModal"><div class="modal"><div class="modal-title">âœï¸ Eintrag bearbeiten</div><div id="editBody"></div><div class="modal-actions"><button class="btn btn-danger btn-sm" id="editDelete">ğŸ—‘ LÃ¶schen</button><button class="btn btn-secondary" id="editCancel">Abbrechen</button><button class="btn btn-primary" id="editSave">Speichern</button></div></div></div>
<div class="modal-overlay" id="recoveryModal"><div class="modal"><div class="modal-title">ğŸ”„ Timer wiederherstellen?</div><div id="recoveryBody"></div><div class="modal-actions"><button class="btn btn-secondary" id="recoveryDiscard">Verwerfen</button><button class="btn btn-primary" id="recoveryRestore">Wiederherstellen</button></div></div></div>
<div class="modal-overlay" id="addProjModal"><div class="modal"><div class="modal-title">â• Neues Projekt</div><div class="form-group"><label class="form-label">Nr.</label><input type="text" class="form-input" id="newProjId"></div><div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="newProjName"></div><div class="modal-actions"><button class="btn btn-secondary" id="addProjCancel">Abbrechen</button><button class="btn btn-primary" id="addProjSave">HinzufÃ¼gen</button></div></div></div>
<div class="modal-overlay" id="splitModal"><div class="modal" style="max-width:600px"><div class="modal-title">âœ‚ï¸ Zeit aufteilen</div><div id="splitBody"></div><div class="modal-actions"><button class="btn btn-secondary" onclick="$('splitModal').classList.remove('show')">Abbrechen</button><button class="btn btn-primary" onclick="saveSplitEntries()">âœ“ Alle speichern</button></div></div></div>
<div class="modal-overlay" id="empEditModal"><div class="modal"><div class="modal-title">âœï¸ <span id="empEditTitle"></span></div>
  <div class="form-group"><label class="form-label">Jahr</label><input type="number" class="form-input" id="empYear" value="2026" min="2024" max="2030"></div>
  <div class="form-row"><div class="form-group"><label class="form-label">Pensum %</label><input type="number" class="form-input" id="empPensum" value="100" min="10" max="100" step="5" oninput="calcEmpPreview()"></div><div class="form-group"><label class="form-label">Soll-h/Woche</label><input type="number" class="form-input" id="empWeekH" value="41" min="4" max="50" step="0.5" oninput="calcEmpPreview()"></div></div>
  <div class="form-group"><label class="form-label">Ferientage/Jahr (bei 100%)</label><input type="number" class="form-input" id="empFerien" value="23" min="10" max="40" oninput="calcEmpPreview()"></div>
  <div class="form-group"><label class="form-label">Arbeitstage</label><div style="display:flex;gap:8px;flex-wrap:wrap"><label class="day-check"><input type="checkbox" id="empTag1" checked onchange="calcEmpPreview()">Mo</label><label class="day-check"><input type="checkbox" id="empTag2" checked onchange="calcEmpPreview()">Di</label><label class="day-check"><input type="checkbox" id="empTag3" checked onchange="calcEmpPreview()">Mi</label><label class="day-check"><input type="checkbox" id="empTag4" checked onchange="calcEmpPreview()">Do</label><label class="day-check"><input type="checkbox" id="empTag5" checked onchange="calcEmpPreview()">Fr</label></div></div>
  <div style="margin:16px 0;border-top:1px solid var(--border);padding-top:16px"><div style="font-weight:600;font-size:.85rem;margin-bottom:12px">ğŸš¬ Raucherpause</div>
    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:.85rem"><input type="checkbox" id="empRaucher" onchange="calcEmpPreview()"> Raucher (âˆ’15 Min/Tag automatisch abziehen)</label>
  </div>
  <div style="margin:16px 0;border-top:1px solid var(--border);padding-top:16px"><div style="font-weight:600;font-size:.85rem;margin-bottom:12px">â± TemporÃ¤re Pensum-Anpassung</div>
    <p style="font-size:.78rem;color:var(--text-dim);margin-bottom:10px">z.B. bei Unfall, Wiedereingliederung oder Teilzeit auf Zeit</p>
    <div id="empTempPensumList"></div>
    <button class="btn btn-secondary btn-sm" onclick="addTempPensum()" style="margin-top:8px">+ Zeitraum hinzufÃ¼gen</button>
  </div>
  <div style="margin:16px 0;border-top:1px solid var(--border);padding-top:16px"><div style="font-weight:600;font-size:.85rem;margin-bottom:12px">ğŸ“… Vorjahres-Guthaben</div>
    <div class="form-row"><div class="form-group"><label class="form-label">FerienÃ¼bertrag (Tage)</label><input type="number" class="form-input" id="empFerienUe" value="0" min="-10" max="30" step="0.5"></div><div class="form-group"><label class="form-label">Ãœberstunden (h)</label><input type="number" class="form-input" id="empUeStd" value="0" min="-50" max="200" step="0.5"></div></div>
  </div>
  <div id="empPreview"></div>
  <div class="modal-actions"><button class="btn btn-secondary" onclick="$('empEditModal').classList.remove('show')">Abbrechen</button><button class="btn btn-primary" onclick="saveEmpEdit()">ğŸ’¾ Speichern</button></div>
</div></div>
<div class="toast-container" id="toasts"></div>

<script>
const PROJECTS_DATA=[
{id:"210",name:"Loogartenstrasse 50, 8048 ZÃ¼rich - EingangstÃ¼re",aktiv:true},
{id:"209",name:"Lohnarbeiten",aktiv:true},
{id:"208",name:"In der Luberzen 19, 8902 Urdorf",aktiv:true},
{id:"207",name:"Wehntalerstrasse 45-49, 8057 ZÃ¼rich - ENB",aktiv:true},
{id:"206",name:"Drusbergstrasse 96-102, 8053 ZÃ¼rich-Witikon, WÃœB - BKP 221.6",aktiv:true},
{id:"205",name:"Zentralstrasse 19, 8953 Dietikon - ZKB Dietikon",aktiv:true},
{id:"204",name:"Greifengasse 36+38, 4058 Basel - Clara-Shopping Basel",aktiv:true},
{id:"203",name:"Tannenrauchstrasse 35, 8038 ZÃ¼rich-Wollishofen - Studentenwohnheim",aktiv:true},
{id:"202",name:"ZKB Thalwil - Schneebeli",aktiv:true},
{id:"201",name:"Grabenstrasse 1, 8952 Schlieren - EingangstÃ¼r Varitech",aktiv:true},
{id:"200",name:"Ifangstrasse 8, Schlieren - ErsatzeingangstÃ¼r Bowling West",aktiv:true},
{id:"199",name:"Anbau Einstellhalle LKW, Wilstrasse 55, 5610 Wohlen",aktiv:true},
{id:"198",name:"Ãœberbauung \"Zentrum 104\", ZÃ¼rcherstrasse 104/106, 5432 Neuenhof",aktiv:true},
{id:"197",name:"Sporthalle Langacker, Herrliberg",aktiv:true},
{id:"196",name:"Langensteinenstrasse 32, 8057 ZÃ¼rich - 21/036",aktiv:true},
{id:"195",name:"BÃ¶llistrasse / FÃ¶hrenweg, 5702 Niederlenz - 3459-23 BÃ¶lli SÃ¼d",aktiv:true},
{id:"194",name:"Winterthurerstrasse 625, 8051 Schwamendingen - Neubau MFH",aktiv:true},
{id:"193",name:"ENB LÃ¤gernstrasse, 8953 Dietikon - BF 1-3",aktiv:true},
{id:"192",name:"ZÃ¼rcherstrasse - Lohnfertigung",aktiv:true},
{id:"191",name:"Talstrasse 61, 8001 ZÃ¼rich",aktiv:true},
{id:"190",name:"Sanierung LÃ¶wenzentrum Wohn- und GeschÃ¤ftsliegenschaft LÃ¶wenstrasse 28 / Zentralstrasse 17, 8953 Dietikon",aktiv:true},
{id:"189",name:"Neubau Parking und Energiezentrale, SSH TP5-6",aktiv:true},
{id:"188",name:"Klybeckstrasse 206, 4057 Basel - BKP 221.6",aktiv:true},
{id:"187",name:"Ãœberbauung Erlenpark, KTN 95, 8752 NÃ¤fels, BKP 221.6",aktiv:true},
{id:"186",name:"Erweiterung Siedlung Brunnenhof - Hofwiesenstrasse 126, 8057 ZÃ¼rich",aktiv:true},
{id:"185",name:"Sanierung Schwimmbad Fohrbach, Gemeinde Zollikon",aktiv:true},
{id:"184",name:"DÃ¼bendorf, LFZ FranzÃ¶sische Schule - BKP 272",aktiv:true},
{id:"183",name:"Poststrasse 135-159, 8957 Spreitenbach - MFH",aktiv:true},
{id:"182",name:"PEP Umbau Zentrum St. Peter & Paul",aktiv:true},
{id:"181",name:"Neubau Badenerstrasse Franz AG",aktiv:true},
{id:"180",name:"Rebhaldensteig 19, 8700 KÃ¼snacht - Abbruch und Neubau EFH",aktiv:true},
{id:"179",name:"Nordstrasse 171, 8037 ZÃ¼rich - MFH WiNo",aktiv:true},
{id:"178",name:"SchÃ¤chenstrasse 4, 8048 ZÃ¼rich - EingangstÃ¼r Neubau MFH",aktiv:true},
{id:"177",name:"Quellenhof, Albisstr. 8-10 / Renggerstr. 57, 8038 ZÃ¼rich",aktiv:true},
{id:"176",name:"DS Concepts Schweiz GmbH",aktiv:true},
{id:"175",name:"Allmendstrasse 24, 8914 Aeugst am Albis - Umbau Bauernhaus und Neubauten",aktiv:true},
{id:"174",name:"ZÃ¼richstrasse 12a, 8610 Uster - RÃ¼ckbau alte Niederlassung - Migros Bank AG",aktiv:true},
{id:"173",name:"BrÃ¼elmatt, 8903 Birmensdorf - NB 3-fach Schulsporthalle",aktiv:true},
{id:"172",name:"Grundstrasse 1, 8154 Oberglatt, MFH",aktiv:true},
{id:"171",name:"Windschutzverglasung - quendoz-glas",aktiv:true},
{id:"170",name:"Heimentalstrasse 48, 5430 Wettingen",aktiv:true},
{id:"169",name:"Spitalstrasse 76+78, 8952 Schlieren",aktiv:true},
{id:"168",name:"Neubau Spalenring 56, 58, 60, 62, 4055 Basel",aktiv:true},
{id:"167",name:"Brunaustrasse 164, 8951 Fahrweid",aktiv:true},
{id:"166",name:"Seebahnstrasse 141, 8003 ZÃ¼rich - MFH",aktiv:true},
{id:"165",name:"Teilumnutzung Nordtrakt ZÃ¼rich HB",aktiv:true},
{id:"164",name:"Bleicherstrasse 24/26/28, 8953 Dietikon",aktiv:true},
{id:"163",name:"Haldenbachstrasse 24, 8006 ZÃ¼rich - BKP 272.2 allg Metallbauarbeiten",aktiv:true},
{id:"162",name:"Schulhaus Mettlen, 8241 Uitikon - Ã¤ussere Bekleidung Metall",aktiv:true},
{id:"161",name:"Hotel Leoneck ZÃ¼rich - Leonhardstrasse 1, 8001 ZÃ¼rich",aktiv:true},
{id:"160",name:"Hans Schweri - BrÃ¼elstrasse 11, 5425 Schneisingen",aktiv:true},
{id:"159",name:"Schulhaus Mettlen, 8241 Uitikon - allg. Metallbauarbeiten",aktiv:true},
{id:"158",name:"Schule Spinnergut, Nidelbadstrasse 49, 8802 Kilchberg",aktiv:true},
{id:"157",name:"Limmatstrasse 285, 8005 ZÃ¼rich, MetalltÃ¼ren",aktiv:true},
{id:"156",name:"Stelzenackerstrasse 2-4, 8953 Dietikon",aktiv:true},
{id:"155",name:"SchÃ¼tzenstrasse 31+33, 8953 Dietikon",aktiv:true},
{id:"154",name:"ZÃ¼richstrasse 12a, 8610 Uster, Migros Bank AG",aktiv:true},
{id:"153",name:"Spital Limmattal - UK SchiebetÃ¼r",aktiv:true},
{id:"152",name:"Dorfstrasse 14, 6417 Sattel - Dorfzentrum Vista Sattel",aktiv:true},
{id:"151",name:"Bahnhof Baden - SBB Kundentoilette",aktiv:true},
{id:"150",name:"Risigrundstrasse 14a, 8903 Birmensdorf",aktiv:true},
{id:"149",name:"Bahnhofstrasse 46, 8001 ZÃ¼rich - Schaufenster",aktiv:true},
{id:"148",name:"Neudorfstrasse 11 - 17, 8050 ZÃ¼rich - Oerlikon - GS Neudorf",aktiv:true},
{id:"147",name:"Menzingen - BKP 221.6",aktiv:true},
{id:"146",name:"Belsitostrasse 15, 8044 ZÃ¼rich",aktiv:true},
{id:"145",name:"In der Halden 20, 8902 Urdorf",aktiv:true},
{id:"144",name:"Bahnhofstrasse 2, 4144 Arlesheim - \"Bayer PK, MFH Arlesheim\"",aktiv:true},
{id:"143",name:"Obrechtstrasse 20, 4132 Muttenz - DEFH",aktiv:true},
{id:"142",name:"Wiesenstrasse 31, 5734 Reinach",aktiv:true},
{id:"141",name:"Neubau MFH Burghof, 6110 Wolhusen, Parzelle 53, Stampfel- und Menznauerstrasse",aktiv:true},
{id:"140",name:"Industriestrasse, 4665 Oftringen - Erweiterung IndustriegebÃ¤ude",aktiv:true},
{id:"139",name:"Sonnerbergstrasse, 5734 Reinach AG - WÃœB \"Sonne\"",aktiv:true},
{id:"138",name:"Werkhofstrasse 7, 8902 Urdorf - Umbau/Optimierung Materialdienst",aktiv:true},
{id:"137",name:"Kemptpark 12, 8310 Kemptthal - Sandbox Spaces",aktiv:true},
{id:"136",name:"GÃ¼terstrasse 23, 5014 Gretzenbach - SchÃ¼tz AG",aktiv:true},
{id:"135",name:"In der RÃ¼ti, 8967 Widen / 8965 Berikon - Neubau WÃœ Bachpark",aktiv:true},
{id:"133",name:"RÃ¼tistrasse 28, 30, 32, 8702 Zollikon - MFH Ersatz HaustÃ¼rfront",aktiv:true},
{id:"132",name:"Guggerstrasse 26, 8702 Zollikon - Ersatz HausfronttÃ¼r",aktiv:true},
{id:"131",name:"Sonnenbergstrasse 11, 8134 Adliswil - Neubau REFH",aktiv:true},
{id:"130",name:"Kreuzhaldenstrasse 11, 8192 Glattfelden - Neubau MFH",aktiv:true},
{id:"129",name:"Kirchweg 49, 8102 Oberengstringen - Ersatz MetalltÃ¼re Fahrradraum",aktiv:true},
{id:"128",name:"Solothurnerstrasse, 3294 BÃ¼ren a. A. - Coop",aktiv:true},
{id:"127",name:"EFH BÃ¶hi, 8585 Langrickenbach",aktiv:true},
{id:"126",name:"Stationsstrasse 11b, 8952 Schlieren - Absturzsicherung & GelÃ¤nder",aktiv:true},
{id:"125",name:"Gheidstrasse 137, 8105 Watt -",aktiv:true},
{id:"124",name:"Weissenbrunnenstrasse 29+31, 8903 Birmensdorf - GelÃ¤nder",aktiv:true},
{id:"123",name:"HÃ¤nggÃ¤ssli 3, 8703 Erlenbach - 454 EFH Trinity",aktiv:true},
{id:"122",name:"ParkLife 4124 SchÃ¶nenbuch - MFH + REFH",aktiv:true},
{id:"121",name:"Burkertsmatt 11, 8967 Widen - Sportzentrum Widen",aktiv:true},
{id:"120",name:"Allmendstrasse 1, 8180 BÃ¼lach - Alterszentrum Grampen 2",aktiv:true},
{id:"119",name:"DRAWAG - Webereistrasse 45, 8134 Adliswil - Fenster",aktiv:true},
{id:"118",name:"St. Josefenstr. 20, 9000 St Gallen",aktiv:true},
{id:"117",name:"SchÃ¶nbÃ¼hlstrasse 5a, 5442 Fislisbach - Fassade Doktorhaus",aktiv:true},
{id:"116",name:"Rebbergstrasse 3,  8157 Dielsdorf - Ersatzneubau MFH Rain",aktiv:true},
{id:"115",name:"Kurlistrasse15, 8404 Winterthur - Ersatzneubau MFH Kurli",aktiv:true},
{id:"113",name:"Rue du Faubourg 18, La Neuveville - Umbau / Sanierung",aktiv:true},
{id:"112",name:"Weihermattstrasse 47, 8902 Urdorf - RenÃ© Leiser",aktiv:true},
{id:"111",name:"Unterdorfstrasse 21, 8114 DÃ¤nikon - Brandschutzfenster 19320 KlÃ¤rwerk",aktiv:true},
{id:"110",name:"ENB Brunnenrain, 8038 ZÃ¼rich - BKP 221.6",aktiv:true},
{id:"109",name:"Trottenstrasse 2, 8037 ZÃ¼rich - TRO Gesamtinstandsetzung MFH - AussentÃ¼ren",aktiv:true},
{id:"108",name:"Im Struppen 11, 8048 ZÃ¼rich - Micoma AG - Ganzglasanlage",aktiv:true},
{id:"107",name:"Dolderstrasse 15, 8032 ZÃ¼rich - Schaufensterfront",aktiv:true},
{id:"106",name:"BrÃ¼ckenstrasse 73, 3005 Bern - Campus BFH Bern - BÃ¼hnentechnik",aktiv:true},
{id:"105",name:"Roosmatten 4, 8967 Widen - Ãœberdachung",aktiv:true},
{id:"104",name:"RÃ¼tifeldstrasse 1, 3380 Wangen a. d. A. - TGW - Erweiterung Logistikzenter Neubau",aktiv:true},
{id:"103",name:"ZÃ¼rich HB - Brandschutzfassade",aktiv:true},
{id:"102",name:"MÃ¶Ã¶slimatten 10, 6218 Ettiswil - Fenster und TÃ¼r IBOR AG",aktiv:true},
{id:"101",name:"Augenweidstrasse, 8966 Oberwil-Lieli - EingangstÃ¼ren Alu",aktiv:true},
{id:"100",name:"Kirchgasse 6, 8902 Urdorf - GelÃ¤nder/Tor Friedhof",aktiv:true},
{id:"99",name:"Steinstrasse, 8003 ZÃ¼rich - TÃ¼relement",aktiv:true},
{id:"98",name:"Beethovenstrasse 21, 8002 ZÃ¼rich - PHZ - Park Hyatt - Zurich Refurbishment - Sunblinds Projekt",aktiv:true},
{id:"97",name:"ZÃ¼rich HB, Nordtrakt - Teilumnutzung - BKP 272.0",aktiv:true},
{id:"96",name:"Dorfstrasse 5, 4423 Hersberg - Neubau MFH",aktiv:true},
{id:"95",name:"PÃ¼ntstrasse, 8132 Egg - Ersatzneubau - AussentÃ¼ren aus Metall",aktiv:true},
{id:"94",name:"SchÃ¼rstrasse 58, 6020 Emmen - ALC-O Aussenstelle Emmen - AussentÃ¼ren aus Metall",aktiv:true},
{id:"93",name:"Langholzstrasse 10-14, 8618 Oetwil am See - Neubau Siedlung \"Hohwies\"",aktiv:true},
{id:"92",name:"Provisorien Hinterbirch, 8180 BÃ¼lach",aktiv:true},
{id:"91",name:"Zepra, 4133 Pratteln",aktiv:true},
{id:"90",name:"ZÃ¼richstrasse 133/135, 8910 Affoltern a. A. - Reparatur Ladenservice",aktiv:true},
{id:"89",name:"Im Stockenhof, 8105 Regensdorf - HaupteingangstÃ¼r",aktiv:true},
{id:"88",name:"Gruebstrasse 95, 8706 Meilen - Tiefgaragendecke",aktiv:true},
{id:"86",name:"Gemeinde Hitzkirch 6284 - Schulraumprovisorium",aktiv:true},
{id:"85",name:"Limmatstrasse 4, 8957 Spreitenbach - Sanierung WC Experience Center",aktiv:true},
{id:"84",name:"Villigen PSI LaborgebÃ¤ude - Express TÃ¼ren",aktiv:true},
{id:"83",name:"Pavillonschule Stelzenacher - 8953 Dietikon",aktiv:true},
{id:"82",name:"BP23 ZHUS Migros Bank - Umbau Alternativstandort NL - Bankstrasse 11, 8610 Uster",aktiv:true},
{id:"80",name:"NÃ¶schikonerstrasse 3, 8172 Niederglatt - Kirchenzentrum Eichi - Baukommission Sanierung - Reparatur und Wartung TÃ¼ren",aktiv:true},
{id:"79",name:"MFH BirchdÃ¶rfli 50, Oerlikon",aktiv:true},
{id:"78",name:"BelvÃ©dÃ¨restrasse / Pilatusweg, parz. Nr. 203, 5621 Zufikon - Neubau WohnÃ¼berbauung Collina",aktiv:true},
{id:"77",name:"Dachlissen 40, 8932 Mettmenstetten - Metallbauarbeiten",aktiv:true},
{id:"76",name:"Coop City St. Annahof, Bahnhofstrasse 57, 8001 ZÃ¼rich - StÃ¼tzenverkleidungen",aktiv:true},
{id:"75",name:"en Sauvy Schule - Aussen- & BrandschutztÃ¼ren",aktiv:true},
{id:"74",name:"W+P 351 - Thiersteinerallee 12, 4053 Basel - Transgourmet - Fassadenausbau",aktiv:true},
{id:"72",name:"Ifangstrasse 6 + 8, 8952 Schlieren - Revisionsarbeit",aktiv:true},
{id:"71",name:"SoZo, 8707 Uetikon a S,  Scheug Areal - Neubau",aktiv:true},
{id:"70",name:"Feldstrasse 19, 8942 Oberrieden - 221.8 Spezielle lichtdurchlÃ¤ssige Bauteile (Ã¤ussere)",aktiv:true},
{id:"69",name:"Teuschenstrasse 6, 8500 Gerlikon - Reparatur FenstertÃ¼re",aktiv:true},
{id:"68",name:"Margarethenstrasse 87, 4102 Binningen - Reparatur GlasgelÃ¤nder",aktiv:true},
{id:"67",name:"Poststrasse 42, 8957 Spreitenbach - StahlstÃ¼tzen",aktiv:true},
{id:"66",name:"Blaurockstrasse, 8260 Stein am Rhein - AussentÃ¼re aus Metall",aktiv:true},
{id:"65",name:"MFH Glattfelden, Ladex AG",aktiv:true},
{id:"64",name:"Bachema AG - Ifangstrasse, 8952 Schlieren - Konsole - Anzeigepanel",aktiv:true},
{id:"63",name:"Limmattalstrasse 110, 8049 ZÃ¼rich - HMSU Haus Meili - Sanierung und Umbau Dachgeschoss",aktiv:true},
{id:"58",name:"Seestrasse 6, 8266 Steckborn - Metallbauarbeiten Bootshaus",aktiv:true},
{id:"57",name:"Virgin Lenzburg - Alu-TÃ¼ren",aktiv:true},
{id:"56",name:"Seebachstrasse 3, ZH-Seebach, 272.21 - 303 Devisierung - GelÃ¤nder",aktiv:true},
{id:"55",name:"Seebachstrasse 3, ZH-Seebach, 221.61 - 303 Devisierung",aktiv:true},
{id:"54",name:"AuftrÃ¤ge Leiser Storenbau AG",aktiv:true},
{id:"53",name:"Rebhaldenstrasse 22a, 8303 Bassersdorf - Reparatur",aktiv:true},
{id:"52",name:"Garage Hangg Wohlen - Fassadenanpassung",aktiv:true},
{id:"51",name:"Steinackerstrasse 39, 8902 Urdorf - MTU 5",aktiv:true},
{id:"50",name:"Schaffhauserstrasse 418, 8050 ZÃ¼rich",aktiv:true},
{id:"49",name:"VC11940_Stadt ZH Entsorgung & Recycling",aktiv:true},
{id:"48",name:"In der Au, 8706 Meilen - Nachtragsarbeiten",aktiv:true},
{id:"47",name:"Marti Containerdorf, PLZ - Biel - Laubengang",aktiv:true},
{id:"46",name:"Frischmarkt ZÃ¼rich, Geiser AG",aktiv:true},
{id:"45",name:"Badenerstrasse 50 | Stauffacherstrasse 33a | 33b, 8004 ZÃ¼rich - Tchibo",aktiv:true},
{id:"44",name:"HÃ¶henweg 11, 8832 Wollerau - Glas wechseln und EntwÃ¤sserung",aktiv:true},
{id:"43",name:"RÃ¼tihofstrasse 1, 8049 ZÃ¼rich - Sanierung GebÃ¤udehÃ¼lle HÃ¤user 2-12 und 14-24",aktiv:true},
{id:"42",name:"10217, Hofacherstrasse 12, 5443 Niederrohrdorf - Reparatur HauseingangstÃ¼r",aktiv:true},
{id:"40",name:"Kaserne Reppischtal, 8903 Birmensdorf - BlechestorenfÃ¼hrung",aktiv:true},
{id:"39",name:"Obere Sterngasse 1, 4500 Solothurn - TÃ¼ren, Festverglasung",aktiv:true},
{id:"38",name:"MÃ¼hlemattstrasse 15b, 8903 Birmensdorf - Hauseingang",aktiv:true},
{id:"37",name:"Frauchwilerstrasse 2a, 3257 Grossaffoltern - Faltwand",aktiv:true},
{id:"36",name:"Industriestrasse 37A, 8304 Wallisellen - Mahof - Pergola & RWA",aktiv:true},
{id:"35",name:"Lilien Zentrum, 8952 Schlieren - Stahlbauarbeiten",aktiv:true},
{id:"34",name:"Neusatzweg 46, 4106 Therwil - Allg. Metallbauarbeiten",aktiv:true},
{id:"33",name:"Weihermattstrasse 89, 8902 Urdorf - BegrÃ¼nung Fassade",aktiv:true},
{id:"32",name:"MFH Neuwiesen, 8706 Meilen, WohnÃ¼berbauung",aktiv:true},
{id:"31",name:"WÃ¼rzgrabenstrasse 5, 8048 ZÃ¼rich, TÃ¼re richten",aktiv:true},
{id:"30",name:"HerrenrÃ¼tistrasse 8, 9050 Appenzell - Fenster und TÃ¼ren",aktiv:true},
{id:"28",name:"Amerbachstrasse 57, 4057 Basel - Treppenaufgang",aktiv:true},
{id:"27",name:"Route des Jeunes 1, 1227 Les Acacias - TÃ¼ren",aktiv:true},
{id:"26",name:"Route des Jeunes 1, 1227 Les Acacias - Fenster",aktiv:true},
{id:"25",name:"Freiestrasse 206, 8032 ZÃ¼rich - Fassade",aktiv:true},
{id:"24",name:"Panoramastrasse 22, 8903 Brimensdorf - Verglasungen",aktiv:true},
{id:"23",name:"BÃ¼roumbau",aktiv:true},
{id:"22",name:"Alpenstrasse 23, 8136 Thalwil - Pergola",aktiv:true},
{id:"21",name:"Rietbachstrasse 11, 8952 Schlieren - TÃ¼rrep.",aktiv:true},
{id:"20",name:"Hubring 55, 8303 Bassersdorf - Allg. Metallbauarbeiten",aktiv:true},
{id:"19",name:"Bienenweg 23, 4106 Therwil - Abdeckung Storen",aktiv:true},
{id:"18",name:"RiedmÃ¼hle 57, 8306 Wangen-BrÃ¼ttisellen - MÃ¤ngelbehebung",aktiv:true},
{id:"17",name:"Stockenhof  10+14,  8105 Regensdorf - TÃ¼rrep.",aktiv:true},
{id:"16",name:"Bankstrasse 11, 8606 Uster - Fenster TÃ¼ren",aktiv:true},
{id:"15",name:"Maschine Emmegi Satellite XL",aktiv:true},
{id:"14",name:"Zertifizierung EN 16034",aktiv:true},
{id:"13",name:"Steinackerstrasse 20, 8902 Urdorf - TÃ¼re defektes Blech",aktiv:true},
{id:"12",name:"Mutschellenstrasse 22, 8964 Rudolfstetten-Friedlisberg - GelÃ¤ndererhÃ¶hung",aktiv:true},
{id:"11",name:"Grossmattstrasse 9, 8902 Urdorf -Div. Arbeiten",aktiv:true},
{id:"8",name:"Ifangstrasse 8, 8952 Schlieren - Magnetkontakte",aktiv:true},
{id:"7",name:"Test Projekt Leonie",aktiv:true},
{id:"6",name:"Spitalstrasse 76/1.OG, 8902 Urdorf",aktiv:true},
{id:"5",name:"KAPO Urdorf",aktiv:true},
{id:"4",name:"Pavillion Kindergarten, 8953 Dietikon",aktiv:true},
{id:"3",name:"Faltwand und Festverglasung",aktiv:true},
{id:"2",name:"Durchbruch Coop",aktiv:true},
{id:"1",name:"Ferrum",aktiv:true}
];

// HUBLER METALLBAU ZEITERFASSUNG - Complete App JS
// SharePoint Integration + 197 Bexio Projects + Push Notifications

const C={CLIENT_ID:'19ae5266-ce31-4758-80e5-9cb87be67dfa',TENANT_ID:'bf52de6b-9185-46fb-998d-989d583b27a2',REDIRECT:'https://zeiterfassung-hubler.netlify.app/',SP_PATH:'/Shared Documents/Zeiterfassung',LS:'hm_zt_'};
const DEFAULT_EMPLOYEES=[{id:'HM-001',name:'Roman Koller',email:'roman.koller@hublermetallbau.ch',admin:false,approver:true},{id:'HM-002',name:'Dominic Schnorf',email:'dominic.schnorf@hublermetallbau.ch',admin:true,approver:true},{id:'HM-003',name:'Ursin Meienberg',email:'ursin.meienberg@hublermetallbau.ch',admin:false},{id:'HM-007',name:'Leonie Egloff',email:'leonie.egloff@hublermetallbau.ch',admin:false},{id:'HM-004',name:'Muhamed Cerkezi',email:null,admin:false},{id:'HM-005',name:'Aky Storz',email:null,admin:false},{id:'HM-006',name:'David Durica',email:null,admin:false},{id:'HM-008',name:'Fabienne Schneider',email:null,admin:false}];
function loadEmployees(){try{const d=JSON.parse(localStorage.getItem(C.LS+'employees'));if(d&&d.length)return d}catch{}return DEFAULT_EMPLOYEES.map(e=>({...e}))}
function saveEmployees(list){localStorage.setItem(C.LS+'employees',JSON.stringify(list));if(accessToken)SP.writeFile('employees.json',{employees:list}).then(()=>console.log('[SP] employees gespeichert')).catch(e=>console.warn('[SP] employees Fehler:',e))}
let EMPLOYEES=loadEmployees();
function getActiveEmployees(){return EMPLOYEES.filter(e=>!e.archived)}
// Migrate old dual-absences to single source
(function(){
  const oldLocal=localStorage.getItem(C.LS+'absences');
  const oldGlobal=localStorage.getItem(C.LS+'global_absences');
  const newKey=C.LS+'all_absences';
  if(!localStorage.getItem(newKey)){
    let merged=[];
    try{if(oldGlobal)merged=JSON.parse(oldGlobal)}catch{}
    try{if(oldLocal){const loc=JSON.parse(oldLocal);const ids=new Set(merged.map(a=>a.id));loc.forEach(a=>{if(!ids.has(a.id))merged.push(a)})}}catch{}
    if(merged.length){localStorage.setItem(newKey,JSON.stringify(merged));console.log('[Migration] Abwesenheiten migriert:',merged.length)}
  }
})();

const KS_COLORS={"BÃ¼ro":'#3b82f6',Zuschnitt:'#8b5cf6',BAZ:'#06b6d4',Werkstatt:'#22c55e',Montage:'#FF6B35'};
const DAYS_S=['So','Mo','Di','Mi','Do','Fr','Sa'],DAYS_L=['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'],MO=['Januar','Februar','M\u00e4rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
let user=null,accessToken=null,projects=[...PROJECTS_DATA];
let timer={on:false,paused:false,start:null,pauseAt:null,totalPaused:0,project:'',ks:'',note:'',segments:[]};
let timerIv=null,calOff=0,editId=null,pendingEntry=null;
const $=s=>document.getElementById(s);const lk=k=>C.LS+(user?user.id+'_':'')+k;
const getEntries=()=>{try{return JSON.parse(localStorage.getItem(lk('entries'))||'[]')}catch{return[]}};
const saveEntries=e=>{localStorage.setItem(lk('entries'),JSON.stringify(e));queueSync()};
function addEntry(e){const a=getEntries();e.id=Date.now().toString(36)+Math.random().toString(36).slice(2,6);e.created=new Date().toISOString();a.push(e);saveEntries(a);toast('Eintrag gespeichert','success');refreshView()}
function updateEntry(id,u){const a=getEntries(),i=a.findIndex(e=>e.id===id);if(i>=0){a[i]={...a[i],...u};saveEntries(a);refreshView();return true}return false}
function removeEntry(id){saveEntries(getEntries().filter(e=>e.id!==id));refreshView()}
function dateKey(d){const x=new Date(d);return x.getFullYear()+'-'+String(x.getMonth()+1).padStart(2,'0')+'-'+String(x.getDate()).padStart(2,'0')}
function todayKey(){return dateKey(new Date())}
function fmtDate(d){const x=new Date(d);return String(x.getDate()).padStart(2,'0')+'.'+String(x.getMonth()+1).padStart(2,'0')+'.'+x.getFullYear()}
function timeToMin(t){const p=t.split(':');return parseInt(p[0])*60+parseInt(p[1])}
function fmtMin(m){if(m<0)m=0;const h=Math.floor(m/60),r=m%60;return h>0?h+'h '+(r>0?r+'min':''):r+'min'}
function fmtH(m){return(m/60).toFixed(1)+'h'}
function projLabel(p){return p.id+' - '+p.name}
function getActiveProjects(){return projects.filter(p=>p.aktiv)}
function getWeekDates(){const t=new Date(),d=t.getDay(),mon=new Date(t);mon.setDate(t.getDate()-(d===0?6:d-1));return Array.from({length:7},(_,i)=>{const x=new Date(mon);x.setDate(mon.getDate()+i);return x})}
function toast(msg,type){const t=document.createElement('div');t.className='toast '+(type||'info');t.textContent=msg;$('toasts').appendChild(t);setTimeout(()=>t.remove(),3000)}
function getHolidays(y){const a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),mo=Math.floor((h+l-7*m+114)/31),da=((h+l-7*m+114)%31)+1,easter=new Date(y,mo-1,da);const ad=(d2,n)=>{const r=new Date(d2);r.setDate(r.getDate()+n);return r},dk=d2=>dateKey(d2);const hol={};hol[dk(new Date(y,0,1))]='Neujahr';hol[dk(new Date(y,0,2))]='Berchtoldstag';hol[dk(ad(easter,-2))]='Karfreitag';hol[dk(ad(easter,1))]='Ostermontag';hol[dk(new Date(y,4,1))]='Tag der Arbeit';hol[dk(ad(easter,39))]='Auffahrt';hol[dk(ad(easter,50))]='Pfingstmontag';hol[dk(new Date(y,7,1))]='Bundesfeier';hol[dk(new Date(y,11,25))]='Weihnachten';hol[dk(new Date(y,11,26))]='Stephanstag';const s1=new Date(y,8,1),fm=new Date(s1);fm.setDate(1+(8-s1.getDay())%7);const ks2=new Date(fm);ks2.setDate(fm.getDate()+7);hol[dk(ks2)]='Knabenschiessen';return hol}

// SHAREPOINT GRAPH API
const SP={
  _driveId:null,
  async getDriveId(){
    if(this._driveId)return this._driveId;
    // Try cached driveId from localStorage first
    const cached=localStorage.getItem(C.LS+'sp_driveId');
    if(cached){
      console.log('[SP] Using cached driveId');
      this._driveId=cached;
      // Verify it still works in background
      this.gf('/drives/'+cached+'/root').then(()=>{console.log('[SP] Cached driveId valid')}).catch(()=>{
        console.warn('[SP] Cached driveId invalid, clearing');
        localStorage.removeItem(C.LS+'sp_driveId');this._driveId=null;
      });
      return this._driveId;
    }
    try{
      console.log('[SP] Suche SharePoint-Site...');
      // Method 1: Search by name
      let site=null;
      try{
        const search=await this.gf('/sites?search=HublerMetallbauDatenablage');
        if(search&&search.value&&search.value.length>0)site=search.value[0];
      }catch(e){console.warn('[SP] Search failed:',e.message)}
      // Method 2: Try direct site access by hostname
      if(!site){
        try{
          site=await this.gf('/sites/hublermetallbau.sharepoint.com:/sites/HublerMetallbauDatenablage');
        }catch(e){console.warn('[SP] Direct site failed:',e.message)}
      }
      // Method 3: Try root site
      if(!site){
        try{
          site=await this.gf('/sites/hublermetallbau.sharepoint.com');
        }catch(e){console.warn('[SP] Root site failed:',e.message)}
      }
      if(site){
        console.log('[SP] Site gefunden:',site.displayName||site.name,'ID:',site.id);
        const drives=await this.gf('/sites/'+site.id+'/drives');
        if(drives&&drives.value){
          const docDrive=drives.value.find(d=>d.name==='Dokumente'||d.name==='Documents'||d.name==='Shared Documents')||drives.value[0];
          this._driveId=docDrive.id;
          localStorage.setItem(C.LS+'sp_driveId',this._driveId);
          console.log('[SP] Drive gefunden:',docDrive.name,'ID:',docDrive.id);
          return this._driveId;
        }
      }
      console.warn('[SP] Site nicht gefunden - SharePoint nicht verf\u00fcgbar');
      setSyncStatus('offline');
      return null;
    }catch(e){console.error('[SP] getDriveId:',e);setSyncStatus('offline');return null}
  },
  async gf(ep,opts){if(!accessToken)return null;const url=ep.startsWith('http')?ep:'https://graph.microsoft.com/v1.0'+ep;const resp=await fetch(url,{method:opts&&opts.method||'GET',headers:{'Authorization':'Bearer '+accessToken,...(opts&&opts.headers||{})},body:opts&&opts.body});if(!resp.ok){if(resp.status===403||resp.status===401){console.warn('[SP] Zugriff verweigert ('+resp.status+') f\u00fcr:',ep);throw new Error('Kein Zugriff ('+resp.status+')')}throw new Error('Graph '+resp.status)}return resp.json()},
  async readFile(path){try{const driveId=await this.getDriveId();if(!driveId)return null;return await this.gf('/drives/'+driveId+'/root:'+C.SP_PATH+'/'+path+':/content')}catch(e){console.warn('SP read:',e);return null}},
  async writeFile(path,content){try{const driveId=await this.getDriveId();if(!driveId)return false;const body=typeof content==='string'?content:JSON.stringify(content,null,2);const resp=await fetch('https://graph.microsoft.com/v1.0/drives/'+driveId+'/root:'+C.SP_PATH+'/'+path+':/content',{method:'PUT',headers:{'Authorization':'Bearer '+accessToken,'Content-Type':'application/json'},body:body});if(!resp.ok)throw new Error('PUT '+resp.status);return true}catch(e){console.warn('SP write:',e);return false}},
  async loadProjects(){const data=await this.readFile('projekte.json');if(data&&data.projekte){projects=data.projekte;localStorage.setItem(C.LS+'projects',JSON.stringify(projects));toast('Projekte von SharePoint geladen','success');renderProjectList();return true}return false},
  async saveProjects(){const ok=await this.writeFile('projekte.json',{lastUpdated:new Date().toISOString().split('T')[0],count:projects.length,projekte:projects});if(ok)toast('projekte.json auf SharePoint','success');return ok},
  async loadEntries(){const fn='Mitarbeiter/'+user.name.replace(/\s/g,'_')+'_'+new Date().getFullYear()+'.json';const data=await this.readFile(fn);if(data&&Array.isArray(data.entries)){const local=getEntries(),ids=new Set(local.map(e=>e.id)),merged=[...local];data.entries.forEach(e=>{if(!ids.has(e.id))merged.push(e)});localStorage.setItem(lk('entries'),JSON.stringify(merged));refreshView();return true}return false},
  async saveEntries(){const fn='Mitarbeiter/'+user.name.replace(/\s/g,'_')+'_'+new Date().getFullYear()+'.json';return await this.writeFile(fn,{employee:user.name,employeeId:user.id,lastUpdated:new Date().toISOString(),year:new Date().getFullYear(),entries:getEntries()})},
  async fullSync(){if(!accessToken){toast('Bitte mit Microsoft anmelden','warning');return}setSyncStatus('syncing');try{console.log('[SP] Full sync...');const driveId=await this.getDriveId();if(!driveId){console.warn('[SP] Kein Drive - nur lokal');setSyncStatus('offline');toast('SharePoint nicht erreichbar - Daten werden lokal gespeichert','warning');return}const p=await this.loadProjects();if(!p)console.log('[SP] Keine projekte.json - lokale Projekte');const e=await this.loadEntries();if(!e)console.log('[SP] Keine Eintr\u00e4ge - erste Nutzung');const s=await this.saveEntries();console.log('[SP] Eintr\u00e4ge gespeichert:',s);setSyncStatus('online');toast('SharePoint verbunden','success');loadNotifSettingsFromSP();loadAbsencesFromSP();loadEmpSettingsFromSP();loadBetriebsferienFromSP();loadEmployeesFromSP();if(user&&(user.admin||user.approver))loadAllEntriesFromSP()}catch(e){console.error('[SP] Sync:',e);setSyncStatus('offline');toast('SharePoint-Sync fehlgeschlagen - Daten bleiben lokal gesichert','warning')}}
};
function setSyncStatus(s){const el=$('syncStatus');if(s==='online'){el.className='sync-status online';el.textContent='SharePoint'}else if(s==='syncing'){el.className='sync-status syncing';el.textContent='Sync...'}else if(s==='offline'){el.className='sync-status offline';el.textContent='Offline'}else{el.className='sync-status';el.textContent='Lokal'}$('spStatusText').textContent=s==='online'?'Verbunden mit SharePoint':s==='syncing'?'Synchronisiere...':'Lokaler Modus (Demo)'}
let syncTm=null;function queueSync(){if(!accessToken)return;clearTimeout(syncTm);syncTm=setTimeout(async()=>{const driveId=SP._driveId||localStorage.getItem(C.LS+'sp_driveId');if(!driveId){return}setSyncStatus('syncing');try{await SP.saveEntries();setSyncStatus('online')}catch(e){console.warn('[Sync]',e.message);setSyncStatus('offline')}},3000)}

// OAUTH
function loginWithMicrosoft(){
const scope=encodeURIComponent('User.Read Files.ReadWrite.All Sites.ReadWrite.All');
const redir=encodeURIComponent(window.location.origin+window.location.pathname);
console.log('[Auth] Redirect:',window.location.origin+window.location.pathname);
// Use 'common' endpoint for multi-tenant + personal accounts
window.location.href='https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id='+C.CLIENT_ID+'&response_type=token&redirect_uri='+redir+'&scope='+scope+'&response_mode=fragment&nonce='+Math.random().toString(36).slice(2)+'&prompt=select_account'}

function handleOAuthCallback(){
const h=window.location.hash;
console.log('[Auth] Hash:',!!h);
if(!h||!h.includes('access_token')){
  if(h&&h.includes('error')){const p=new URLSearchParams(h.slice(1));console.error('[Auth] Error:',p.get('error_description'));toast('Login-Fehler: '+(decodeURIComponent(p.get('error_description')||p.get('error')||'')).split('.')[0],'error')}
  return false;
}
const p=new URLSearchParams(h.slice(1));accessToken=p.get('access_token');
if(!accessToken)return false;
console.log('[Auth] Token erhalten, l\u00e4nge:',accessToken.length);
history.replaceState(null,'',window.location.pathname);
fetch('https://graph.microsoft.com/v1.0/me',{headers:{'Authorization':'Bearer '+accessToken}})
.then(r=>{console.log('[Auth] Graph /me:',r.status);if(!r.ok)throw new Error('Graph '+r.status);return r.json()})
.then(async profile=>{
  console.log('[Auth] Profil:',JSON.stringify({mail:profile.mail,upn:profile.userPrincipalName,name:profile.displayName}));
  const email=(profile.mail||profile.userPrincipalName||'').toLowerCase();
  // Try to load latest employees from SP first
  try{
    const spData=await SP.getDriveId().then(()=>SP.readFile('employees.json'));
    if(spData&&spData.employees&&spData.employees.length){
      EMPLOYEES=spData.employees;
      localStorage.setItem(C.LS+'employees',JSON.stringify(EMPLOYEES));
      console.log('[Auth] MA-Liste von SP geladen:',EMPLOYEES.length);
    }
  }catch(e){console.warn('[Auth] SP employees nicht geladen, nutze lokal:',e.message)}
  // Match by email (supports both company and personal MS accounts)
  let emp=getActiveEmployees().find(e=>e.email&&e.email.toLowerCase()===email);
  // Fallback: match by display name
  if(!emp)emp=getActiveEmployees().find(e=>e.name.toLowerCase()===profile.displayName.toLowerCase());
  // Fallback: partial email match (before @)
  if(!emp){const localPart=email.split('@')[0];emp=getActiveEmployees().find(e=>e.email&&e.email.toLowerCase().split('@')[0]===localPart)}
  if(emp){user={...emp};localStorage.setItem(C.LS+'session',JSON.stringify(user));localStorage.setItem(C.LS+'token',accessToken);console.log('[Auth] Angemeldet als:',emp.name);showApp();SP.fullSync()}
  else{console.warn('[Auth] Email nicht gefunden:',email,'Bekannte:',getActiveEmployees().map(e=>e.email).filter(Boolean).join(', '));toast('Email nicht registriert: '+email+'. Bitte Admin kontaktieren.','error');$('login-screen').style.display='flex'}
}).catch(e=>{console.error('[Auth]:',e);toast('Login fehlgeschlagen: '+e.message,'error');$('login-screen').style.display='flex'});
return true}

// AUTH
function initLogin(){
// PIN-protected demo mode
const demoDiv=$('demoUsers');
if(demoDiv){
  EMPLOYEES.forEach(emp=>{
    const b=document.createElement('button');b.className='demo-user-btn';
    b.innerHTML='<span class="uid">'+emp.id+'</span>'+emp.name+(emp.admin?' \ud83d\udc51':'')+(emp.approver&&!emp.admin?' \u2705':'');
    b.onclick=()=>loginAs(emp);demoDiv.appendChild(b);
  });
}
// PIN input handling
const DEMO_PIN='47635';
function setupPinInputs(){
  for(let i=1;i<=5;i++){
    const inp=$('pin'+i);
    if(!inp)continue;
    inp.addEventListener('input',function(){
      if(this.value.length===1&&i<5)$('pin'+(i+1)).focus();
      checkPin();
    });
    inp.addEventListener('keydown',function(e){
      if(e.key==='Backspace'&&!this.value&&i>1)$('pin'+(i-1)).focus();
    });
  }
}
function checkPin(){
  let pin='';
  for(let i=1;i<=5;i++){const v=$('pin'+i);if(v)pin+=v.value}
  const dv=$('demoUsers');
  if(pin===DEMO_PIN){if(dv)dv.classList.add('show')}
  else{if(dv)dv.classList.remove('show')}
}
setupPinInputs();
$('msLoginBtn').onclick=loginWithMicrosoft;
const urlHash=window.location.hash;
console.log('[Auth] Page loaded. Hash:',urlHash?'yes':'none');
if(urlHash&&urlHash.includes('access_token')){handleOAuthCallback();return}
if(urlHash&&urlHash.includes('error')){const ep=new URLSearchParams(urlHash.slice(1));const errMsg=decodeURIComponent(ep.get('error_description')||ep.get('error')||'');toast('Microsoft Fehler: '+errMsg.split('.')[0],'error');
const dbg=$('authDebug');if(dbg){dbg.style.display='block';dbg.innerHTML='<strong>OAuth Debug:</strong><br>Fehler: '+errMsg+'<br><br>Bitte pr\u00fcfen:<br>1. Azure: Authentication > SPA Platform<br>2. Implicit grant: Access+ID tokens<br>3. Redirect URI: '+window.location.origin+window.location.pathname}}
const st=localStorage.getItem(C.LS+'token');if(st)accessToken=st;
const saved=localStorage.getItem(C.LS+'session');if(saved){try{user=JSON.parse(saved);showApp();if(accessToken)SP.fullSync()}catch{}}
const cp=localStorage.getItem(C.LS+'projects');if(cp)try{projects=JSON.parse(cp)}catch{}}
function loginAs(emp){user={...emp};accessToken=null;localStorage.setItem(C.LS+'session',JSON.stringify(user));showApp()}
function logout(){if(timer.on&&!confirm('Timer l\u00e4uft noch! Wirklich abmelden?'))return;clearInterval(timerIv);timer={on:false,paused:false,start:null,pauseAt:null,totalPaused:0,segments:[]};user=null;accessToken=null;localStorage.removeItem(C.LS+'session');localStorage.removeItem(C.LS+'token');$('app').style.display='none';$('login-screen').style.display='flex';setSyncStatus('local')}
function showApp(){$('login-screen').style.display='none';$('app').style.display='block';$('userAvatar').textContent=user.name.split(' ').map(n=>n[0]).join('');$('userName').textContent=user.name;$('manDate').value=todayKey();if($('absFrom'))$('absFrom').value=todayKey();if($('absTo'))$('absTo').value=todayKey();document.querySelector('[data-tab="admin"]').style.display=user.admin?'':'none';document.querySelector('[data-tab="report"]').style.display=canViewReports()?'':'none';document.querySelector('[data-tab="dashboard"]').style.display=canViewReports()?'':'none';document.querySelector('[data-tab="maedit"]').style.display=user.admin?'':'none';updateTimerDate();refreshView();checkRecovery();calMonth=new Date().getMonth();calYear=new Date().getFullYear();updateMonthCalendar();renderProjectList();setSyncStatus(accessToken?'online':'local');if(user.admin){loadNotifUI();renderEmpSettings();initMAEdit();renderBetriebsferien();renderEmpManagement()}if(canViewReports())renderReportTab();checkNotifications();renderAbsences();initMyNotif()}

// TABS
$('navTabs').addEventListener('click',e=>{const tab=e.target.closest('.nav-tab');if(!tab)return;document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));tab.classList.add('active');$('tab-'+tab.dataset.tab).classList.add('active');refreshView()});
function refreshView(){renderToday();renderWeek();updateMonthCalendar()}

// AUTOCOMPLETE
function setupAC(iid,lid){const inp=$(iid),list=$(lid);let hl=-1;inp.addEventListener('input',()=>{const v=inp.value.toLowerCase().trim();list.innerHTML='';hl=-1;if(!v){list.classList.remove('show');return}const m=getActiveProjects().filter(p=>p.id.includes(v)||p.name.toLowerCase().includes(v)).slice(0,15);if(!m.length){list.classList.remove('show');return}m.forEach(p=>{const d=document.createElement('div');d.className='autocomplete-item';d.innerHTML='<span class="pn">'+p.id+'</span>'+p.name;d.onclick=()=>{inp.value=projLabel(p);list.classList.remove('show')};list.appendChild(d)});list.classList.add('show')});inp.addEventListener('keydown',e=>{const items=list.querySelectorAll('.autocomplete-item');if(!items.length)return;if(e.key==='ArrowDown'){e.preventDefault();hl=Math.min(hl+1,items.length-1);items.forEach((it,i)=>it.classList.toggle('hl',i===hl))}else if(e.key==='ArrowUp'){e.preventDefault();hl=Math.max(hl-1,0);items.forEach((it,i)=>it.classList.toggle('hl',i===hl))}else if(e.key==='Enter'){e.preventDefault();if(hl>=0){const v=inp.value.toLowerCase().trim(),fm=getActiveProjects().filter(p=>p.id.includes(v)||p.name.toLowerCase().includes(v));if(fm[hl])inp.value=projLabel(fm[hl])}list.classList.remove('show')}else if(e.key==='Escape')list.classList.remove('show')});document.addEventListener('click',e=>{if(!e.target.closest('.autocomplete-wrapper'))list.classList.remove('show')})}

// TIMER
function updateTimerDate(){const n=new Date(),hol=getHolidays(n.getFullYear())[todayKey()];let s=DAYS_L[n.getDay()]+', '+n.getDate()+'. '+MO[n.getMonth()]+' '+n.getFullYear();if(hol)s+=' \u00b7 '+hol;$('timerDate').textContent=s}
$('btnStart').onclick=function(){const proj=$('timerProject').value.trim(),ks=$('timerKS').value;if(!proj){toast('Bitte Projekt w\u00e4hlen','warning');return}if(!ks){toast('Bitte Kostenstelle w\u00e4hlen','warning');return}if(timer.paused){timer.totalPaused+=Date.now()-timer.pauseAt;timer.paused=false;timer.pauseAt=null}else{timer.start=Date.now();timer.totalPaused=0;timer.paused=false;timer.segments=[]}timer.on=true;timer.project=proj;timer.ks=ks;timer.note=$('timerNote').value.trim();localStorage.setItem(lk('timer'),JSON.stringify(timer));updateTimerUI();timerIv=setInterval(tickTimer,1000);$('timerIndicator').classList.add('on');$('timerProjDisp').textContent=ks+' \u00b7 '+proj};
$('btnPause').onclick=function(){if(!timer.on||timer.paused)return;timer.paused=true;timer.pauseAt=Date.now();localStorage.setItem(lk('timer'),JSON.stringify(timer));updateTimerUI()};
$('btnStop').onclick=function(){if(!timer.on)return;clearInterval(timerIv);if(timer.paused)timer.totalPaused+=Date.now()-timer.pauseAt;
  if(timer.segments&&timer.segments.length>0){
    // Has multiple segments - show split dialog
    showSplitDialog(timer.start,Date.now());
  }else{
    // Single project - show normal pause dialog
    const sd=new Date(timer.start),ed=new Date();pendingEntry={date:dateKey(sd),startTime:String(sd.getHours()).padStart(2,'0')+':'+String(sd.getMinutes()).padStart(2,'0'),endTime:String(ed.getHours()).padStart(2,'0')+':'+String(ed.getMinutes()).padStart(2,'0'),project:timer.project,kostenstelle:timer.ks,bemerkung:timer.note||''};showPauseDialog(pendingEntry);
  }};
function tickTimer(){if(!timer.on)return;let el=timer.paused?(timer.pauseAt-timer.start-timer.totalPaused):(Date.now()-timer.start-timer.totalPaused);const s=Math.floor(el/1000),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;$('timerDisplay').textContent=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0')}
function updateTimerUI(){const st=$('btnStart'),pa=$('btnPause'),sp=$('btnStop'),di=$('timerDisplay'),sw=$('btnSwitch');if(timer.on&&!timer.paused){st.style.display='none';pa.style.display='flex';sp.style.display='flex';di.className='timer-time running';if(sw)sw.style.display='inline-flex'}else if(timer.paused){st.style.display='flex';pa.style.display='none';sp.style.display='flex';di.className='timer-time paused';if(sw)sw.style.display='inline-flex'}else{st.style.display='flex';pa.style.display='none';sp.style.display='none';di.className='timer-time';if(sw)sw.style.display='none'}}
function resetTimer(){timer={on:false,paused:false,start:null,pauseAt:null,totalPaused:0,segments:[]};localStorage.removeItem(lk('timer'));$('timerDisplay').textContent='00:00:00';$('timerDisplay').className='timer-time';$('timerProjDisp').textContent='';$('timerIndicator').classList.remove('on');updateTimerUI()}

// PAUSE DIALOG
function showPauseDialog(e){const sMin=timeToMin(e.startTime),eMin=timeToMin(e.endTime),brutto=eMin-sMin,day=new Date(e.date).getDay(),isFri=day===5,cl=sMin<780&&eMin>720;let h='<div class="pause-summary" style="margin-bottom:16px"><div class="pause-row"><span>Arbeitszeit:</span><span style="font-family:var(--font-mono)">'+e.startTime+' \u2013 '+e.endTime+'</span></div><div class="pause-row"><span>Brutto:</span><span style="font-family:var(--font-mono)">'+fmtMin(brutto)+'</span></div></div><div style="font-weight:600;margin-bottom:8px;font-size:.9rem">Pausen-Abz\u00fcge:</div><div class="pause-opt sel" onclick="toggleZn(this)"><input type="checkbox" id="pZn" checked><label for="pZn">Zn\u00fcni-Pause</label><span class="pt">15 Min</span></div>';if(cl||brutto>360){h+='<div class="pause-opt '+(isFri?'':'sel')+'" onclick="selLunch(this)"><input type="radio" name="lunch" value="60" '+(isFri?'':'checked')+'><label>Normale Mittagspause</label><span class="pt">1h</span></div><div class="pause-opt" onclick="selLunch(this)"><input type="radio" name="lunch" value="30"><label>Kurzer Mittag</label><span class="pt">30 Min</span></div><div class="pause-opt '+(isFri?'sel':'')+'" onclick="selLunch(this)"><input type="radio" name="lunch" value="0" '+(isFri?'checked':'')+'><label>Durchgearbeitet</label><span class="pt">0 Min</span></div>'}h+='<div class="pause-summary" id="nettoDisp"></div>';$('pauseBody').innerHTML=h;$('pauseModal').classList.add('show');calcNetto(brutto)}
function toggleZn(el){const c=el.querySelector('input');c.checked=!c.checked;el.classList.toggle('sel',c.checked);recalcN()}
function selLunch(el){document.querySelectorAll('#pauseBody .pause-opt').forEach(o=>{if(o.querySelector('input[name=lunch]'))o.classList.remove('sel')});el.classList.add('sel');el.querySelector('input').checked=true;recalcN()}
function recalcN(){calcNetto(timeToMin(pendingEntry.endTime)-timeToMin(pendingEntry.startTime))}
function calcNetto(brutto){let p=0;const z=$('pZn');if(z&&z.checked)p+=15;const l=document.querySelector('input[name=lunch]:checked');if(l)p+=parseInt(l.value);const d=$('nettoDisp');if(d)d.innerHTML='<div class="pause-row"><span>Pausen total:</span><span style="font-family:var(--font-mono)">'+fmtMin(p)+'</span></div><div class="pause-row total"><span>NETTO:</span><span>'+fmtMin(brutto-p)+'</span></div>'}
$('pauseCancel').onclick=function(){$('pauseModal').classList.remove('show')};
$('pauseConfirm').onclick=function(){let p=0;const z=$('pZn');if(z&&z.checked)p+=15;const l=document.querySelector('input[name=lunch]:checked');if(l)p+=parseInt(l.value);const e=pendingEntry;addEntry({date:e.date,startTime:e.startTime,endTime:e.endTime,pauseMin:p,durationMin:timeToMin(e.endTime)-timeToMin(e.startTime)-p,project:e.project,kostenstelle:e.kostenstelle,bemerkung:e.bemerkung});resetTimer();$('pauseModal').classList.remove('show');pendingEntry=null};

// RECOVERY
function checkRecovery(){const s=localStorage.getItem(lk('timer'));if(!s)return;try{const st=JSON.parse(s);if(!st.on||!st.start)return;const el=Date.now()-st.start-(st.totalPaused||0),h=Math.floor(el/1000/3600),m=Math.floor((el/1000%3600)/60);$('recoveryBody').innerHTML='<p style="margin-bottom:12px">Ein Timer war noch aktiv:</p><div class="pause-summary"><div class="pause-row"><span>Projekt:</span><span>'+(st.project||'\u2014')+'</span></div><div class="pause-row"><span>Kostenstelle:</span><span>'+(st.ks||'\u2014')+'</span></div><div class="pause-row"><span>Verstrichene Zeit:</span><span style="font-family:var(--font-mono);color:var(--primary)">'+h+'h '+m+'min</span></div></div>';$('recoveryModal').classList.add('show')}catch{localStorage.removeItem(lk('timer'))}}
$('recoveryRestore').onclick=function(){const s=localStorage.getItem(lk('timer'));if(!s)return;timer=JSON.parse(s);$('timerProject').value=timer.project||'';$('timerKS').value=timer.ks||'';$('timerNote').value=timer.note||'';updateTimerUI();timerIv=setInterval(tickTimer,1000);tickTimer();$('timerIndicator').classList.add('on');$('timerProjDisp').textContent=timer.ks+' \u00b7 '+timer.project;$('recoveryModal').classList.remove('show');toast('Timer wiederhergestellt','success');updateSegmentDisplay()};
$('recoveryDiscard').onclick=function(){localStorage.removeItem(lk('timer'));$('recoveryModal').classList.remove('show')};

// MANUAL
$('manSaveBtn').onclick=function(){const dt=$('manDate').value,st=$('manStart').value,en=$('manEnd').value,pr=$('manProject').value.trim(),ks=$('manKS').value,nt=$('manNote').value.trim();if(!dt||!st||!en){toast('Datum und Zeiten ausf\u00fcllen','warning');return}if(!pr){toast('Projekt w\u00e4hlen','warning');return}if(!ks){toast('Kostenstelle w\u00e4hlen','warning');return}const sM=timeToMin(st),eM=timeToMin(en);if(eM<=sM){toast('Endzeit nach Startzeit','warning');return}const brutto=eM-sM;const hasZnueni=$('manZnueni').checked;const mittagVal=$('manMittag').value;let p=0;if(hasZnueni)p+=15;if(mittagVal==='60min')p+=60;else if(mittagVal==='30min')p+=30;addEntry({date:dt,start:st,end:en,startTime:st,endTime:en,pauseMin:p,durationMin:brutto-p,hours:(brutto-p)/60,project:pr,projectName:pr,kostenstelle:ks,costCenter:ks,bemerkung:nt,note:nt,pauseZnueni:hasZnueni,znueniPause:hasZnueni,pauseMittag:mittagVal,mittagsPause:mittagVal,breakMinutes:p});$('manProject').value='';$('manKS').value='';$('manNote').value='';$('manZnueni').checked=true;$('manMittag').value='60min'};

// EDIT/DELETE
function openEdit(id){const e=getEntries().find(x=>x.id===id);if(!e)return;editId=id;const ksOpts=['B\u00fcro','Zuschnitt','BAZ','Werkstatt','Montage'].map(k=>'<option '+(k===e.kostenstelle?'selected':'')+'>'+k+'</option>').join('');$('editBody').innerHTML='<div class="form-row"><div class="form-group"><label class="form-label">Startzeit</label><input type="time" class="form-input" id="edStart" value="'+e.startTime+'"></div><div class="form-group"><label class="form-label">Endzeit</label><input type="time" class="form-input" id="edEnd" value="'+e.endTime+'"></div></div><div class="form-group autocomplete-wrapper"><label class="form-label">Projekt</label><input type="text" class="form-input" id="edProject" value="'+e.project+'" autocomplete="off"><div class="autocomplete-list" id="edProjectAC"></div></div><div class="form-group"><label class="form-label">Kostenstelle</label><select class="form-select" id="edKS"><option value="">\u2014</option>'+ksOpts+'</select></div><div class="form-group"><label class="form-label">Pause (Min)</label><input type="number" class="form-input" id="edPause" value="'+(e.pauseMin||0)+'" min="0" max="120"></div><div class="form-group"><label class="form-label">Bemerkung</label><input type="text" class="form-input" id="edNote" value="'+(e.bemerkung||'')+'"></div>';setupAC('edProject','edProjectAC');$('editModal').classList.add('show')}
$('editCancel').onclick=function(){$('editModal').classList.remove('show');editId=null};
$('editSave').onclick=function(){if(!editId)return;const st=$('edStart').value,en=$('edEnd').value,pr=$('edProject').value.trim(),ks=$('edKS').value,p=parseInt($('edPause').value)||0,nt=$('edNote').value.trim();if(!st||!en||!pr||!ks){toast('Pflichtfelder ausf\u00fcllen','warning');return}updateEntry(editId,{startTime:st,endTime:en,project:pr,kostenstelle:ks,pauseMin:p,durationMin:timeToMin(en)-timeToMin(st)-p,bemerkung:nt});toast('Aktualisiert','success');$('editModal').classList.remove('show');editId=null};
$('editDelete').onclick=function(){if(!editId)return;if(confirm('Eintrag wirklich l\u00f6schen?')){removeEntry(editId);toast('Gel\u00f6scht','info');$('editModal').classList.remove('show');editId=null}};

// RENDER
function renderEC(e){const dur=e.durationMin||0,ksC=KS_COLORS[e.kostenstelle]||'#666';return '<div class="entry-card" style="border-left-color:'+ksC+'"><div class="entry-info"><div class="entry-time">'+e.startTime+' \u2013 '+e.endTime+' ('+fmtH(dur)+')</div><div class="entry-meta">'+e.kostenstelle+' \u00b7 '+e.project+(e.bemerkung?' \u00b7 '+e.bemerkung:'')+'</div></div><div class="entry-right"><div class="entry-duration">'+fmtH(dur)+'</div><button class="entry-action" onclick="openEdit(\''+e.id+'\')">\u270f\ufe0f</button></div></div>'}
function renderKSBars(cid,entries,total){const el=$(cid);if(!total){el.innerHTML='<p style="color:var(--text-muted);font-size:.85rem">Keine Daten</p>';return}const ks={};entries.forEach(e=>{ks[e.kostenstelle]=(ks[e.kostenstelle]||0)+(e.durationMin||0)});el.innerHTML=Object.entries(ks).sort((a,b)=>b[1]-a[1]).map(([k,m])=>'<div class="stat-bar-item"><div class="stat-bar-label">'+k+'</div><div class="stat-bar-track"><div class="stat-bar-fill" style="width:'+(m/total*100).toFixed(0)+'%;background:'+(KS_COLORS[k]||'#666')+'"></div></div><div class="stat-bar-value">'+fmtH(m)+'</div></div>').join('')}
function renderToday(){const entries=getEntries().filter(e=>e.date===todayKey()),total=entries.reduce((s,e)=>s+(e.durationMin||0),0),n=new Date();$('todayTitle').textContent=DAYS_L[n.getDay()]+', '+fmtDate(n);$('todayTotal').textContent=fmtH(total);renderKSBars('todayBars',entries,total);$('todayEntries').innerHTML=entries.length?entries.map(renderEC).join(''):'<div class="empty-state"><div class="empty-icon">\ud83d\udcdd</div><p>Noch keine Eintr\u00e4ge heute</p></div>'}
function renderWeek(){const wd=getWeekDates(),entries=getEntries();let wt=0;const ksW={};const bars=wd.map(d=>{const dk=dateKey(d),de=entries.filter(e=>e.date===dk),dm=de.reduce((s,e)=>s+(e.durationMin||0),0);wt+=dm;de.forEach(e=>{ksW[e.kostenstelle]=(ksW[e.kostenstelle]||0)+(e.durationMin||0)});const ksD={};de.forEach(e=>{ksD[e.kostenstelle]=(ksD[e.kostenstelle]||0)+(e.durationMin||0)});const segs=Object.entries(ksD).map(([k,m])=>'<div class="week-seg" style="width:'+(m/600*100).toFixed(1)+'%;background:'+(KS_COLORS[k]||'#666')+'"></div>').join('');const isT=dk===todayKey();return '<div class="week-row" style="'+(isT?'background:var(--primary-dim);border-radius:6px;padding:8px':'')+'"><div class="week-day">'+DAYS_S[d.getDay()]+'</div><div class="week-bar">'+segs+'</div><div class="week-hrs">'+fmtH(dm)+'</div></div>'}).join('');$('weekTotal').textContent=fmtH(wt);$('weekDayBars').innerHTML=bars;const wEl=$('weekKSBars');if(!wt){wEl.innerHTML='<p style="color:var(--text-muted);font-size:.85rem">Keine Daten</p>';return}wEl.innerHTML=Object.entries(ksW).sort((a,b)=>b[1]-a[1]).map(([k,m])=>'<div class="stat-bar-item"><div class="stat-bar-label">'+k+'</div><div class="stat-bar-track"><div class="stat-bar-fill" style="width:'+(m/wt*100).toFixed(0)+'%;background:'+(KS_COLORS[k]||'#666')+'"></div></div><div class="stat-bar-value">'+fmtH(m)+'</div></div>').join('')}

// CALENDAR
// ========== MONTH CALENDAR ==========
let calMonth=new Date().getMonth(),calYear=new Date().getFullYear(),calSelDate=null;
$('calPrev').onclick=function(){calMonth--;if(calMonth<0){calMonth=11;calYear--}updateMonthCalendar()};
$('calNext').onclick=function(){calMonth++;if(calMonth>11){calMonth=0;calYear++}updateMonthCalendar()};
$('calToday').onclick=function(){calMonth=new Date().getMonth();calYear=new Date().getFullYear();calSelDate=todayKey();updateMonthCalendar();showCalDayDetail(calSelDate)};

function updateMonthCalendar(){
  $('calMonthTitle').textContent=MO[calMonth]+' '+calYear;
  const grid=$('calMonthGrid');if(!grid)return;
  const entries=getEntries();
  const allAbs=getAbsences().filter(a=>a.employeeId===user.id);
  const hol=getHolidays(calYear);
  const first=new Date(calYear,calMonth,1);
  const lastDay=new Date(calYear,calMonth+1,0).getDate();
  const startDow=(first.getDay()+6)%7; // 0=Mo

  let html='';
  ['Mo','Di','Mi','Do','Fr','Sa','So'].forEach((d,i)=>{
    html+='<div class="mg-header'+(i>=5?' weekend':'')+'">'+d+'</div>';
  });

  // Previous month fill
  const prevLast=new Date(calYear,calMonth,0).getDate();
  for(let i=startDow-1;i>=0;i--){
    const d=prevLast-i;
    const pm=calMonth===0?11:calMonth-1;
    const py=calMonth===0?calYear-1:calYear;
    const dk=py+'-'+String(pm+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    html+=buildMonthCell(dk,d,true,false,entries,allAbs,hol);
  }

  // Current month
  for(let d=1;d<=lastDay;d++){
    const dk=calYear+'-'+String(calMonth+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    const dow=new Date(calYear,calMonth,d).getDay();
    const isWeekend=dow===0||dow===6;
    html+=buildMonthCell(dk,d,false,isWeekend,entries,allAbs,hol);
  }

  // Next month fill
  const totalCells=startDow+lastDay;
  const remaining=totalCells%7===0?0:7-(totalCells%7);
  for(let d=1;d<=remaining;d++){
    const nm=calMonth===11?0:calMonth+1;
    const ny=calMonth===11?calYear+1:calYear;
    const dk=ny+'-'+String(nm+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    html+=buildMonthCell(dk,d,true,false,entries,allAbs,hol);
  }

  grid.innerHTML=html;
}

function buildMonthCell(dk,dayNum,otherMonth,isWeekend,entries,absences,holidays){
  const isToday=dk===todayKey();
  const isSel=dk===calSelDate;
  const dayEntries=entries.filter(e=>e.date===dk);
  const totalMin=dayEntries.reduce((s,e)=>s+(e.durationMin||0),0);
  const holName=holidays[dk];
  const abs=absences.find(a=>a.from<=dk&&a.to>=dk&&a.status!=='rejected');
  const bf=isBetriebsferien(dk);
  const hasEntries=dayEntries.length>0;

  let cls='month-cell';
  if(otherMonth)cls+=' other-month';
  if(isWeekend)cls+=' weekend';
  if(isToday)cls+=' today';
  if(isSel)cls+=' selected';

  let inner='<div class="mc-day">'+dayNum+'</div>';
  if(hasEntries)inner+='<div class="mc-hours">'+fmtH(totalMin)+'</div>';
  if(holName)inner+='<div class="mc-badge holiday">Feiertag</div>';
  else if(bf&&!hasEntries)inner+='<div class="mc-badge" style="background:#6366f1;color:#fff">'+(bf.type==='Betriebsferien'?'\uD83C\uDFE2':'\uD83C\uDF09')+'</div>';
  else if(bf&&hasEntries)inner+='<div class="mc-badge has-entries">\uD83C\uDFE2\u2713</div>';
  else if(abs){
    const icon=ABS_TYPES[abs.type]||'';
    inner+='<div class="mc-badge absence">'+icon+'</div>';
  }

  return '<div class="'+cls+'" onclick="onCalCellClick(\''+dk+'\')" title="'+dk+(holName?' - '+holName:'')+(bf?' - '+bf.label:'')+'">'+inner+'</div>';
}

function onCalCellClick(dk){
  calSelDate=dk;
  updateMonthCalendar();
  showCalDayDetail(dk);
}

function showCalDayDetail(dk){
  const detail=$('calDayDetail');if(!detail)return;
  detail.style.display='block';
  const d=new Date(dk);
  const dow=d.getDay();
  $('calDayTitle').textContent=DAYS_L[dow]+', '+fmtDate(d);
  const entries=getEntries().filter(e=>e.date===dk);
  const total=entries.reduce((s,e)=>s+(e.durationMin||0),0);
  $('calDayTotal').textContent=fmtH(total);
  renderKSBars('calDayKS',entries,total);

  let html='';

  // Holiday check
  const hol=getHolidays(d.getFullYear())[dk];
  if(hol)html+='<div style="background:rgba(239,68,68,.12);padding:8px 12px;border-radius:6px;margin-bottom:8px;font-size:.85rem">\uD83C\uDF89 <strong>Feiertag:</strong> '+hol+'</div>';

  // Betriebsferien check
  const bf=isBetriebsferien(dk);
  if(bf)html+='<div style="background:rgba(99,102,241,.12);padding:8px 12px;border-radius:6px;margin-bottom:8px;font-size:.85rem">\uD83C\uDFE2 <strong>'+bf.type+':</strong> '+bf.label+(entries.length?' \u2013 Du hast gearbeitet (kein Ferienabzug)':'')+'</div>';

  // Absences
  const myAbs=getAbsences().filter(a=>a.employeeId===user.id&&a.from<=dk&&a.to>=dk&&a.status!=='rejected');
  myAbs.forEach(a=>{
    const icon=ABS_TYPES[a.type]||'\uD83D\uDCCB';
    const statusTxt=a.status==='approved'?'Genehmigt':a.status==='rejected'?'Abgelehnt':'Pendent';
    html+='<div style="background:rgba(251,191,36,.12);padding:8px 12px;border-radius:6px;margin-bottom:8px;font-size:.85rem">'+icon+' <strong>'+a.type+'</strong> \u2013 '+statusTxt+(a.note?' \u00b7 '+a.note:'')+'</div>';
  });

  // Soll/Ist for this day
  if(user){
    const empS=getEmpSetting(user.id);
    const arbeitsTage=empS.arbeitsTage||[1,2,3,4,5];
    if(arbeitsTage.includes(dow)&&!hol){
      const raucherMin=empS.raucher&&entries.length?15:0;
      const istMin=total-raucherMin;
      const effS=getEffectiveSettings(user.id,dk);
      const sollMin=Math.round((effS.weekHours/(arbeitsTage.length))*60);
      const saldoMin=istMin-sollMin;
      html+='<div style="display:flex;gap:12px;padding:8px 0;font-size:.82rem;border-bottom:1px solid var(--border);margin-bottom:8px">';
      html+='<span>Soll: <strong>'+fmtH(sollMin)+'</strong></span>';
      html+='<span>Ist: <strong>'+fmtH(istMin)+'</strong></span>';
      html+='<span style="color:'+(saldoMin>=0?'var(--success)':'var(--danger)')+'">Saldo: <strong>'+(saldoMin>=0?'+':'')+fmtH(saldoMin)+'</strong></span>';
      if(empS.raucher&&entries.length)html+='<span style="color:var(--warning)">\uD83D\uDEAC -15min</span>';
      if(effS._tempActive)html+='<span style="color:var(--danger)">(reduziert '+effS.pensum+'%)</span>';
      html+='</div>';
    }
  }

  // Entries
  $('calDayEntriesTitle').textContent=entries.length+' Eintr\u00e4ge';
  if(entries.length){
    // Pause summary
    let hasZnueni=false,hasMittag=false,mittagDetail='';
    entries.forEach(e=>{
      if(e.pauseZnueni||e.znueniPause)hasZnueni=true;
      if(e.pauseMittag&&e.pauseMittag!=='none'){hasMittag=true;mittagDetail=e.pauseMittag==='60min'?'1h':e.pauseMittag==='30min'?'30min':'durchgearb.';}
      if(e.mittagsPause&&e.mittagsPause!=='none'){hasMittag=true;mittagDetail=e.mittagsPause==='60min'?'1h':e.mittagsPause==='30min'?'30min':'durchgearb.';}
    });
    html+='<div style="font-size:.8rem;color:var(--text-dim);padding:4px 0;margin-bottom:8px">\u2615 Zn\u00fcni: '+(hasZnueni?'\u2713':'\u2717')+' \u00b7 \uD83C\uDF7D Mittag: '+(hasMittag?mittagDetail:'\u2717')+'</div>';
    html+=entries.map(renderEC).join('');
  }else{
    html+='<div class="empty-state"><div class="empty-icon">\uD83D\uDCC5</div><p>Keine Eintr\u00e4ge</p></div>';
  }

  $('calDayEntries').innerHTML=html;
}

// ADMIN
function renderProjectList(filter){const f=(filter||'').toLowerCase();const filtered=f?projects.filter(p=>p.id.includes(f)||p.name.toLowerCase().includes(f)):projects;$('projCountDisp').textContent=projects.length;$('projFilterCount').textContent=f?filtered.length+' von '+projects.length:projects.length+' Projekte';$('projList').innerHTML=filtered.map(p=>'<div class="proj-list-item"><span class="proj-id">'+p.id+'</span><span class="proj-name" title="'+p.name+'">'+p.name+'</span><span class="proj-badge '+(p.aktiv?'':'inactive')+'">'+(p.aktiv?'aktiv':'inaktiv')+'</span><button class="entry-action" onclick="toggleProjActive(\''+p.id+'\')">\u270f\ufe0f</button></div>').join('')}
$('projSearch').oninput=function(){renderProjectList(this.value)};
function toggleProjActive(id){const p=projects.find(x=>x.id===id);if(!p)return;p.aktiv=!p.aktiv;localStorage.setItem(C.LS+'projects',JSON.stringify(projects));renderProjectList($('projSearch').value);toast('Projekt '+id+' '+(p.aktiv?'aktiviert':'deaktiviert'),'info');if(accessToken)SP.saveProjects()}
$('addProjBtn').onclick=function(){const maxId=Math.max(...projects.map(p=>parseInt(p.id)||0));$('newProjId').value=String(maxId+1);$('newProjName').value='';$('addProjModal').classList.add('show')};
$('addProjCancel').onclick=function(){$('addProjModal').classList.remove('show')};
$('addProjSave').onclick=function(){const id=$('newProjId').value.trim(),name=$('newProjName').value.trim();if(!id||!name){toast('ID und Name erforderlich','warning');return}if(projects.find(p=>p.id===id)){toast('Nr. existiert bereits','warning');return}projects.unshift({id:id,name:name,aktiv:true});localStorage.setItem(C.LS+'projects',JSON.stringify(projects));renderProjectList();$('addProjModal').classList.remove('show');toast('Projekt '+id+' hinzugef\u00fcgt','success');if(accessToken)SP.saveProjects()};
$('importProjFile').onchange=function(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=function(ev){try{const data=JSON.parse(ev.target.result);if(data.projekte&&Array.isArray(data.projekte)){projects=data.projekte;localStorage.setItem(C.LS+'projects',JSON.stringify(projects));renderProjectList();toast(projects.length+' Projekte importiert','success');if(accessToken)SP.saveProjects()}else toast('Ung\u00fcltiges Format','error')}catch{toast('JSON-Fehler','error')}};reader.readAsText(file)};
$('loadSPProj').onclick=async function(){if(!accessToken){toast('Bitte mit Microsoft anmelden','warning');return}await SP.loadProjects()};
$('exportProjBtn').onclick=function(){const blob=new Blob([JSON.stringify({lastUpdated:new Date().toISOString().split('T')[0],count:projects.length,projekte:projects},null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='projekte.json';a.click();toast('projekte.json exportiert','success')};
$('syncNowBtn').onclick=async function(){if(!accessToken){toast('Bitte mit Microsoft anmelden','warning');return}await SP.fullSync()};
$('forceSPUpload').onclick=async function(){if(!accessToken){toast('Bitte mit Microsoft anmelden','warning');return}setSyncStatus('syncing');try{await SP.saveEntries();await SP.saveProjects();setSyncStatus('online');toast('Alles hochgeladen','success')}catch(e){setSyncStatus('offline');toast('Fehler: '+e.message,'error')}};

// EXPORT
$('expWeek').onclick=function(){exportCSV('week')};$('expMonth').onclick=function(){exportCSV('month')};$('expAll').onclick=function(){exportCSV('all')};
function exportCSV(range){let entries=getEntries();const now=new Date();if(range==='week'){const wd=getWeekDates(),keys=wd.map(d=>dateKey(d));entries=entries.filter(e=>keys.includes(e.date))}else if(range==='month'){const ym=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');entries=entries.filter(e=>e.date.startsWith(ym))}if(!entries.length){toast('Keine Daten','warning');return}entries.sort((a,b)=>a.date.localeCompare(b.date)||a.startTime.localeCompare(b.startTime));let csv='\uFEFF'+'Mitarbeiter;Datum;Start;Ende;Pause (Min);Dauer (h);Kostenstelle;Projekt;Bemerkung\n';entries.forEach(e=>{csv+=user.name+';'+fmtDate(e.date)+';'+e.startTime+';'+e.endTime+';'+(e.pauseMin||0)+';'+((e.durationMin||0)/60).toFixed(2)+';'+e.kostenstelle+';'+e.project+';'+(e.bemerkung||'')+'\n'});const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='Zeiterfassung_'+user.name.replace(/\s/g,'_')+'_'+range+'.csv';a.click();toast('Export erstellt','success')}

// AUTO-STOP
window.addEventListener('beforeunload',e=>{if(timer.on){e.preventDefault();e.returnValue=''}});
setInterval(()=>{if(!timer.on)return;const now=new Date(),h=now.getHours(),day=now.getDay(),isFri=day===5;if(isFri&&h>=15){clearInterval(timerIv);pendingEntry={date:dateKey(new Date(timer.start)),startTime:String(new Date(timer.start).getHours()).padStart(2,'0')+':'+String(new Date(timer.start).getMinutes()).padStart(2,'0'),endTime:'14:00',project:timer.project,kostenstelle:timer.ks,bemerkung:timer.note||''};showPauseDialog(pendingEntry);toast('Timer um 14:00 gestoppt (Fr)','warning')}else if(!isFri&&day>=1&&day<=4&&h>=18){clearInterval(timerIv);pendingEntry={date:dateKey(new Date(timer.start)),startTime:String(new Date(timer.start).getHours()).padStart(2,'0')+':'+String(new Date(timer.start).getMinutes()).padStart(2,'0'),endTime:'17:00',project:timer.project,kostenstelle:timer.ks,bemerkung:timer.note||''};showPauseDialog(pendingEntry);toast('Timer um 17:00 gestoppt','warning')}},60000);

// PUSH NOTIFICATIONS
const NOTIF_DEFAULTS={morning:'06:55',morningOn:true,lunch:'12:00',lunchOn:true,eveningMoDo:'16:45',eveningOn:true,eveningFr:'13:45',fridayOn:true,overflowH:10,overflowOn:true};
function getNotifSettings(){try{return JSON.parse(localStorage.getItem(C.LS+'notif_settings'))||{...NOTIF_DEFAULTS}}catch{return{...NOTIF_DEFAULTS}}}
function saveNotifSettings(s){localStorage.setItem(C.LS+'notif_settings',JSON.stringify(s));if(accessToken)SP.writeFile('notif_settings.json',s).then(()=>console.log('[SP] notif_settings gespeichert')).catch(e=>console.warn('[SP] notif_settings Fehler:',e))}
function loadNotifUI(){
  const s=getNotifSettings();
  if($('notifMorning'))$('notifMorning').value=s.morning||'06:55';
  if($('notifMorningOn'))$('notifMorningOn').value=s.morningOn!==false?'1':'0';
  if($('notifLunch'))$('notifLunch').value=s.lunch||'12:00';
  if($('notifLunchOn'))$('notifLunchOn').value=s.lunchOn!==false?'1':'0';
  if($('notifEveningMoDo'))$('notifEveningMoDo').value=s.eveningMoDo||'16:45';
  if($('notifEveningOn'))$('notifEveningOn').value=s.eveningOn!==false?'1':'0';
  if($('notifEveningFr'))$('notifEveningFr').value=s.eveningFr||'13:45';
  if($('notifFridayOn'))$('notifFridayOn').value=s.fridayOn!==false?'1':'0';
  if($('notifOverflow'))$('notifOverflow').value=s.overflowH||10;
  if($('notifOverflowOn'))$('notifOverflowOn').value=s.overflowOn!==false?'1':'0';
  updateNotifStatus();
}
function updateNotifStatus(){const el=$('notifStatus');if(!el)return;if(!('Notification' in window)){el.textContent='Browser unterst\u00fctzt keine Benachrichtigungen';return}if(Notification.permission==='granted')el.textContent='Aktiviert';else if(Notification.permission==='denied')el.textContent='Blockiert - bitte in Browser-Einstellungen erlauben';else el.textContent='Noch nicht aktiviert'}
function showNotif(title,body,tag){if(Notification.permission!=='granted')return;try{const n=new Notification(title,{body:body,tag:tag||'hm-'+Date.now(),requireInteraction:false});n.onclick=function(){window.focus();n.close()};setTimeout(()=>n.close(),15000)}catch(e){console.warn('Notif:',e)}}
$('notifEnableBtn').onclick=async function(){if(!('Notification' in window)){toast('Browser unterst\u00fctzt keine Benachrichtigungen','error');return}const perm=await Notification.requestPermission();if(perm==='granted'){toast('Benachrichtigungen aktiviert','success');updateNotifStatus();showNotif('Hubler Zeiterfassung','Benachrichtigungen sind jetzt aktiv!')}else{toast('Berechtigung abgelehnt','warning');updateNotifStatus()}};
$('notifTestBtn').onclick=function(){if(Notification.permission!=='granted'){toast('Bitte zuerst aktivieren','warning');return}showNotif('Test-Benachrichtigung','Push-Notifications funktionieren!')};
$('notifSaveBtn').onclick=function(){const s={morning:$('notifMorning').value,morningOn:$('notifMorningOn').value==='1',lunch:$('notifLunch').value,lunchOn:$('notifLunchOn').value==='1',eveningMoDo:$('notifEveningMoDo').value,eveningOn:$('notifEveningOn').value==='1',eveningFr:$('notifEveningFr').value,fridayOn:$('notifFridayOn').value==='1',overflowH:parseInt($('notifOverflow').value)||10,overflowOn:$('notifOverflowOn').value==='1'};saveNotifSettings(s);toast('Einstellungen gespeichert','success')};

let notifFiredToday={};
function checkNotifications(){
  if(!user||Notification.permission!=='granted')return;
  const s=getNotifSettings();const now=new Date();const day=now.getDay();
  const hhmm=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  const todayStr=todayKey();const isFri=day===5;const isWeekday=day>=1&&day<=5;
  if(!isWeekday)return;
  if(notifFiredToday._date!==todayStr)notifFiredToday={_date:todayStr};
  if(s.morningOn&&hhmm===s.morning&&!notifFiredToday.morning&&!timer.on){showNotif('Guten Morgen!','Zeit den Timer zu starten - einen produktiven Tag!','morning');notifFiredToday.morning=true}
  if(s.lunchOn&&hhmm===s.lunch&&!notifFiredToday.lunch&&timer.on){showNotif('Mittagspause!','Guten Appetit! Vergiss nicht eine Pause einzulegen.','lunch');notifFiredToday.lunch=true}
  if(isFri&&s.fridayOn&&hhmm===s.eveningFr&&!notifFiredToday.friday){showNotif('Sch\u00f6nes Wochenende!','Bitte Timer stoppen und pr\u00fcfen ob alle Stunden dieser Woche erfasst sind. Erholsames Wochenende!','friday');notifFiredToday.friday=true}
  if(!isFri&&s.eveningOn&&hhmm===s.eveningMoDo&&!notifFiredToday.evening&&timer.on){showNotif('Feierabend!','Vergiss nicht den Timer zu stoppen und deine Stunden zu pr\u00fcfen.','evening');notifFiredToday.evening=true}
  if(s.overflowOn&&timer.on&&!timer.paused&&!notifFiredToday.overflow){const elapsed=(Date.now()-timer.start-timer.totalPaused)/3600000;if(elapsed>=s.overflowH){showNotif('Timer l\u00e4uft seit '+Math.floor(elapsed)+'h!','Mehr als '+s.overflowH+'h. Bitte pr\u00fcfen ob der Timer noch laufen soll.','overflow');notifFiredToday.overflow=true}}
}
setInterval(checkNotifications,30000);
async function loadNotifSettingsFromSP(){if(!accessToken)return;try{const data=await SP.readFile('notif_settings.json');if(data&&data.morning){localStorage.setItem(C.LS+'notif_settings',JSON.stringify(data));if(user&&user.admin)loadNotifUI()}}catch{}}


// PROJECT SWITCH (during running timer)
function switchProject(){
  if(!timer.on)return;
  const proj=$('timerProject').value.trim(),ks=$('timerKS').value;
  if(!proj){toast('Bitte neues Projekt w\u00e4hlen','warning');return}
  if(!ks){toast('Bitte Kostenstelle w\u00e4hlen','warning');return}
  // Save current segment
  const now=Date.now();
  const segStart=timer.segments.length>0?timer.segments[timer.segments.length-1].end:timer.start;
  timer.segments.push({start:segStart,end:now,project:timer.project,ks:timer.ks,note:timer.note});
  // Switch to new project
  timer.project=proj;timer.ks=ks;timer.note=$('timerNote').value.trim();
  localStorage.setItem(lk('timer'),JSON.stringify(timer));
  $('timerProjDisp').textContent=ks+' \u00b7 '+proj;
  toast('Projekt gewechselt \u2013 Segment gespeichert','success');
  updateSegmentDisplay();
}

function updateSegmentDisplay(){
  let el=$('segmentInfo');
  if(!el){el=document.createElement('div');el.id='segmentInfo';el.style.cssText='margin-top:12px;font-size:.8rem;color:var(--text-dim)';const tc=document.querySelector('#tab-timer .timer-controls');if(tc)tc.parentNode.insertBefore(el,tc.nextSibling)}
  if(!timer.segments||!timer.segments.length){el.innerHTML='';return}
  const segs=timer.segments.map((s,i)=>{const dur=Math.round((s.end-s.start)/60000);return '<div style="display:flex;justify-content:space-between;padding:4px 8px;background:var(--bg-surface);border-radius:4px;margin-bottom:4px;border-left:3px solid '+(KS_COLORS[s.ks]||'#666')+'"><span>'+s.ks+' \u00b7 '+s.project.substring(0,40)+'</span><span style="font-family:var(--font-mono)">'+fmtH(dur)+'</span></div>'}).join('');
  el.innerHTML='<div style="font-weight:600;margin-bottom:6px;font-size:.75rem;text-transform:uppercase;color:var(--text-muted)">Bisherige Segmente ('+timer.segments.length+')</div>'+segs;
}

// SPLIT DIALOG (when stopping timer with segments)
function showSplitDialog(totalStart,totalEnd){
  // Build segments list including current running segment
  const allSegs=[...timer.segments];
  const lastSegStart=allSegs.length>0?allSegs[allSegs.length-1].end:timer.start;
  allSegs.push({start:lastSegStart,end:Date.now(),project:timer.project,ks:timer.ks,note:timer.note});

  const startDate=new Date(totalStart);
  const endDate=new Date(totalEnd);
  const date=dateKey(startDate);
  const startTime=String(startDate.getHours()).padStart(2,'0')+':'+String(startDate.getMinutes()).padStart(2,'0');
  const endTime=String(endDate.getHours()).padStart(2,'0')+':'+String(endDate.getMinutes()).padStart(2,'0');
  const totalMin=Math.round((totalEnd-totalStart-timer.totalPaused)/60000);

  let h='<div class="pause-summary" style="margin-bottom:16px"><div class="pause-row"><span>Gesamtzeit:</span><span style="font-family:var(--font-mono)">'+startTime+' \u2013 '+endTime+' ('+fmtH(totalMin)+')</span></div><div class="pause-row"><span>Segmente:</span><span style="font-family:var(--font-mono)">'+allSegs.length+'</span></div></div>';
  h+='<div style="font-weight:600;margin-bottom:8px">Zeitaufteilung:</div>';
  h+='<div id="splitSegments">';
  allSegs.forEach((seg,i)=>{
    const segDur=Math.round((seg.end-seg.start)/60000);
    const segStartT=new Date(seg.start);
    const segEndT=new Date(seg.end);
    const sTime=String(segStartT.getHours()).padStart(2,'0')+':'+String(segStartT.getMinutes()).padStart(2,'0');
    const eTime=String(segEndT.getHours()).padStart(2,'0')+':'+String(segEndT.getMinutes()).padStart(2,'0');
    const ksColor=KS_COLORS[seg.ks]||'#666';
    h+='<div class="entry-card" style="border-left-color:'+ksColor+';margin-bottom:8px"><div class="entry-info"><div class="entry-time">'+sTime+' \u2013 '+eTime+' ('+fmtH(segDur)+')</div><div class="entry-meta">'+seg.ks+' \u00b7 '+seg.project+'</div></div><div class="entry-right"><div class="entry-duration" style="color:var(--accent)">'+fmtH(segDur)+'</div></div></div>';
  });
  h+='</div>';
  h+='<div style="margin-top:12px"><button class="btn btn-secondary btn-sm" onclick="addSplitRow()" style="width:100%">+ Weiteres Segment hinzuf\u00fcgen</button></div>';
  h+='<div id="extraSplitRows"></div>';

  // Store segments for later
  window._splitSegs=allSegs;
  window._splitDate=date;
  window._splitTotalMin=totalMin;

  $('splitBody').innerHTML=h;
  $('splitModal').classList.add('show');
}

function addSplitRow(){
  const container=$('extraSplitRows');
  const idx=container.children.length;
  const active=getActiveProjects();
  const d=document.createElement('div');
  d.className='card';d.style.cssText='padding:12px;margin-top:8px';
  d.innerHTML='<div class="form-row"><div class="form-group"><label class="form-label">Start</label><input type="time" class="form-input split-start-'+idx+'"></div><div class="form-group"><label class="form-label">Ende</label><input type="time" class="form-input split-end-'+idx+'"></div></div><div class="form-group autocomplete-wrapper"><label class="form-label">Projekt</label><input type="text" class="form-input split-proj-'+idx+'" placeholder="Suchen..." autocomplete="off"><div class="autocomplete-list" id="splitAC'+idx+'"></div></div><div class="form-group"><label class="form-label">Kostenstelle</label><select class="form-select split-ks-'+idx+'"><option value="">--</option><option>B\u00fcro</option><option>Zuschnitt</option><option>BAZ</option><option>Werkstatt</option><option>Montage</option></select></div><button class="btn btn-danger btn-sm" onclick="this.parentNode.remove()" style="width:100%">Entfernen</button>';
  container.appendChild(d);
  setupAC('split-proj-'+idx,'splitAC'+idx);
}

function saveSplitEntries(){
  const segs=window._splitSegs||[];
  const date=window._splitDate;
  if(!segs.length){$('splitModal').classList.remove('show');return}

  // Save each segment as entry
  // First ask for pause distribution
  const totalMin=window._splitTotalMin;
  const day=new Date(date).getDay();
  const isFri=day===5;
  // Simple: apply pause to first segment (znueni) and lunch to longest segment
  let znueni=15;
  let lunch=0;
  if(totalMin>360&&!isFri)lunch=60;

  segs.forEach((seg,i)=>{
    const segDur=Math.round((seg.end-seg.start)/60000);
    const segStart=new Date(seg.start);
    const segEnd=new Date(seg.end);
    const sTime=String(segStart.getHours()).padStart(2,'0')+':'+String(segStart.getMinutes()).padStart(2,'0');
    const eTime=String(segEnd.getHours()).padStart(2,'0')+':'+String(segEnd.getMinutes()).padStart(2,'0');
    let pauseMin=0;
    if(i===0)pauseMin+=znueni;// Znueni on first segment
    // Apply lunch to the segment that crosses 12:00
    const crossesLunch=segStart.getHours()<12&&segEnd.getHours()>=12;
    if(crossesLunch&&lunch>0){pauseMin+=lunch;lunch=0}
    addEntry({date:date,startTime:sTime,endTime:eTime,pauseMin:pauseMin,durationMin:segDur-pauseMin,project:seg.project,kostenstelle:seg.ks,bemerkung:seg.note||''});
  });

  // Also save any extra manual split rows
  const container=$('extraSplitRows');
  if(container){
    for(let i=0;i<container.children.length;i++){
      const row=container.children[i];
      const st=row.querySelector('[class*=split-start]');
      const en=row.querySelector('[class*=split-end]');
      const pr=row.querySelector('[class*=split-proj]');
      const ks=row.querySelector('[class*=split-ks]');
      if(st&&en&&pr&&ks&&st.value&&en.value&&pr.value&&ks.value){
        const sM=timeToMin(st.value),eM=timeToMin(en.value);
        if(eM>sM){addEntry({date:date,startTime:st.value,endTime:en.value,pauseMin:0,durationMin:eM-sM,project:pr.value,kostenstelle:ks.value,bemerkung:''})}
      }
    }
  }

  resetTimer();
  $('splitModal').classList.remove('show');
  window._splitSegs=null;
}



// EMPLOYEE SETTINGS (Admin only)
const EMP_DEFAULTS={pensum:100,weekHours:41,ferienTage:23,arbeitsTage:[1,2,3,4,5],ferienUebertrag:0,ueberstundenUebertrag:0,raucher:false,tempPensum:[],year:new Date().getFullYear()};
function getEmpSettings(){try{return JSON.parse(localStorage.getItem(C.LS+'emp_settings'))||{}}catch{return{}}}
function saveEmpSettings(s){localStorage.setItem(C.LS+'emp_settings',JSON.stringify(s));if(accessToken)SP.writeFile('emp_settings.json',s).then(()=>console.log('[SP] emp_settings gespeichert')).catch(e=>console.warn('[SP] emp_settings Fehler:',e))}
function getEmpSetting(empId){const all=getEmpSettings();return all[empId]||{...EMP_DEFAULTS}}
function setEmpSetting(empId,data){const all=getEmpSettings();all[empId]={...EMP_DEFAULTS,...(all[empId]||{}),...data};saveEmpSettings(all)}

const DAY_LABELS={1:'Mo',2:'Di',3:'Mi',4:'Do',5:'Fr'};

function renderEmpSettings(){
  const el=$('empSettingsList');if(!el)return;
  const settings=getEmpSettings();
  el.innerHTML=EMPLOYEES.map(emp=>{
    const s=settings[emp.id]||{...EMP_DEFAULTS};
    const tageStr=(s.arbeitsTage||[1,2,3,4,5]).map(d=>DAY_LABELS[d]||d).join(', ');
    const ferienAnspruch=Math.round(s.ferienTage*(s.pensum/100)*10)/10;
    const tp=s.tempPensum||[];
    const today=todayKey();
    const activeTp=tp.find(t=>today>=t.von&&today<=t.bis);
    let badges='';
    if(s.raucher)badges+='<span style="background:var(--warning);color:#000;padding:1px 6px;border-radius:4px;font-size:.7rem">ğŸš¬ Raucher</span>';
    if(activeTp)badges+='<span style="background:var(--danger);color:#fff;padding:1px 6px;border-radius:4px;font-size:.7rem">\u26A0 '+activeTp.pensum+'% bis '+new Date(activeTp.bis).toLocaleDateString('de-CH')+(activeTp.grund?' ('+activeTp.grund+')':'')+'</span>';
    if(tp.length>0&&!activeTp){const future=tp.filter(t=>today<t.von);if(future.length)badges+='<span style="background:var(--bg-hover);padding:1px 6px;border-radius:4px;font-size:.7rem">\u23F1 Geplant: '+future[0].pensum+'% ab '+new Date(future[0].von).toLocaleDateString('de-CH')+'</span>';}
    return '<div style="padding:12px;border-bottom:1px solid var(--border)"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><strong>'+emp.name+'</strong><span style="font-size:.78rem;color:var(--text-dim)">'+emp.id+'</span></div><div style="display:flex;gap:8px;flex-wrap:wrap;font-size:.8rem;color:var(--text-dim)"><span>'+s.pensum+'%</span><span>'+s.weekHours+'h/Wo</span><span>'+tageStr+'</span><span>'+ferienAnspruch+' Ferientage</span>'+(s.ferienUebertrag?'<span style="color:var(--success)">+'+s.ferienUebertrag+' FU</span>':'')+''+(s.ueberstundenUebertrag?'<span style="color:var(--accent)">+'+s.ueberstundenUebertrag+'h \u00dc</span>':'')+'</div>'+(badges?'<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">'+badges+'</div>':'')+'<button class="btn btn-secondary btn-sm" style="margin-top:8px" onclick="openEmpEdit(\''+emp.id+'\')">Bearbeiten</button></div>'
  }).join('');
}
function openEmpEdit(empId){
  const emp=EMPLOYEES.find(e=>e.id===empId);if(!emp)return;
  const s=getEmpSetting(empId);
  const tage=s.arbeitsTage||[1,2,3,4,5];
  window._editEmpId=empId;
  window._editTempPensum=(s.tempPensum||[]).map(t=>({...t}));
  $('empEditTitle').textContent=emp.name+' ('+emp.id+')';
  $('empPensum').value=s.pensum||100;
  $('empWeekH').value=s.weekHours||42.5;
  $('empFerien').value=s.ferienTage||25;
  $('empFerienUe').value=s.ferienUebertrag||0;
  $('empUeStd').value=s.ueberstundenUebertrag||0;
  $('empYear').value=s.year||new Date().getFullYear();
  $('empRaucher').checked=!!s.raucher;
  // Set checkboxes
  [1,2,3,4,5].forEach(d=>{const cb=$('empTag'+d);if(cb)cb.checked=tage.includes(d)});
  renderTempPensumList();
  calcEmpPreview();
  $('empEditModal').classList.add('show');
}

function calcEmpPreview(){
  const pensum=parseInt($('empPensum').value)||100;
  const ferien=parseInt($('empFerien').value)||25;
  const weekH=parseFloat($('empWeekH').value)||42.5;
  const tage=[1,2,3,4,5].filter(d=>{const cb=$('empTag'+d);return cb&&cb.checked});
  const raucher=$('empRaucher').checked;
  const ferienAnspruch=Math.round(ferien*(pensum/100)*10)/10;
  const tagesH=tage.length>0?Math.round(weekH/tage.length*100)/100:0;
  const raucherAbzug=raucher?tage.length*15:0;
  const raucherH=Math.round(raucherAbzug/60*100)/100;
  const prev=$('empPreview');
  if(prev)prev.innerHTML='<div class="pause-summary"><div class="pause-row"><span>Pensum:</span><span>'+pensum+'%</span></div><div class="pause-row"><span>Arbeitstage:</span><span>'+tage.map(d=>DAY_LABELS[d]).join(', ')+'</span></div><div class="pause-row"><span>Soll/Tag:</span><span style="font-family:var(--font-mono)">'+tagesH+'h</span></div><div class="pause-row"><span>Soll/Woche:</span><span style="font-family:var(--font-mono)">'+weekH+'h</span></div>'+(raucher?'<div class="pause-row" style="color:var(--warning)"><span>ğŸš¬ Raucherabzug/Woche:</span><span style="font-family:var(--font-mono)">âˆ’'+raucherH+'h ('+raucherAbzug+' Min)</span></div>':'')+'<div class="pause-row total"><span>Ferienanspruch:</span><span>'+ferienAnspruch+' Tage</span></div></div>';
}

function saveEmpEdit(){
  const empId=window._editEmpId;if(!empId)return;
  const tage=[1,2,3,4,5].filter(d=>{const cb=$('empTag'+d);return cb&&cb.checked});
  if(!tage.length){toast('Mindestens 1 Arbeitstag','warning');return}
  // Validate temp pensum entries
  const tp=(window._editTempPensum||[]).filter(t=>t.von&&t.bis&&t.pensum);
  setEmpSetting(empId,{
    pensum:parseInt($('empPensum').value)||100,
    weekHours:parseFloat($('empWeekH').value)||42.5,
    ferienTage:parseInt($('empFerien').value)||25,
    arbeitsTage:tage,
    ferienUebertrag:parseFloat($('empFerienUe').value)||0,
    ueberstundenUebertrag:parseFloat($('empUeStd').value)||0,
    raucher:$('empRaucher').checked,
    tempPensum:tp,
    year:parseInt($('empYear').value)||new Date().getFullYear()
  });
  $('empEditModal').classList.remove('show');
  toast('Einstellungen gespeichert','success');
  renderEmpSettings();
  renderAbsences();
}

// Temp Pensum UI
function renderTempPensumList(){
  const list=$('empTempPensumList');if(!list)return;
  const tp=window._editTempPensum||[];
  if(!tp.length){list.innerHTML='<div style="font-size:.8rem;color:var(--text-dim)">Keine temporÃ¤ren Anpassungen</div>';return}
  list.innerHTML=tp.map((t,i)=>'<div style="display:flex;gap:6px;align-items:center;margin-bottom:6px;flex-wrap:wrap"><input type="date" class="form-input" style="flex:1;min-width:110px;font-size:.8rem" value="'+(t.von||'')+'" onchange="updateTempPensum('+i+',\'von\',this.value)"><span style="font-size:.8rem">â€“</span><input type="date" class="form-input" style="flex:1;min-width:110px;font-size:.8rem" value="'+(t.bis||'')+'" onchange="updateTempPensum('+i+',\'bis\',this.value)"><input type="number" class="form-input" style="width:65px;font-size:.8rem" value="'+(t.pensum||50)+'" min="0" max="100" step="5" onchange="updateTempPensum('+i+',\'pensum\',this.value)"><span style="font-size:.8rem">%</span><input type="text" class="form-input" style="flex:1;min-width:80px;font-size:.8rem" value="'+(t.grund||'')+'" placeholder="Grund..." onchange="updateTempPensum('+i+',\'grund\',this.value)"><button class="btn btn-secondary" style="padding:2px 8px;font-size:.8rem" onclick="removeTempPensum('+i+')">âœ•</button></div>').join('');
}
function addTempPensum(){
  if(!window._editTempPensum)window._editTempPensum=[];
  const today=new Date();const in2m=new Date(today);in2m.setMonth(in2m.getMonth()+2);
  window._editTempPensum.push({von:todayKey(),bis:in2m.toISOString().split('T')[0],pensum:50,grund:''});
  renderTempPensumList();
}
function updateTempPensum(i,field,val){
  if(!window._editTempPensum||!window._editTempPensum[i])return;
  window._editTempPensum[i][field]=field==='pensum'?parseInt(val):val;
}
function removeTempPensum(i){
  if(!window._editTempPensum)return;
  window._editTempPensum.splice(i,1);
  renderTempPensumList();
}

// Get effective pensum/weekHours for a specific date (considers temp pensum)
function getEffectiveSettings(empId,dateStr){
  const s=getEmpSetting(empId);
  const tp=s.tempPensum||[];
  // Check if date falls in any temp pensum period
  for(const t of tp){
    if(dateStr>=t.von&&dateStr<=t.bis){
      const ratio=t.pensum/(s.pensum||100);
      return{...s,pensum:t.pensum,weekHours:Math.round(s.weekHours*ratio*100)/100,sollStunden:Math.round(s.weekHours*ratio*100)/100,_tempActive:true,_tempGrund:t.grund};
    }
  }
  return{...s,sollStunden:s.weekHours,_tempActive:false};
}

// Get raucher abzug in minutes for a date
function getRaucherAbzug(empId){
  const s=getEmpSetting(empId);
  return s.raucher?15:0;
}

async function loadEmpSettingsFromSP(){
  if(!accessToken)return;
  try{
    const data=await SP.readFile('emp_settings.json');
    if(data&&typeof data==='object'&&Object.keys(data).length>0){
      // SP data takes priority, merge with local (SP overwrites per employee)
      const local=getEmpSettings();
      const merged={...local,...data};
      localStorage.setItem(C.LS+'emp_settings',JSON.stringify(merged));
      console.log('[SP] emp_settings geladen:',Object.keys(data).length,'MA');
      if(user&&user.admin)renderEmpSettings();
    }
  }catch(e){console.warn('EmpSettings load:',e)}
}

// ABSENCE MANAGEMENT
const ABS_TYPES={'Ferien':'ğŸ–\ufe0f','Krankheit':'ğŸ¤’','Unfall':'ğŸ¤•','Milit\u00e4r/Zivildienst':'ğŸ–\ufe0f','Mutterschaft/Vaterschaft':'ğŸ‘¶','Umzug':'ğŸ“¦','Unbezahlt':'ğŸš«','Sonstiges':'ğŸ“‹'};
const ABS_COLORS={'Ferien':'#22c55e','Krankheit':'#ef4444','Unfall':'#f97316','Milit\u00e4r/Zivildienst':'#8b5cf6','Mutterschaft/Vaterschaft':'#ec4899','Umzug':'#06b6d4','Unbezahlt':'#6b7280','Sonstiges':'#a3a3a3'};

function getAllAbsences(){try{return JSON.parse(localStorage.getItem(C.LS+'all_absences')||'[]')}catch{return[]}}
function saveAllAbsences(a){localStorage.setItem(C.LS+'all_absences',JSON.stringify(a));queueAbsSync()}
function getAbsences(){return getAllAbsences()}

let absSyncTm=null;
function queueAbsSync(){if(!accessToken)return;clearTimeout(absSyncTm);absSyncTm=setTimeout(async()=>{
  try{await SP.writeFile('Abwesenheiten/alle.json',{lastUpdated:new Date().toISOString(),absences:getAllAbsences()});console.log('[SP] Abwesenheiten gespeichert')}catch(e){console.warn('Abs sync:',e)}
},2000)}

function countWorkdays(from,to,empId){
  const empS=empId?getEmpSetting(empId):(user?getEmpSetting(user.id):{...EMP_DEFAULTS});
  const arbeitsTage=empS.arbeitsTage||[1,2,3,4,5];
  let count=0;const d=new Date(from);const end=new Date(to);
  while(d<=end){const day=d.getDay();if(arbeitsTage.includes(day)){const dk=dateKey(d);const hol=getHolidays(d.getFullYear());if(!hol[dk])count++}d.setDate(d.getDate()+1)}
  return count}

function countUniqueDates(entries){
  const s=new Set();entries.forEach(e=>{if(e.date)s.add(e.date)});return s.size;
}

// Calculate Soll-hours considering temp pensum periods
function calcSollHours(empId,from,to,s,workDays){
  const tp=s.tempPensum||[];
  const bf=getBetriebsferien();
  const entries=getEntriesForEmployee(empId,from,to);
  const entryDates=new Set(entries.map(e=>e.date));
  // Always calculate day by day to handle BF correctly
  const arbeitsTage=s.arbeitsTage||[1,2,3,4,5];
  const normalH=(s.weekHours||42.5)/arbeitsTage.length;
  let total=0;
  const d=new Date(from);const end=new Date(to);
  while(d<=end){
    const day=d.getDay();
    const dk=dateKey(d);
    if(arbeitsTage.includes(day)){
      const hol=getHolidays(d.getFullYear());
      if(!hol[dk]){
        // Check Betriebsferien: if BF and no entry, Soll=0 (Ferientag)
        const bfDay=bf.find(b=>dk>=b.from&&dk<=b.to);
        if(bfDay&&!entryDates.has(dk)){
          // BF day without work - no Soll
        }else{
          const active=tp.find(t=>dk>=t.von&&dk<=t.bis);
          if(active){
            total+=normalH*(active.pensum/(s.pensum||100));
          }else{
            total+=normalH;
          }
        }
      }
    }
    d.setDate(d.getDate()+1);
  }
  return total;
}

$('absSaveBtn').onclick=function(){
  const type=$('absType').value,from=$('absFrom').value,to=$('absTo').value,dur=$('absDuration').value,note=$('absNote').value.trim();
  if(!type){toast('Bitte Typ w\u00e4hlen','warning');return}
  if(!from||!to){toast('Zeitraum ausf\u00fcllen','warning');return}
  if(new Date(to)<new Date(from)){toast('Bis-Datum muss nach Von-Datum liegen','warning');return}
  const workdays=countWorkdays(from,to);
  const days=dur==='full'?workdays:workdays*0.5;
  const needsApproval=type==='Ferien'||type==='Unbezahlt'||type==='Sonstiges'||type==='Umzug';
  const autoApproved=type==='Krankheit'||type==='Unfall'||type==='Milit\u00e4r/Zivildienst'||type==='Mutterschaft/Vaterschaft';
  const abs={id:Date.now().toString(36)+Math.random().toString(36).slice(2,6),type:type,from:from,to:to,duration:dur,days:days,note:note,status:autoApproved?'approved':'pending',employeeId:user.id,employeeName:user.name,created:new Date().toISOString(),approvedBy:autoApproved?'Auto':null,approvedAt:autoApproved?new Date().toISOString():null};
  const all=getAllAbsences();all.push(abs);saveAllAbsences(all);
  $('absType').value='';$('absNote').value='';
  toast(needsApproval?'Antrag eingereicht - wartet auf Freigabe':'Abwesenheit gespeichert','success');
  renderAbsences();
};

function renderAbsences(){
  const abs=getAbsences().filter(a=>a.employeeId===user.id).sort((a,b)=>b.from.localeCompare(a.from));
  const year=new Date().getFullYear();
  $('absYear').textContent=year;

  // Stats
  const yearAbs=abs.filter(a=>a.from.startsWith(String(year)));
  const ferienDays=yearAbs.filter(a=>a.type==='Ferien'&&a.status==='approved').reduce((s,a)=>s+a.days,0);
  const krankDays=yearAbs.filter(a=>a.type==='Krankheit').reduce((s,a)=>s+a.days,0);
  const pendingDays=yearAbs.filter(a=>a.status==='pending').reduce((s,a)=>s+a.days,0);
  // Get employee settings for proper calculation
  const empS=user?getEmpSetting(user.id):{...EMP_DEFAULTS};
  const ferienAnspruch=Math.round(empS.ferienTage*(empS.pensum/100)*10)/10;
  const ferienTotal=ferienAnspruch+(empS.ferienUebertrag||0);
  const bfDaysOwn=user?countBetriebsferienDays(user.id,year+'-01-01',year+'-12-31'):0;
  const ferienRest=Math.round((ferienTotal-ferienDays-bfDaysOwn)*10)/10;
  $('absStats').innerHTML='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;text-align:center"><div style="background:var(--bg-surface);padding:12px;border-radius:8px"><div style="font-family:var(--font-mono);font-size:1.4rem;color:var(--success);font-weight:700">'+ferienDays+' / '+ferienTotal+'</div><div style="font-size:.72rem;color:var(--text-dim)">Ferien bezogen / Anspruch</div></div><div style="background:var(--bg-surface);padding:12px;border-radius:8px"><div style="font-family:var(--font-mono);font-size:1.4rem;color:'+(ferienRest>=0?'var(--accent)':'var(--danger)')+';font-weight:700">'+ferienRest+'</div><div style="font-size:.72rem;color:var(--text-dim)">Resttage</div></div><div style="background:var(--bg-surface);padding:12px;border-radius:8px"><div style="font-family:var(--font-mono);font-size:1.4rem;color:var(--danger);font-weight:700">'+krankDays+'</div><div style="font-size:.72rem;color:var(--text-dim)">Krankheit/Unfall</div></div><div style="background:var(--bg-surface);padding:12px;border-radius:8px"><div style="font-family:var(--font-mono);font-size:1.4rem;color:var(--warning);font-weight:700">'+pendingDays+'</div><div style="font-size:.72rem;color:var(--text-dim)">Pendent</div></div></div>'+(bfDaysOwn>0?'<div style="margin-top:8px;font-size:.8rem;color:#6366f1">\uD83C\uDFE2 Betriebsferien: <strong>'+bfDaysOwn+' Tage</strong> (vom Anspruch abgezogen)</div>':'')+(empS.ueberstundenUebertrag?'<div style="margin-top:8px;font-size:.8rem;color:var(--text-dim)">\u00dcberstunden Vortrag: <strong style="color:var(--accent)">'+empS.ueberstundenUebertrag+'h</strong></div>':'');

  // List
  if(!abs.length){$('absList').innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ–\ufe0f</div><p>Keine Abwesenheiten erfasst</p></div>';return}
  $('absList').innerHTML=abs.map(a=>{
    const icon=ABS_TYPES[a.type]||'ğŸ“‹';
    const color=ABS_COLORS[a.type]||'#666';
    const statusClass=a.status==='approved'?'approved':a.status==='rejected'?'rejected':'pending';
    const statusText=a.status==='approved'?'Genehmigt':a.status==='rejected'?'Abgelehnt':'Pendent';
    const durText=a.duration==='morning'?'(VM)':a.duration==='afternoon'?'(NM)':'';
    return '<div class="abs-card" style="border-left-color:'+color+'"><div class="entry-info"><div class="entry-time"><span class="abs-type-icon">'+icon+'</span>'+a.type+' '+durText+'</div><div class="entry-meta">'+fmtDate(a.from)+(a.from!==a.to?' \u2013 '+fmtDate(a.to):'')+' \u00b7 '+a.days+' Tag'+(a.days!==1?'e':'')+(a.note?' \u00b7 '+a.note:'')+'</div></div><div class="entry-right"><span class="abs-badge '+statusClass+'">'+statusText+'</span>'+((a.status==='pending'||(user&&(user.admin||user.approver)))?'<button class="entry-action" onclick="deleteAbsence(\''+a.id+'\')" title="L\u00f6schen">ğŸ—‘</button>':'')+'</div></div>'
  }).join('');

  // Approval section (for approvers: Dominic + Roman)
  const card=$('absApprovalCard');
  if(user&&(user.admin||user.approver)){card.style.display='block';
    const allAbs=getAllAbsences();
    const pending=allAbs.filter(a=>a.status==='pending');
    if(pending.length>0){
      card.style.display='block';
      $('absPendingList').innerHTML=pending.map(a=>{
        const icon=ABS_TYPES[a.type]||'ğŸ“‹';const color=ABS_COLORS[a.type]||'#666';
        return '<div class="abs-card" style="border-left-color:'+color+'"><div class="entry-info"><div class="entry-time"><span class="abs-type-icon">'+icon+'</span><strong>'+a.employeeName+'</strong> \u2013 '+a.type+'</div><div class="entry-meta">'+fmtDate(a.from)+(a.from!==a.to?' \u2013 '+fmtDate(a.to):'')+' \u00b7 '+a.days+' Tag'+(a.days!==1?'e':'')+(a.note?' \u00b7 '+a.note:'')+'</div></div><div class="entry-right" style="gap:4px"><button class="abs-approve-btn approve" onclick="approveAbsence(\''+a.id+'\',true)">\u2705</button><button class="abs-approve-btn reject" onclick="approveAbsence(\''+a.id+'\',false)">\u274c</button></div></div>'
      }).join('');
    }else{card.style.display='block';$('absPendingList').innerHTML='<p style="color:var(--text-dim);font-size:.85rem">Keine offenen Antr\u00e4ge</p>'}
  }else{card.style.display='none'}

  // Admin: all employees overview
  if(user&&user.admin){renderAdminAbsences()}
}

function deleteAbsence(id){
  if(!confirm('Antrag wirklich l\u00f6schen?'))return;
  const all=getAllAbsences().filter(a=>a.id!==id);saveAllAbsences(all);
  toast('Gel\u00f6scht','info');renderAbsences();
}

function approveAbsence(id,approved){
  const glob=getAllAbsences();
  const a=glob.find(x=>x.id===id);
  if(!a)return;
  a.status=approved?'approved':'rejected';
  a.approvedBy=user.name;
  a.approvedAt=new Date().toISOString();
  saveAllAbsences(glob);
  toast(approved?'Genehmigt \u2713':'Abgelehnt',approved?'success':'warning');
  renderAbsences();
}

function renderAdminAbsences(){
  const glob=getAllAbsences();
  if(!glob.length){$('adminAbsList').innerHTML='<p style="color:var(--text-dim);font-size:.85rem">Keine Abwesenheiten</p>';return}
  const byEmp={};glob.forEach(a=>{if(!byEmp[a.employeeName])byEmp[a.employeeName]=[];byEmp[a.employeeName].push(a)});
  $('adminAbsList').innerHTML=Object.entries(byEmp).map(([name,abs])=>{
    const approved=abs.filter(a=>a.status==='approved');
    const pending=abs.filter(a=>a.status==='pending');
    const ferienDays=approved.filter(a=>a.type==='Ferien').reduce((s,a)=>s+a.days,0);
    return '<div style="padding:10px 0;border-bottom:1px solid var(--border)"><div style="display:flex;justify-content:space-between"><strong>'+name+'</strong><span style="font-family:var(--font-mono);font-size:.85rem">'+ferienDays+' Ferientage'+(pending.length?' \u00b7 <span style="color:var(--warning)">'+pending.length+' pendent</span>':'')+'</span></div></div>'
  }).join('');
}

// Absence CSV export
if($('exportAbsBtn'))$('exportAbsBtn').onclick=function(){
  const glob=getAllAbsences();if(!glob.length){toast('Keine Daten','warning');return}
  let csv='\uFEFF'+'Mitarbeiter;Typ;Von;Bis;Tage;Dauer;Status;Genehmigt von;Bemerkung\n';
  glob.sort((a,b)=>a.from.localeCompare(b.from)).forEach(a=>{
    csv+=a.employeeName+';'+a.type+';'+fmtDate(a.from)+';'+fmtDate(a.to)+';'+a.days+';'+(a.duration==='full'?'Ganzer Tag':a.duration==='morning'?'VM':'NM')+';'+(a.status==='approved'?'Genehmigt':a.status==='rejected'?'Abgelehnt':'Pendent')+';'+(a.approvedBy||'')+';'+(a.note||'')+'\n'
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const el=document.createElement('a');el.href=URL.createObjectURL(blob);el.download='Abwesenheiten_'+new Date().getFullYear()+'.csv';el.click();toast('Export erstellt','success');
};

// Load absences from SharePoint
async function loadAbsencesFromSP(){
  if(!accessToken)return;
  try{
    const data=await SP.readFile('Abwesenheiten/alle.json');
    if(data&&data.absences){
      // Merge with local: keep local entries that aren't in SP, update from SP
      const local=getAllAbsences();
      const spIds=new Set(data.absences.map(a=>a.id));
      const localOnly=local.filter(a=>!spIds.has(a.id));
      const merged=[...data.absences,...localOnly];
      localStorage.setItem(C.LS+'all_absences',JSON.stringify(merged));
      console.log('[SP] Abwesenheiten geladen:',merged.length);
    }
    renderAbsences();
  }catch(e){console.warn('Abs load:',e)}
}


// â•â•â• MITARBEITER-REPORT (for admin/approver) â•â•â•
function canViewReports(){return user&&(user.admin||user.approver)}

function renderReportTab(){
  const el=$('reportContent');if(!el||!canViewReports())return;
  const empSettings=getEmpSettings();
  el.innerHTML='<div class="form-row" style="margin-bottom:16px"><div class="form-group"><label class="form-label">Mitarbeiter</label><select class="form-select" id="reportEmp"><option value="">â€” Alle â€”</option>'+EMPLOYEES.map(e=>'<option value="'+e.id+'">'+e.name+'</option>').join('')+'</select></div><div class="form-group"><label class="form-label">Zeitraum</label><select class="form-select" id="reportPeriod"><option value="month">Aktueller Monat</option><option value="quarter">Aktuelles Quartal</option><option value="year" selected>Ganzes Jahr</option><option value="custom">Benutzerdefiniert</option></select></div></div><div id="reportCustomRange" style="display:none" class="form-row"><div class="form-group"><label class="form-label">Von</label><input type="date" class="form-input" id="reportFrom"></div><div class="form-group"><label class="form-label">Bis</label><input type="date" class="form-input" id="reportTo"></div></div><div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap"><button class="btn btn-primary btn-sm" onclick="generateReport()">ğŸ“Š Report anzeigen</button><button class="btn btn-secondary btn-sm" onclick="exportReportCSV()">ğŸ“¤ CSV Export</button><button class="btn btn-secondary btn-sm" onclick="exportReportHTML()">ğŸ–¨ Druckversion</button></div><div id="reportOutput"></div>';
  $('reportPeriod').onchange=function(){$('reportCustomRange').style.display=this.value==='custom'?'grid':'none'};

  // Weekly report card
  const wrc = $('weeklyReportCard');
  if(wrc && canViewReports()) {
    wrc.style.display = 'block';
    // Set current week
    const now = new Date();
    const yr = now.getFullYear();
    const startOfYear = new Date(yr, 0, 1);
    const weekNum = Math.ceil((((now - startOfYear) / 86400000) + startOfYear.getDay() + 1) / 7);
    const wi = $('weeklyReportWeek');
    if(wi && !wi.value) wi.value = yr + '-W' + String(weekNum).padStart(2, '0');
    // Populate employee dropdown
    const sel = $('weeklyReportEmp');
    if(sel && sel.options.length <= 1) {
      EMPLOYEES.forEach(e => { const o = document.createElement('option'); o.value = e.id; o.textContent = e.name; sel.appendChild(o); });
    }
  }

}

function getReportDateRange(){
  const period=$('reportPeriod').value;
  const now=new Date();const y=now.getFullYear();const m=now.getMonth();
  let from,to;
  if(period==='month'){from=new Date(y,m,1);to=new Date(y,m+1,0)}
  else if(period==='quarter'){const q=Math.floor(m/3)*3;from=new Date(y,q,1);to=new Date(y,q+3,0)}
  else if(period==='year'){from=new Date(y,0,1);to=new Date(y,11,31)}
  else{from=new Date($('reportFrom').value||dateKey(new Date(y,0,1)));to=new Date($('reportTo').value||dateKey(now))}
  return{from:dateKey(from),to:dateKey(to),fromD:from,toD:to}
}

function generateReport(){
  const selEmp=$('reportEmp').value;
  const range=getReportDateRange();
  const emps=selEmp?EMPLOYEES.filter(e=>e.id===selEmp):EMPLOYEES;
  const allAbs=getAllAbsences();
  const empSettings=getEmpSettings();
  const allEntries=[];
  // Collect all entries from localStorage (global key) and SP
  // For each employee, try to load their data
  let html='';
  emps.forEach(emp=>{
    const s=empSettings[emp.id]||{pensum:100,weekHours:41,ferienTage:23,arbeitsTage:[1,2,3,4,5],ferienUebertrag:0,ueberstundenUebertrag:0};
    const entries=getEntriesForEmployee(emp.id,range.from,range.to);
    const absences=allAbs.filter(a=>a.employeeId===emp.id&&a.from>=range.from&&a.to<=range.to);
    // Raucher: count work days with entries and subtract 15min each
    const raucherMin=s.raucher?entries.reduce((sum,e)=>{const d=e.date;if(!sum._dates){sum._dates=new Set()}if(!sum._dates.has(d)){sum._dates.add(d);sum.val+=15}return sum},{val:0,_dates:null}).val||countUniqueDates(entries)*15:0;
    const totalMin=entries.reduce((sum,e)=>sum+(e.durationMin||0),0)-raucherMin;
    const totalH=Math.round(totalMin/6)/10;
    // Work days in range - consider temp pensum
    const workDays=countWorkdays(range.from,range.to,emp.id);
    const sollH=calcSollHours(emp.id,range.from,range.to,s,workDays);
    const diffH=Math.round((totalH-sollH)*10)/10;
    const ferienAnspruch=Math.round(s.ferienTage*(s.pensum/100)*10)/10;
    const ferienTotal=ferienAnspruch+(s.ferienUebertrag||0);
    const ferienBezogen=absences.filter(a=>a.type==='Ferien'&&a.status==='approved').reduce((sum,a)=>sum+a.days,0);
    const bfDays=countBetriebsferienDays(emp.id,range.from,range.to);
    const ferienRest=Math.round((ferienTotal-ferienBezogen-bfDays)*10)/10;
    const krankTage=absences.filter(a=>(a.type==='Krankheit'||a.type==='Unfall')&&a.status!=='rejected').reduce((sum,a)=>sum+a.days,0);
    // KS breakdown
    const ksBrk={};entries.forEach(e=>{ksBrk[e.kostenstelle]=(ksBrk[e.kostenstelle]||0)+(e.durationMin||0)});
    // Project breakdown
    const projBrk={};entries.forEach(e=>{projBrk[e.project]=(projBrk[e.project]||0)+(e.durationMin||0)});
    // Monthly breakdown
    const monthBrk={};entries.forEach(e=>{const ym=e.date.substring(0,7);monthBrk[ym]=(monthBrk[ym]||0)+(e.durationMin||0)});
    // Absence summary
    const absBrk={};absences.filter(a=>a.status!=='rejected').forEach(a=>{absBrk[a.type]=(absBrk[a.type]||0)+a.days});

    html+='<div class="card" style="border-left:3px solid var(--primary)"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div><h3 style="font-size:1.1rem;margin-bottom:2px">'+emp.name+(s.raucher?' <span style="background:var(--warning);color:#000;padding:1px 6px;border-radius:4px;font-size:.7rem">\uD83D\uDEAC</span>':'')+'</h3><span style="font-size:.78rem;color:var(--text-dim)">'+emp.id+' \u00b7 '+s.pensum+'% \u00b7 '+(s.arbeitsTage||[1,2,3,4,5]).map(d=>({1:"Mo",2:"Di",3:"Mi",4:"Do",5:"Fr"})[d]).join(", ")+'</span></div><div style="text-align:right;font-size:.78rem;color:var(--text-dim)">'+fmtDate(range.from)+' \u2013 '+fmtDate(range.to)+'</div></div>';
    const tpInRange=(s.tempPensum||[]).filter(t=>t.von<=range.to&&t.bis>=range.from);
    if(tpInRange.length>0){html+='<div style="margin-bottom:12px">';tpInRange.forEach(t=>{html+='<div style="background:rgba(239,68,68,.12);border:1px solid var(--danger);border-radius:6px;padding:8px 10px;margin-bottom:6px;font-size:.8rem">\u26A0\uFE0F <strong>Pensum-Reduktion: '+t.pensum+'%</strong> ('+fmtDate(new Date(t.von))+' \u2013 '+fmtDate(new Date(t.bis))+')'+(t.grund?' \u00b7 '+t.grund:'')+'</div>'});const normalSollH=workDays*((s.weekHours||42.5)/(s.arbeitsTage||[1,2,3,4,5]).length);html+='<div style="font-size:.78rem;color:var(--text-dim);padding:2px 0">Soll ohne Reduktion: <strong>'+Math.round(normalSollH*10)/10+'h</strong></div></div>';}
    if(s.raucher){html+='<div style="font-size:.78rem;color:var(--warning);margin-bottom:8px">\uD83D\uDEAC Raucherabzug: '+Math.round(raucherMin/60*10)/10+'h ('+countUniqueDates(entries)+' Tage \u00d7 15 Min)</div>';}
    // Stats grid
    html+='<div class="stat-grid" style="margin-bottom:16px"><div class="stat-box"><div class="stat-num" style="color:var(--primary)">'+totalH+'h</div><div class="stat-label">Ist-Stunden</div></div><div class="stat-box"><div class="stat-num" style="color:var(--text-dim)">'+Math.round(sollH*10)/10+'h</div><div class="stat-label">Soll-Stunden</div></div><div class="stat-box"><div class="stat-num" style="color:'+(diffH>=0?'var(--success)':'var(--danger)')+'">'+((diffH>=0?'+':'')+diffH)+'h</div><div class="stat-label">Saldo</div></div><div class="stat-box"><div class="stat-num" style="color:var(--accent)">'+(s.ueberstundenUebertrag||0)+'h</div><div class="stat-label">\u00dcberstunden VJ</div></div><div class="stat-box"><div class="stat-num" style="color:var(--success)">'+ferienBezogen+'/'+ferienTotal+'</div><div class="stat-label">Ferien</div></div><div class="stat-box"><div class="stat-num" style="color:'+(ferienRest>=0?'var(--accent)':'var(--danger)')+'">'+ferienRest+'</div><div class="stat-label">Ferien Rest</div></div>'+(bfDays>0?'<div class="stat-box"><div class="stat-num" style="color:#6366f1">'+bfDays+'</div><div class="stat-label">\uD83C\uDFE2 Betriebsferien</div></div>':'')+'<div class="stat-box"><div class="stat-num" style="color:var(--danger)">'+krankTage+'</div><div class="stat-label">Krankheit</div></div><div class="stat-box"><div class="stat-num">'+entries.length+'</div><div class="stat-label">Eintr\u00e4ge</div></div></div>';
    // KS breakdown
    if(Object.keys(ksBrk).length){html+='<div style="margin-bottom:12px"><div style="font-size:.75rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;margin-bottom:8px">Kostenstellen</div>';Object.entries(ksBrk).sort((a,b)=>b[1]-a[1]).forEach(([k,m])=>{const pct=totalMin>0?Math.round(m/totalMin*100):0;html+='<div class="stat-bar-item"><div class="stat-bar-label">'+k+'</div><div class="stat-bar-track"><div class="stat-bar-fill" style="width:'+pct+'%;background:'+({"B\u00fcro":"#3b82f6","Zuschnitt":"#8b5cf6","BAZ":"#06b6d4","Werkstatt":"#22c55e","Montage":"#FF6B35"}[k]||"#666")+'"></div></div><div class="stat-bar-value">'+(Math.round(m/6)/10)+'h</div></div>'});html+='</div>'}
    // Top projects
    const topProj=Object.entries(projBrk).sort((a,b)=>b[1]-a[1]).slice(0,10);
    if(topProj.length){html+='<div style="margin-bottom:12px"><div style="font-size:.75rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;margin-bottom:8px">Top Projekte</div>';topProj.forEach(([p,m])=>{html+='<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:.82rem;border-bottom:1px solid var(--border)"><span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%">'+p+'</span><span style="font-family:var(--font-mono);color:var(--accent)">'+(Math.round(m/6)/10)+'h</span></div>'});html+='</div>'}
    // Monthly breakdown
    const months=Object.entries(monthBrk).sort();
    if(months.length>1){html+='<div style="margin-bottom:12px"><div style="font-size:.75rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;margin-bottom:8px">Monats\u00fcbersicht</div>';months.forEach(([ym,m])=>{const [yr,mo]=ym.split('-');html+='<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:.82rem;border-bottom:1px solid var(--border)"><span>'+MO[parseInt(mo)-1]+' '+yr+'</span><span style="font-family:var(--font-mono)">'+(Math.round(m/6)/10)+'h</span></div>'});html+='</div>'}
    // Absence summary
    if(Object.keys(absBrk).length){html+='<div><div style="font-size:.75rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;margin-bottom:8px">Abwesenheiten</div>';Object.entries(absBrk).forEach(([t,d])=>{html+='<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:.82rem;border-bottom:1px solid var(--border)"><span>'+t+'</span><span style="font-family:var(--font-mono)">'+d+' Tage</span></div>'});html+='</div>'}
    html+='</div>';
  });
  $('reportOutput').innerHTML=html||'<div class="empty-state"><div class="empty-icon">ğŸ“Š</div><p>Keine Daten im gew\u00e4hlten Zeitraum</p></div>';
}

function getEntriesForEmployee(empId,from,to){
  const emp=EMPLOYEES.find(e=>e.id===empId);if(!emp)return[];
  const key=C.LS+empId+'_entries';
  try{
    const data=JSON.parse(localStorage.getItem(key)||'[]');
    return data.filter(e=>e.date>=from&&e.date<=to);
  }catch{return[]}
}

// Save another employee's entries to SharePoint
function syncEmpEntriesToSP(empId){
  if(!accessToken)return;
  const emp=EMPLOYEES.find(e=>e.id===empId);if(!emp)return;
  const key=C.LS+empId+'_entries';
  try{
    const all=JSON.parse(localStorage.getItem(key)||'[]');
    const fn='Mitarbeiter/'+emp.name.replace(/\s/g,'_')+'_'+new Date().getFullYear()+'.json';
    SP.writeFile(fn,{employee:emp.name,employeeId:empId,lastUpdated:new Date().toISOString(),year:new Date().getFullYear(),entries:all})
      .then(()=>console.log('[SP] EintrÃ¤ge gespeichert fÃ¼r:',emp.name))
      .catch(e=>console.warn('[SP] EintrÃ¤ge Fehler fÃ¼r',emp.name,':',e));
  }catch(e){console.warn('syncEmpEntries:',e)}
}

// Load all employees' entries from SP (for admin/reports)
async function loadAllEntriesFromSP(){
  if(!accessToken)return;
  const year=new Date().getFullYear();
  for(const emp of EMPLOYEES){
    try{
      const fn='Mitarbeiter/'+emp.name.replace(/\s/g,'_')+'_'+year+'.json';
      const data=await SP.readFile(fn);
      if(data&&Array.isArray(data.entries)){
        const key=C.LS+emp.id+'_entries';
        const local=JSON.parse(localStorage.getItem(key)||'[]');
        const localIds=new Set(local.map(e=>e.id));
        const spIds=new Set(data.entries.map(e=>e.id));
        // SP has priority, add local-only entries
        const localOnly=local.filter(e=>!spIds.has(e.id));
        const merged=[...data.entries,...localOnly];
        localStorage.setItem(key,JSON.stringify(merged));
      }
    }catch(e){/* skip - file might not exist */}
  }
  console.log('[SP] Alle MA-EintrÃ¤ge geladen');
  refreshView();
}

function exportReportCSV(){
  const selEmp=$('reportEmp').value;
  const range=getReportDateRange();
  const emps=selEmp?EMPLOYEES.filter(e=>e.id===selEmp):EMPLOYEES;
  const allAbs=getAllAbsences();
  const empSettings=getEmpSettings();
  let csv='\uFEFF'+'Mitarbeiter;MA-Nr;Pensum;Raucher;Soll-h/Wo;Ist-Stunden;Raucherabzug;Soll-Stunden;Saldo;Ferien Anspruch;Ferien bezogen;Ferien Rest;Ferien VJ;\u00dcberstunden VJ;Krankheit Tage;Eintr\u00e4ge\n';
  emps.forEach(emp=>{
    const s=empSettings[emp.id]||{pensum:100,weekHours:41,ferienTage:23,arbeitsTage:[1,2,3,4,5],ferienUebertrag:0,ueberstundenUebertrag:0};
    const entries=getEntriesForEmployee(emp.id,range.from,range.to);
    const absences=allAbs.filter(a=>a.employeeId===emp.id&&a.from>=range.from&&a.to<=range.to);
    const raucherMin=s.raucher?countUniqueDates(entries)*15:0;
    const totalMin=entries.reduce((sum,e)=>sum+(e.durationMin||0),0)-raucherMin;
    const totalH=Math.round(totalMin/6)/10;
    const workDays=countWorkdays(range.from,range.to,emp.id);
    const sollH=Math.round(calcSollHours(emp.id,range.from,range.to,s,workDays)*10)/10;
    const ferienAnspruch=Math.round(s.ferienTage*(s.pensum/100)*10)/10+(s.ferienUebertrag||0);
    const ferienBez=absences.filter(a=>a.type==='Ferien'&&a.status==='approved').reduce((sum,a)=>sum+a.days,0);
    const krankT=absences.filter(a=>(a.type==='Krankheit'||a.type==='Unfall')).reduce((sum,a)=>sum+a.days,0);
    csv+=emp.name+';'+emp.id+';'+s.pensum+'%;'+(s.raucher?'Ja':'Nein')+';'+s.weekHours+';'+totalH+';'+Math.round(raucherMin/60*10)/10+';'+sollH+';'+Math.round((totalH-sollH)*10)/10+';'+ferienAnspruch+';'+ferienBez+';'+Math.round((ferienAnspruch-ferienBez)*10)/10+';'+(s.ferienUebertrag||0)+';'+(s.ueberstundenUebertrag||0)+';'+krankT+';'+entries.length+'\n';
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download='Mitarbeiter_Report_'+$('reportPeriod').value+'.csv';a.click();
  toast('CSV exportiert','success');
}


// ==================== WOCHENREPORT ====================




function showWeeklyReports() {
  if(!user || (!user.admin && !user.approver)) return;

  const weekInput = $('weeklyReportWeek');
  let weekStart;
  if(weekInput && weekInput.value) {
    const parts = weekInput.value.split('-W');
    const year = parseInt(parts[0]);
    const week = parseInt(parts[1]);
    const jan4 = new Date(year, 0, 4);
    weekStart = new Date(jan4);
    weekStart.setDate(jan4.getDate() - ((jan4.getDay()+6)%7) + (week-1)*7);
  } else {
    const now = new Date();
    weekStart = new Date(now);
    weekStart.setDate(now.getDate() - ((now.getDay()+6)%7));
  }
  weekStart.setHours(0,0,0,0);

  const empFilter = $('weeklyReportEmp')?.value || 'all';
  const container = $('weeklyReportResult');
  if(!container) return;

  const emps = empFilter === 'all' ? EMPLOYEES : EMPLOYEES.filter(e=>e.id===empFilter);
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate()+6);
  const fromStr = weekStart.toISOString().split('T')[0];
  const toStr = weekEnd.toISOString().split('T')[0];

  // Use same approach as working generateReport: getEntriesForEmployee (localStorage)
  let html = '';
  emps.forEach(emp => {
    const entries = getEntriesForEmployee(emp.id, fromStr, toStr);
    const empSettings = getEmpSetting(emp.id) || {pensum:100, sollStunden:41, weekHours:42.5, arbeitsTage:[1,2,3,4,5]};
    const workDays = empSettings.arbeitsTage || [1,2,3,4,5];
    const isRaucher = !!empSettings.raucher;
    // Calculate Soll considering temp pensum
    const sollWeek = calcSollHours(emp.id, fromStr, toStr, empSettings, countWorkdays(fromStr, toStr, emp.id));

    // Build days
    const days = {};
    for(let i=0;i<7;i++){
      const d = new Date(weekStart);
      d.setDate(weekStart.getDate()+i);
      const key = d.toISOString().split('T')[0];
      days[key] = {date:key, dow:d.getDay(), entries:[], totalHours:0, warnings:[]};
    }

    entries.forEach(e => {
      if(days[e.date]) {
        days[e.date].entries.push(e);
        days[e.date].totalHours += (e.hours || (e.durationMin ? e.durationMin/60 : 0));
      }
    });

    // Apply raucher abzug per day
    if(isRaucher){
      Object.values(days).forEach(day => {
        if(day.entries.length > 0) day.totalHours -= 0.25; // 15 min
      });
    }

    // Analyze warnings
    Object.values(days).forEach(day => {
      const bf=isBetriebsferien(day.date);
      if(day.entries.length === 0) {
        if(bf){
          day.warnings.push({type:'info', msg:'\uD83C\uDFE2 '+bf.label+' ('+bf.type+') \u2013 Ferientag'});
          day._isBF=true;
        } else if(workDays.includes(day.dow)){
          day.warnings.push({type:'info', msg:'Kein Eintrag (Arbeitstag)'});
        }
        return;
      }
      if(bf){
        day.warnings.push({type:'info', msg:'\u2139\uFE0F '+bf.label+' \u2013 MA hat gearbeitet (kein Ferienabzug)'});
      }
      let hasZnueni = false, hasMittag = false;
      day.entries.forEach(e => {
        if(e.pauseZnueni || e.znueniPause) hasZnueni = true;
        if(e.pauseMittag && e.pauseMittag !== 'none' && e.pauseMittag !== 'durchgearbeitet') hasMittag = true;
        if(e.mittagsPause && e.mittagsPause !== 'none' && e.mittagsPause !== 'durchgearbeitet') hasMittag = true;
      });
      if(day.totalHours > 6 && !hasMittag) day.warnings.push({type:'warn', msg:'Keine Mittagspause bei >6h Arbeit'});
      if(!hasZnueni && day.totalHours > 2) day.warnings.push({type:'warn', msg:'Keine Zn\u00fcni-Pause erfasst'});
      if(day.totalHours > 10) day.warnings.push({type:'warn', msg:'\u00dcber 10h Arbeitszeit'});
    });

    // Render
    const fmtD = d => new Date(d).toLocaleDateString('de-CH',{weekday:'short',day:'2-digit',month:'2-digit',year:'numeric'});
    const fmtH = h => h.toFixed(2).replace('.',',') + 'h';
    const weekLabel = fmtD(weekStart) + ' \u2013 ' + fmtD(weekEnd);
    let totalWeekH = 0, totalWarn = 0;

    // Check for temp pensum in this week
    const tp=empSettings.tempPensum||[];
    const activeTp=tp.filter(t=>t.von<=toStr&&t.bis>=fromStr);
    let tpBanner='';
    if(activeTp.length>0){
      activeTp.forEach(t=>{
        const normalWeekH=empSettings.weekHours||42.5;
        tpBanner+='<div style="background:rgba(239,68,68,.15);border:1px solid var(--danger);border-radius:8px;padding:10px 12px;margin-bottom:12px;font-size:.82rem">';
        tpBanner+='\u26A0\uFE0F <strong>Reduziertes Pensum: '+t.pensum+'%</strong> ('+fmtDate(new Date(t.von))+' \u2013 '+fmtDate(new Date(t.bis))+')'+(t.grund?' \u00b7 Grund: '+t.grund:'');
        tpBanner+='<br>Soll diese Woche: <strong>'+fmtH(sollWeek)+'</strong> statt '+fmtH(normalWeekH);
        tpBanner+='</div>';
      });
    }

    html += '<div class="weekly-report">';
    html += '<div class="report-header"><h3>\uD83D\uDCCB ' + emp.name + '</h3><div class="report-period">' + weekLabel + (isRaucher?' <span style="background:var(--warning);color:#000;padding:1px 6px;border-radius:4px;font-size:.7rem">\uD83D\uDEAC Raucher</span>':'') + '</div></div>';
    html += tpBanner;

    Object.values(days).forEach(day => {
      if(day.dow === 0 || day.dow === 6) return;
      totalWeekH += day.totalHours;
      totalWarn += day.warnings.filter(w=>w.type==='warn').length;
      const dayLabel = ['So','Mo','Di','Mi','Do','Fr','Sa'][day.dow] + ' ' + new Date(day.date).toLocaleDateString('de-CH',{day:'2-digit',month:'2-digit'});
      const dayTpActive = tp.find(t=>day.date>=t.von&&day.date<=t.bis);
      html += '<div class="report-day' + (day.warnings.some(w=>w.type==='warn')?' has-warning':'') + '">';
      html += '<div class="report-day-header"><span class="report-day-name">' + dayLabel + (dayTpActive?' <span style="color:var(--danger);font-size:.72rem;font-weight:400">(reduziert '+dayTpActive.pensum+'%)</span>':'') + '</span><span class="report-day-hours">' + fmtH(day.totalHours) + '</span></div>';

      if(day.entries.length > 0) {
        day.entries.sort((a,b)=>(a.start||'').localeCompare(b.start||'')).forEach(e => {
          const proj = e.projectName || e.project || '-';
          const ks = e.costCenter || '-';
          const zeit = (e.start||'?') + '\u2013' + (e.end||'?');
          let pause = '';
          if(e.pauseZnueni || e.znueniPause) pause += 'Zn\u00fcni \u2713 ';
          if(e.pauseMittag && e.pauseMittag !== 'none') pause += 'Mittag: ' + (e.pauseMittag==='60min'?'1h':e.pauseMittag==='30min'?'30min':'durchgearbeitet') + ' ';
          if(e.mittagsPause && e.mittagsPause !== 'none') pause += 'Mittag: ' + (e.mittagsPause==='60min'?'1h':e.mittagsPause==='30min'?'30min':'durchgearbeitet') + ' ';
          if(e.breakMinutes) pause += '(Pause: ' + e.breakMinutes + 'min)';
          if(!pause) pause = '<span class="text-dim">Keine Pauseninfo</span>';
          html += '<div class="report-entry"><div class="report-entry-time">' + zeit + '</div>';
          html += '<div class="report-entry-detail">' + proj + ' <span class="text-dim">\u00b7 ' + ks + '</span></div>';
          html += '<div class="report-entry-pause">\u2615 ' + pause + '</div>';
          if(e.note) html += '<div class="report-entry-note">\uD83D\uDCDD ' + e.note + '</div>';
          html += '</div>';
        });
      } else {
        html += '<div class="report-entry empty">Keine Eintr\u00e4ge</div>';
      }
      day.warnings.forEach(w => {
        html += '<div class="report-warning ' + w.type + '">' + (w.type==='warn'?'\u26A0\uFE0F':'\u2139\uFE0F') + ' ' + w.msg + '</div>';
      });
      html += '</div>';
    });

    const saldo = totalWeekH - sollWeek;
    html += '<div class="report-summary">';
    html += '<div class="report-sum-row"><span>Total Woche:</span><strong>' + fmtH(totalWeekH) + '</strong></div>';
    if(isRaucher) html += '<div class="report-sum-row" style="color:var(--warning)"><span>\uD83D\uDEAC Raucherabzug:</span><span>âˆ’' + fmtH(Object.values(days).filter(d=>d.entries.length>0).length*0.25) + '</span></div>';
    html += '<div class="report-sum-row"><span>Soll-Stunden:</span><span>' + fmtH(sollWeek) + '</span></div>';
    if(activeTp.length>0){const normalWeekH=empSettings.weekHours||42.5;html+='<div class="report-sum-row" style="font-size:.78rem;color:var(--text-dim)"><span>Soll ohne Reduktion:</span><span>'+fmtH(normalWeekH)+'</span></div>';}
    html += '<div class="report-sum-row ' + (saldo>=0?'positive':'negative') + '"><span>Saldo:</span><strong>' + (saldo>=0?'+':'') + fmtH(saldo) + '</strong></div>';
    if(totalWarn > 0) html += '<div class="report-sum-row warn"><span>\u26A0\uFE0F Warnungen:</span><strong>' + totalWarn + '</strong></div>';
    html += '</div></div>';
  });

  container.innerHTML = html || '<div class="empty-state"><p>Keine Daten f\u00fcr diese Woche</p></div>';
}







function exportReportHTML(){
  const output=$('reportOutput');if(!output||!output.innerHTML){toast('Zuerst Report anzeigen','warning');return}
  const range=getReportDateRange();
  const printHTML='<!DOCTYPE html><html><head><meta charset="utf-8"><title>Mitarbeiter-Report</title><style>body{font-family:Arial,sans-serif;max-width:900px;margin:0 auto;padding:20px;color:#333}h1{font-size:1.3rem;border-bottom:2px solid #FF6B35;padding-bottom:8px}.card{border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px;page-break-inside:avoid;border-left:3px solid #FF6B35}.stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px}.stat-box{background:#f8f9fa;padding:10px;border-radius:6px;text-align:center}.stat-num{font-size:1.2rem;font-weight:700}.stat-label{font-size:.7rem;color:#666}.stat-bar-item{display:flex;align-items:center;gap:8px;margin-bottom:6px}.stat-bar-label{width:80px;font-size:.8rem}.stat-bar-track{flex:1;height:8px;background:#eee;border-radius:4px;overflow:hidden}.stat-bar-fill{height:100%;border-radius:4px}.stat-bar-value{width:50px;text-align:right;font-size:.8rem;font-weight:600}@media print{.card{break-inside:avoid}}</style></head><body><h1>\u23f1 Mitarbeiter-Report &mdash; Hubler Metallbau AG</h1><p style="color:#666;margin-bottom:20px">'+fmtDate(range.from)+' &ndash; '+fmtDate(range.to)+' &bull; Erstellt am '+fmtDate(dateKey(new Date()))+'</p>'+output.innerHTML+'</body></html>';
  const blob=new Blob([printHTML],{type:'text/html;charset=utf-8'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='Mitarbeiter_Report_'+fmtDate(range.from).replace(/\./g,'-')+'_'+fmtDate(range.to).replace(/\./g,'-')+'.html';
  a.click();toast('Report heruntergeladen - im Browser \u00f6ffnen und drucken','success');
}

// INIT
$('logoutBtn').onclick=logout;setupAC('timerProject','timerProjectAC');setupAC('manProject','manProjectAC');initLogin();

// ==================== MA-EDITIEREN ====================
let _maeEmpId=null,_maeMonth=null,_maeEntries=[],_maeEditId=null,_maeAbsEditId=null,_maeImportData=[];

function initMAEdit(){
  const sel=$('maeEmp');if(!sel)return;
  sel.innerHTML='<option value="">â€” Mitarbeiter wÃ¤hlen â€”</option>'+getActiveEmployees().map(e=>'<option value="'+e.id+'">'+e.name+'</option>').join('');
  const mi=$('maeMonth');if(mi&&!mi.value){const now=new Date();mi.value=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')}
  // Autocomplete for edit modal
  setupAC('maeEditProject','maeEditProjectAC');
}

function maeLoad(){
  _maeEmpId=$('maeEmp').value;
  _maeMonth=$('maeMonth').value;
  if(!_maeEmpId){toast('Mitarbeiter wÃ¤hlen','warning');return}
  if(!_maeMonth){toast('Monat wÃ¤hlen','warning');return}
  const [yr,mo]=_maeMonth.split('-');
  const from=yr+'-'+mo+'-01';
  const lastDay=new Date(parseInt(yr),parseInt(mo),0).getDate();
  const to=yr+'-'+mo+'-'+String(lastDay).padStart(2,'0');
  const emp=EMPLOYEES.find(e=>e.id===_maeEmpId);

  // Load entries
  _maeEntries=getEntriesForEmployee(_maeEmpId,from,to);
  const $e=$('maeEntries');$e.style.display='block';
  $('maeEntriesTitle').textContent=(emp?emp.name:_maeEmpId)+' â€“ '+MO[parseInt(mo)-1]+' '+yr+' ('+_maeEntries.length+' EintrÃ¤ge)';

  // Render entries table
  let html='<table class="mae-table"><thead><tr><th>Datum</th><th>Start</th><th>Ende</th><th>Projekt</th><th>KS</th><th>Pause</th><th>Stunden</th><th>Aktion</th></tr></thead><tbody>';
  _maeEntries.sort((a,b)=>(a.date+a.startTime).localeCompare(b.date+b.startTime)).forEach(e=>{
    const dur=e.durationMin?fmtH(e.durationMin):(e.hours?e.hours.toFixed(2).replace('.',',')+'h':'?');
    let pause='';
    if(e.pauseZnueni||e.znueniPause)pause+='Z ';
    if(e.pauseMittag&&e.pauseMittag!=='none')pause+=(e.pauseMittag==='60min'?'M1h':'M30');
    else if(e.mittagsPause&&e.mittagsPause!=='none')pause+=(e.mittagsPause==='60min'?'M1h':'M30');
    if(!pause)pause='-';
    html+='<tr><td>'+new Date(e.date).toLocaleDateString('de-CH',{day:'2-digit',month:'2-digit'})+'</td><td>'+(e.startTime||e.start||'-')+'</td><td>'+(e.endTime||e.end||'-')+'</td><td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+(e.project||'')+'">'+(e.project||'-')+'</td><td>'+(e.kostenstelle||e.costCenter||'-')+'</td><td>'+pause+'</td><td style="font-family:var(--font-mono)">'+dur+'</td><td class="mae-actions"><button onclick="maeEditEntry(\''+e.id+'\')" title="Bearbeiten">âœï¸</button><button onclick="maeDeleteEntry(\''+e.id+'\')" title="LÃ¶schen">ğŸ—‘</button></td></tr>';
  });
  html+='</tbody></table>';
  if(!_maeEntries.length)html='<div class="empty-state" style="padding:20px"><p>Keine EintrÃ¤ge in diesem Monat</p></div>';
  $('maeEntriesList').innerHTML=html;

  // Load absences
  const allAbs=getAllAbsences();
  const empAbs=allAbs.filter(a=>a.employeeId===_maeEmpId&&a.from<=to&&a.to>=from);
  const $a=$('maeAbsences');$a.style.display='block';
  let ahtml='<table class="mae-table"><thead><tr><th>Zeitraum</th><th>Typ</th><th>Tage</th><th>Dauer</th><th>Status</th><th>Aktion</th></tr></thead><tbody>';
  empAbs.forEach(a=>{
    const statusCls=a.status==='approved'?'color:var(--success)':a.status==='rejected'?'color:var(--danger)':'color:var(--warning)';
    const statusTxt=a.status==='approved'?'Genehmigt':a.status==='rejected'?'Abgelehnt':'Pendent';
    const durTxt=a.duration==='morning'?'VM':a.duration==='afternoon'?'NM':'Ganztag';
    ahtml+='<tr><td>'+fmtDate(a.from)+(a.from!==a.to?' â€“ '+fmtDate(a.to):'')+'</td><td>'+a.type+'</td><td>'+a.days+'</td><td>'+durTxt+'</td><td style="'+statusCls+'">'+statusTxt+'</td><td class="mae-actions"><button onclick="maeEditAbsence(\''+a.id+'\')" title="Bearbeiten">âœï¸</button><button onclick="maeDeleteAbsence(\''+a.id+'\')" title="LÃ¶schen">ğŸ—‘</button></td></tr>';
  });
  ahtml+='</tbody></table>';
  if(!empAbs.length)ahtml='<div class="empty-state" style="padding:20px"><p>Keine Abwesenheiten</p></div>';
  $('maeAbsencesList').innerHTML=ahtml;
}

// Edit entry
function maeEditEntry(id){
  const e=_maeEntries.find(x=>x.id===id);if(!e)return;
  _maeEditId=id;
  $('maeEditTitle').textContent='Eintrag bearbeiten';
  $('maeEditDate').value=e.date||'';
  $('maeEditStart').value=e.startTime||e.start||'';
  $('maeEditEnd').value=e.endTime||e.end||'';
  $('maeEditProject').value=e.project||'';
  $('maeEditKS').value=e.kostenstelle||e.costCenter||'';
  $('maeEditZnueni').checked=!!(e.pauseZnueni||e.znueniPause);
  $('maeEditMittag').value=e.pauseMittag||e.mittagsPause||'60min';
  $('maeEditNote').value=e.bemerkung||e.note||'';
  $('maeEditModal').classList.add('show');
}

function maeSaveEdit(){
  const id=_maeEditId;
  const dt=$('maeEditDate').value,st=$('maeEditStart').value,en=$('maeEditEnd').value;
  const pr=$('maeEditProject').value.trim(),ks=$('maeEditKS').value;
  if(!dt||!st||!en||!pr||!ks){toast('Alle Pflichtfelder ausfÃ¼llen','warning');return}
  const sM=timeToMin(st),eM=timeToMin(en);
  if(eM<=sM){toast('Endzeit nach Startzeit','warning');return}
  const hasZnueni=$('maeEditZnueni').checked;
  const mittagVal=$('maeEditMittag').value;
  let p=0;if(hasZnueni)p+=15;if(mittagVal==='60min')p+=60;else if(mittagVal==='30min')p+=30;
  const brutto=eM-sM;
  const upd={date:dt,start:st,end:en,startTime:st,endTime:en,project:pr,projectName:pr,kostenstelle:ks,costCenter:ks,bemerkung:$('maeEditNote').value.trim(),note:$('maeEditNote').value.trim(),pauseMin:p,durationMin:brutto-p,hours:(brutto-p)/60,pauseZnueni:hasZnueni,znueniPause:hasZnueni,pauseMittag:mittagVal,mittagsPause:mittagVal,breakMinutes:p,editedBy:user.name,editedAt:new Date().toISOString()};

  if(id){
    // Update existing - need to load correct user's entries
    const empKey=C.LS+_maeEmpId+'_entries';
    try{
      const all=JSON.parse(localStorage.getItem(empKey)||'[]');
      const i=all.findIndex(e=>e.id===id);
      if(i>=0){all[i]={...all[i],...upd};localStorage.setItem(empKey,JSON.stringify(all));toast('Eintrag aktualisiert','success')}
      else{toast('Eintrag nicht gefunden','error')}
    }catch(e){toast('Fehler: '+e.message,'error')}
  }else{
    // New entry
    upd.id=Date.now().toString(36)+Math.random().toString(36).slice(2,6);
    upd.created=new Date().toISOString();
    upd.createdBy=user.name;
    const empKey=C.LS+_maeEmpId+'_entries';
    try{
      const all=JSON.parse(localStorage.getItem(empKey)||'[]');
      all.push(upd);localStorage.setItem(empKey,JSON.stringify(all));
      toast('Eintrag hinzugefÃ¼gt','success');
    }catch(e){toast('Fehler: '+e.message,'error')}
  }
  $('maeEditModal').classList.remove('show');
  _maeEditId=null;
  syncEmpEntriesToSP(_maeEmpId);
  maeLoad();
}

function maeDeleteEntry(id){
  if(!confirm('Eintrag wirklich lÃ¶schen?'))return;
  const empKey=C.LS+_maeEmpId+'_entries';
  try{
    let all=JSON.parse(localStorage.getItem(empKey)||'[]');
    all=all.filter(e=>e.id!==id);
    localStorage.setItem(empKey,JSON.stringify(all));
    syncEmpEntriesToSP(_maeEmpId);
    toast('Eintrag gelÃ¶scht','success');
    maeLoad();
  }catch(e){toast('Fehler','error')}
}

function maeAddEntry(){
  if(!_maeEmpId){toast('Zuerst Mitarbeiter laden','warning');return}
  _maeEditId=null;
  $('maeEditTitle').textContent='Neuer Eintrag fÃ¼r '+EMPLOYEES.find(e=>e.id===_maeEmpId)?.name;
  $('maeEditDate').value=_maeMonth+'-01';
  $('maeEditStart').value='07:00';
  $('maeEditEnd').value='17:00';
  $('maeEditProject').value='';
  $('maeEditKS').value='';
  $('maeEditZnueni').checked=true;
  $('maeEditMittag').value='60min';
  $('maeEditNote').value='';
  $('maeEditModal').classList.add('show');
}

// Absences edit
function maeEditAbsence(id){
  const allAbs=getAllAbsences();
  const a=allAbs.find(x=>x.id===id);if(!a)return;
  _maeAbsEditId=id;
  $('maeAbsType').value=a.type||'Ferien';
  $('maeAbsFrom').value=a.from;
  $('maeAbsTo').value=a.to;
  $('maeAbsDuration').value=a.duration||'full';
  $('maeAbsStatus').value=a.status||'pending';
  $('maeAbsNote').value=a.note||'';
  $('maeAbsEditModal').classList.add('show');
}

function maeSaveAbsEdit(){
  const type=$('maeAbsType').value,from=$('maeAbsFrom').value,to=$('maeAbsTo').value;
  const dur=$('maeAbsDuration').value,status=$('maeAbsStatus').value,note=$('maeAbsNote').value.trim();
  if(!from||!to){toast('Zeitraum ausfÃ¼llen','warning');return}
  const workdays=countWorkdays(from,to,_maeEmpId);
  const days=dur==='full'?workdays:workdays*0.5;
  const allAbs=getAllAbsences();

  if(_maeAbsEditId){
    const i=allAbs.findIndex(a=>a.id===_maeAbsEditId);
    if(i>=0){allAbs[i]={...allAbs[i],type,from,to,duration:dur,status,note,days,editedBy:user.name,editedAt:new Date().toISOString()};saveAllAbsences(allAbs);toast('Abwesenheit aktualisiert','success')}
  }else{
    const emp=EMPLOYEES.find(e=>e.id===_maeEmpId);
    allAbs.push({id:Date.now().toString(36)+Math.random().toString(36).slice(2,6),employeeId:_maeEmpId,employeeName:emp?emp.name:'',type,from,to,duration:dur,status,note,days,created:new Date().toISOString(),createdBy:user.name});
    saveAllAbsences(allAbs);toast('Abwesenheit hinzugefÃ¼gt','success');
  }
  $('maeAbsEditModal').classList.remove('show');
  _maeAbsEditId=null;
  maeLoad();
}

function maeDeleteAbsence(id){
  if(!confirm('Abwesenheit wirklich lÃ¶schen?'))return;
  let allAbs=getAllAbsences();
  allAbs=allAbs.filter(a=>a.id!==id);
  saveAllAbsences(allAbs);
  toast('Abwesenheit gelÃ¶scht','success');
  maeLoad();
}

function maeAddAbsence(){
  if(!_maeEmpId){toast('Zuerst Mitarbeiter laden','warning');return}
  _maeAbsEditId=null;
  $('maeAbsType').value='Ferien';
  $('maeAbsFrom').value=_maeMonth+'-01';
  $('maeAbsTo').value=_maeMonth+'-01';
  $('maeAbsDuration').value='full';
  $('maeAbsStatus').value='pending';
  $('maeAbsNote').value='';
  $('maeAbsEditModal').classList.add('show');
}

// ==================== CSV IMPORT ====================
function maeShowImport(){
  if(!_maeEmpId){toast('Zuerst Mitarbeiter laden','warning');return}
  $('maeImportArea').style.display='block';
  $('maeCSVFile').value='';
  $('maeImportPreview').innerHTML='<p style="color:var(--text-dim);font-size:.82rem">CSV-Datei auswÃ¤hlen (Format: Datum;Start;Ende;Projekt;Kostenstelle;Bemerkung;ZnÃ¼ni;Mittagspause)</p>';
  $('maeImportBtn').style.display='none';
}

function maeDownloadTemplate(){
  const bom='\uFEFF';
  const header='Datum;Start;Ende;Projekt;Kostenstelle;Bemerkung;Znueni;Mittagspause\n';
  const ex1='10.02.2026;07:00;17:00;24-123 Kunde AG GelÃ¤nder;Werkstatt;GelÃ¤nder montiert;Ja;60min\n';
  const ex2='11.02.2026;07:00;12:00;24-456 Projekt B;Montage;;Ja;durchgearbeitet\n';
  const ex3='12.02.2026;06:30;16:30;24-789 Stahl AG;BAZ;CNC FrÃ¤sen;Nein;30min\n';
  const blob=new Blob([bom+header+ex1+ex2+ex3],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='Zeiterfassung_Import_Vorlage.csv';a.click();
  toast('Vorlage heruntergeladen','success');
}

function maeParseCSV(){
  const file=$('maeCSVFile').files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(ev){
    const lines=ev.target.result.split('\n').filter(l=>l.trim());
    if(lines.length<2){$('maeImportPreview').innerHTML='<p style="color:var(--danger)">CSV leer oder ungÃ¼ltig</p>';return}
    // Parse header
    const hdr=lines[0].split(';').map(h=>h.trim().toLowerCase().replace(/[^a-z0-9Ã¤Ã¶Ã¼]/g,''));
    const data=[];
    const existingEntries=getEntriesForEmployee(_maeEmpId,'2000-01-01','2099-12-31');

    for(let i=1;i<lines.length;i++){
      const cols=lines[i].split(';').map(c=>c.trim());
      if(cols.length<4)continue;
      const raw={datum:cols[0]||'',start:cols[1]||'',ende:cols[2]||'',projekt:cols[3]||'',ks:cols[4]||'',bemerkung:cols[5]||'',znueni:cols[6]||'Ja',mittag:cols[7]||'60min'};

      // Parse date (DD.MM.YYYY or YYYY-MM-DD)
      let dateStr='';
      if(raw.datum.includes('.')){const p=raw.datum.split('.');if(p.length===3)dateStr=p[2]+'-'+p[1].padStart(2,'0')+'-'+p[0].padStart(2,'0')}
      else dateStr=raw.datum;

      // Validate
      const errors=[];
      if(!dateStr||isNaN(new Date(dateStr).getTime()))errors.push('UngÃ¼ltiges Datum');
      if(!raw.start.match(/^\d{1,2}:\d{2}$/))errors.push('Start ungÃ¼ltig');
      if(!raw.ende.match(/^\d{1,2}:\d{2}$/))errors.push('Ende ungÃ¼ltig');
      if(!raw.projekt)errors.push('Projekt fehlt');
      if(!raw.ks)errors.push('Kostenstelle fehlt');

      // Check duplicate
      const isDup=existingEntries.some(e=>e.date===dateStr&&(e.startTime===raw.start||e.start===raw.start));

      const hasZnueni=raw.znueni.toLowerCase()==='ja'||raw.znueni==='1'||raw.znueni.toLowerCase()==='true';
      let mittagVal='60min';
      if(raw.mittag==='30min'||raw.mittag==='30')mittagVal='30min';
      else if(raw.mittag.toLowerCase()==='durchgearbeitet'||raw.mittag==='none'||raw.mittag==='0'||raw.mittag.toLowerCase()==='nein')mittagVal='none';

      let pauseMin=0;if(hasZnueni)pauseMin+=15;if(mittagVal==='60min')pauseMin+=60;else if(mittagVal==='30min')pauseMin+=30;

      const sM=timeToMin(raw.start),eM=timeToMin(raw.ende);
      const brutto=eM>sM?eM-sM:0;

      data.push({raw,dateStr,hasZnueni,mittagVal,pauseMin,brutto,netMin:Math.max(brutto-pauseMin,0),errors,isDup,line:i});
    }

    _maeImportData=data;

    // Render preview
    let html='<div style="margin:8px 0;font-size:.82rem"><strong>'+data.length+'</strong> EintrÃ¤ge gefunden, <span style="color:var(--danger)">'+data.filter(d=>d.errors.length).length+' Fehler</span>, <span style="color:var(--warning)">'+data.filter(d=>d.isDup).length+' Duplikate</span></div>';
    html+='<table class="mae-table"><thead><tr><th>#</th><th>Datum</th><th>Start</th><th>Ende</th><th>Projekt</th><th>KS</th><th>Netto</th><th>Status</th></tr></thead><tbody>';
    data.forEach((d,i)=>{
      const cls=d.errors.length?'error':d.isDup?'warn':'ok';
      const status=d.errors.length?'âŒ '+d.errors.join(', '):d.isDup?'âš ï¸ Duplikat':'âœ…';
      html+='<tr class="mae-import-row '+cls+'"><td>'+(i+1)+'</td><td>'+d.raw.datum+'</td><td>'+d.raw.start+'</td><td>'+d.raw.ende+'</td><td style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+d.raw.projekt+'</td><td>'+d.raw.ks+'</td><td style="font-family:var(--font-mono)">'+fmtH(d.netMin)+'</td><td style="font-size:.75rem">'+status+'</td></tr>';
    });
    html+='</tbody></table>';
    $('maeImportPreview').innerHTML=html;
    const valid=data.filter(d=>!d.errors.length);
    $('maeImportBtn').style.display=valid.length>0?'inline-flex':'none';
    $('maeImportBtn').textContent='âœ… '+valid.length+' EintrÃ¤ge importieren'+(data.filter(d=>d.isDup).length?' ('+data.filter(d=>d.isDup).length+' Duplikate Ã¼berspringen)':'');
  };
  reader.readAsText(file);
}

function maeDoImport(){
  if(!_maeEmpId||!_maeImportData.length)return;
  const valid=_maeImportData.filter(d=>!d.errors.length&&!d.isDup);
  if(!valid.length){toast('Keine gÃ¼ltigen EintrÃ¤ge','warning');return}
  const empKey=C.LS+_maeEmpId+'_entries';
  try{
    const all=JSON.parse(localStorage.getItem(empKey)||'[]');
    valid.forEach(d=>{
      all.push({
        id:Date.now().toString(36)+Math.random().toString(36).slice(2,6)+(d.line),
        date:d.dateStr,start:d.raw.start,end:d.raw.ende,startTime:d.raw.start,endTime:d.raw.ende,
        project:d.raw.projekt,projectName:d.raw.projekt,kostenstelle:d.raw.ks,costCenter:d.raw.ks,
        bemerkung:d.raw.bemerkung,note:d.raw.bemerkung,
        pauseMin:d.pauseMin,durationMin:d.netMin,hours:d.netMin/60,
        pauseZnueni:d.hasZnueni,znueniPause:d.hasZnueni,pauseMittag:d.mittagVal,mittagsPause:d.mittagVal,breakMinutes:d.pauseMin,
        created:new Date().toISOString(),createdBy:user.name,importedAt:new Date().toISOString()
      });
    });
    localStorage.setItem(empKey,JSON.stringify(all));
    syncEmpEntriesToSP(_maeEmpId);
    toast(valid.length+' EintrÃ¤ge importiert!','success');
    $('maeImportArea').style.display='none';
    _maeImportData=[];
    maeLoad();
  }catch(e){toast('Import-Fehler: '+e.message,'error')}
}

// ==================== BETRIEBSFERIEN & BRÃœCKENTAGE ====================
function getBetriebsferien(){try{return JSON.parse(localStorage.getItem(C.LS+'betriebsferien')||'[]')}catch{return[]}}
function saveBetriebsferien(bf){localStorage.setItem(C.LS+'betriebsferien',JSON.stringify(bf));if(accessToken)SP.writeFile('betriebsferien.json',{betriebsferien:bf}).then(()=>console.log('[SP] betriebsferien gespeichert')).catch(e=>console.warn('[SP] betriebsferien Fehler:',e))}

function renderBetriebsferien(){
  const el=$('bfList');if(!el)return;
  const bf=getBetriebsferien();
  if(!bf.length){el.innerHTML='<div style="font-size:.82rem;color:var(--text-dim);padding:8px 0">Keine Betriebsferien definiert</div>';return}
  const today=todayKey();
  let html='<table class="mae-table"><thead><tr><th>Bezeichnung</th><th>Typ</th><th>Zeitraum</th><th>Tage</th><th>Aktion</th></tr></thead><tbody>';
  bf.sort((a,b)=>a.from.localeCompare(b.from)).forEach(b=>{
    const days=countWorkdays(b.from,b.to);
    const past=b.to<today;
    const icon=b.type==='Betriebsferien'?'\uD83C\uDFE2':'\uD83C\uDF09';
    html+='<tr style="'+(past?'opacity:.5':'')+'"><td>'+icon+' '+b.label+'</td><td>'+b.type+'</td><td>'+fmtDate(b.from)+(b.from!==b.to?' \u2013 '+fmtDate(b.to):'')+'</td><td>'+days+'</td><td class="mae-actions"><button onclick="deleteBetriebsferien(\''+b.id+'\')" title="L\u00f6schen">\uD83D\uDDD1</button></td></tr>';
  });
  html+='</tbody></table>';
  el.innerHTML=html;
}

function addBetriebsferien(){
  const type=$('bfType').value;
  const label=$('bfLabel').value.trim();
  const from=$('bfFrom').value;
  const to=$('bfTo').value;
  if(!label){toast('Bezeichnung eingeben','warning');return}
  if(!from||!to){toast('Zeitraum ausfÃ¼llen','warning');return}
  if(new Date(to)<new Date(from)){toast('Bis nach Von','warning');return}
  const bf=getBetriebsferien();
  bf.push({id:Date.now().toString(36)+Math.random().toString(36).slice(2,6),type,label,from,to,createdBy:user.name,createdAt:new Date().toISOString()});
  saveBetriebsferien(bf);
  $('bfLabel').value='';$('bfFrom').value='';$('bfTo').value='';
  renderBetriebsferien();
  toast('Betriebsferien hinzugefÃ¼gt','success');
}

function deleteBetriebsferien(id){
  if(!confirm('Wirklich lÃ¶schen?'))return;
  let bf=getBetriebsferien();
  bf=bf.filter(b=>b.id!==id);
  saveBetriebsferien(bf);
  renderBetriebsferien();
  toast('GelÃ¶scht','success');
}

// Check if a date is Betriebsferien
function isBetriebsferien(dateStr){
  const bf=getBetriebsferien();
  return bf.find(b=>dateStr>=b.from&&dateStr<=b.to)||null;
}

// Count Betriebsferien-days consumed (where MA did NOT work)
function countBetriebsferienDays(empId,from,to){
  const bf=getBetriebsferien();
  const entries=getEntriesForEmployee(empId,from,to);
  const entryDates=new Set(entries.map(e=>e.date));
  const empS=getEmpSetting(empId);
  const arbeitsTage=empS.arbeitsTage||[1,2,3,4,5];
  let count=0;
  bf.forEach(b=>{
    const bFrom=b.from<from?from:b.from;
    const bTo=b.to>to?to:b.to;
    const d=new Date(bFrom);const end=new Date(bTo);
    while(d<=end){
      const dk=dateKey(d);
      const dow=d.getDay();
      if(arbeitsTage.includes(dow)&&!entryDates.has(dk)){count++}
      d.setDate(d.getDate()+1);
    }
  });
  return count;
}

// Load from SharePoint
async function loadBetriebsferienFromSP(){
  if(!accessToken)return;
  try{
    const data=await SP.readFile('betriebsferien.json');
    if(data&&data.betriebsferien){
      localStorage.setItem(C.LS+'betriebsferien',JSON.stringify(data.betriebsferien));
      renderBetriebsferien();
    }
  }catch(e){console.warn('BF load:',e)}
}

// ==================== MITARBEITER VERWALTEN ====================
function renderEmpManagement(){
  const el=$('empManageList');if(!el)return;
  let html='<table class="mae-table"><thead><tr><th>MA-Nr</th><th>Name</th><th>E-Mail</th><th>Rolle</th><th>Status</th><th>Aktion</th></tr></thead><tbody>';
  EMPLOYEES.forEach(e=>{
    const role=e.admin?'Admin':e.approver?'Approver':'Mitarbeiter';
    const archived=e.archived;
    html+='<tr style="'+(archived?'opacity:.5':'')+'"><td>'+e.id+'</td><td>'+e.name+'</td><td style="font-size:.75rem">'+(e.email||'<span style="color:var(--danger)">fehlt</span>')+'</td><td>'+role+'</td><td>'+(archived?'\uD83D\uDD12 Archiviert'+(e.archivedDate?' ('+fmtDate(e.archivedDate)+')':''):'\u2705 Aktiv')+'</td><td class="mae-actions"><button onclick="openEmpEditModal(\''+e.id+'\')" title="Bearbeiten">\u270F\uFE0F</button>'+(archived?'<button onclick="reactivateEmployee(\''+e.id+'\')" title="Reaktivieren">\u267B\uFE0F</button>':'<button onclick="archiveEmployee(\''+e.id+'\')" title="Archivieren">\uD83D\uDD12</button>')+'</td></tr>';
  });
  html+='</tbody></table>';
  el.innerHTML=html;
}

function addNewEmployee(){
  const name=$('newEmpName').value.trim();
  const email=$('newEmpEmail').value.trim();
  const role=$('newEmpRole').value;
  let id=$('newEmpId').value.trim();
  if(!name){toast('Name eingeben','warning');return}
  if(!id){
    const maxNum=EMPLOYEES.reduce((m,e)=>{const n=parseInt(e.id.replace('HM-',''));return n>m?n:m},0);
    id='HM-'+String(maxNum+1).padStart(3,'0');
  }
  if(EMPLOYEES.find(e=>e.id===id)){toast('MA-Nr existiert bereits','error');return}
  EMPLOYEES.push({id,name,email:email||null,admin:role==='admin',approver:role==='approver'||role==='admin',archived:false});
  saveEmployees(EMPLOYEES);
  $('newEmpName').value='';$('newEmpEmail').value='';$('newEmpId').value='';
  renderEmpManagement();renderEmpSettings();
  toast(name+' hinzugefÃ¼gt ('+id+')','success');
}

function archiveEmployee(id){
  const emp=EMPLOYEES.find(e=>e.id===id);if(!emp)return;
  if(emp.id===user.id){toast('Eigenen Account nicht archivieren!','error');return}
  if(!confirm(emp.name+' archivieren? Daten bleiben erhalten.'))return;
  emp.archived=true;emp.archivedDate=todayKey();
  saveEmployees(EMPLOYEES);
  renderEmpManagement();renderEmpSettings();
  toast(emp.name+' archiviert','success');
}

function reactivateEmployee(id){
  const emp=EMPLOYEES.find(e=>e.id===id);if(!emp)return;
  emp.archived=false;delete emp.archivedDate;
  saveEmployees(EMPLOYEES);
  renderEmpManagement();renderEmpSettings();
  toast(emp.name+' reaktiviert','success');
}

async function loadEmployeesFromSP(){
  if(!accessToken)return;
  try{
    const data=await SP.readFile('employees.json');
    if(data&&data.employees&&data.employees.length){
      // SP data takes priority - merge: SP overwrites, keep local-only entries
      const spIds=new Set(data.employees.map(e=>e.id));
      const localOnly=EMPLOYEES.filter(e=>!spIds.has(e.id));
      EMPLOYEES=[...data.employees,...localOnly];
      localStorage.setItem(C.LS+'employees',JSON.stringify(EMPLOYEES));
      console.log('[SP] employees geladen:',data.employees.length);
      if(user&&user.admin){renderEmpManagement();renderEmpSettings()}
    }
  }catch(e){console.warn('Emp load:',e)}
}

// ==================== ABWESENHEITEN CSV IMPORT ====================
let _maeAbsImportData=[];

function maeShowAbsImport(){
  if(!_maeEmpId){toast('Zuerst Mitarbeiter laden','warning');return}
  $('maeAbsImportArea').style.display='block';
  $('maeAbsCSVFile').value='';
  $('maeAbsImportPreview').innerHTML='<p style="color:var(--text-dim);font-size:.82rem">CSV-Datei auswÃ¤hlen (Format: Von;Bis;Typ;Dauer;Status;Bemerkung)</p>';
  $('maeAbsImportBtn').style.display='none';
}

function maeDownloadAbsTemplate(){
  const bom='\uFEFF';
  const header='Von;Bis;Typ;Dauer;Status;Bemerkung\n';
  const ex1='01.03.2025;05.03.2025;Ferien;Ganztag;Genehmigt;Skiferien\n';
  const ex2='10.04.2025;10.04.2025;Krankheit;Ganztag;Genehmigt;\n';
  const ex3='15.05.2025;15.05.2025;Ferien;Vormittag;Genehmigt;Halber Tag\n';
  const ex4='20.06.2025;20.06.2025;Unfall;Ganztag;Genehmigt;Handverletzung\n';
  const blob=new Blob([bom+header+ex1+ex2+ex3+ex4],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='Abwesenheiten_Import_Vorlage.csv';a.click();
  toast('Vorlage heruntergeladen','success');
}

function maeParseAbsCSV(){
  const file=$('maeAbsCSVFile').files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(ev){
    const lines=ev.target.result.split('\n').filter(l=>l.trim());
    if(lines.length<2){$('maeAbsImportPreview').innerHTML='<p style="color:var(--danger)">CSV leer</p>';return}
    const validTypes=['Ferien','Krankheit','Unfall','Milit\u00e4r/Zivildienst','Mutterschaft/Vaterschaft','Umzug','Unbezahlt','Sonstiges'];
    const data=[];
    for(let i=1;i<lines.length;i++){
      const cols=lines[i].split(';').map(c=>c.trim());
      if(cols.length<3)continue;
      const raw={von:cols[0],bis:cols[1]||cols[0],typ:cols[2],dauer:cols[3]||'Ganztag',status:cols[4]||'Genehmigt',bemerkung:cols[5]||''};
      // Parse dates
      let fromStr='',toStr='';
      if(raw.von.includes('.')){const p=raw.von.split('.');if(p.length===3)fromStr=p[2]+'-'+p[1].padStart(2,'0')+'-'+p[0].padStart(2,'0')}else fromStr=raw.von;
      if(raw.bis.includes('.')){const p=raw.bis.split('.');if(p.length===3)toStr=p[2]+'-'+p[1].padStart(2,'0')+'-'+p[0].padStart(2,'0')}else toStr=raw.bis;
      const errors=[];
      if(!fromStr||isNaN(new Date(fromStr).getTime()))errors.push('Von ung\u00fcltig');
      if(!toStr||isNaN(new Date(toStr).getTime()))errors.push('Bis ung\u00fcltig');
      if(!validTypes.includes(raw.typ))errors.push('Typ ung\u00fcltig ('+raw.typ+')');
      const dur=raw.dauer.toLowerCase()==='vormittag'?'morning':raw.dauer.toLowerCase()==='nachmittag'?'afternoon':'full';
      const status=raw.status.toLowerCase()==='genehmigt'?'approved':raw.status.toLowerCase()==='abgelehnt'?'rejected':'pending';
      const workdays=(!errors.length)?countWorkdays(fromStr,toStr,_maeEmpId):0;
      const days=dur==='full'?workdays:workdays*0.5;
      data.push({raw,fromStr,toStr,typ:raw.typ,dur,status,days,bemerkung:raw.bemerkung,errors,line:i});
    }
    _maeAbsImportData=data;
    let html='<div style="margin:8px 0;font-size:.82rem"><strong>'+data.length+'</strong> Abwesenheiten, <span style="color:var(--danger)">'+data.filter(d=>d.errors.length).length+' Fehler</span></div>';
    html+='<table class="mae-table"><thead><tr><th>#</th><th>Von</th><th>Bis</th><th>Typ</th><th>Dauer</th><th>Tage</th><th>Status</th><th>Pr\u00fcfung</th></tr></thead><tbody>';
    data.forEach((d,i)=>{
      const cls=d.errors.length?'error':'ok';
      html+='<tr class="mae-import-row '+cls+'"><td>'+(i+1)+'</td><td>'+d.raw.von+'</td><td>'+d.raw.bis+'</td><td>'+d.typ+'</td><td>'+d.raw.dauer+'</td><td>'+d.days+'</td><td>'+d.raw.status+'</td><td style="font-size:.75rem">'+(d.errors.length?'\u274C '+d.errors.join(', '):'\u2705')+'</td></tr>';
    });
    html+='</tbody></table>';
    $('maeAbsImportPreview').innerHTML=html;
    const valid=data.filter(d=>!d.errors.length);
    $('maeAbsImportBtn').style.display=valid.length?'inline-flex':'none';
    $('maeAbsImportBtn').textContent='\u2705 '+valid.length+' Abwesenheiten importieren';
  };
  reader.readAsText(file);
}

function maeDoAbsImport(){
  if(!_maeEmpId||!_maeAbsImportData.length)return;
  const valid=_maeAbsImportData.filter(d=>!d.errors.length);
  if(!valid.length){toast('Keine g\u00fcltigen Eintr\u00e4ge','warning');return}
  const emp=EMPLOYEES.find(e=>e.id===_maeEmpId);
  const allAbs=getAllAbsences();
  valid.forEach(d=>{
    allAbs.push({
      id:Date.now().toString(36)+Math.random().toString(36).slice(2,6)+d.line,
      employeeId:_maeEmpId,employeeName:emp?emp.name:'',
      type:d.typ,from:d.fromStr,to:d.toStr,duration:d.dur,status:d.status,
      days:d.days,note:d.bemerkung,
      created:new Date().toISOString(),createdBy:user.name,importedAt:new Date().toISOString()
    });
  });
  saveAllAbsences(allAbs);
  toast(valid.length+' Abwesenheiten importiert!','success');
  $('maeAbsImportArea').style.display='none';
  _maeAbsImportData=[];
  maeLoad();
}

// ==================== DASHBOARD ====================
let _dashData=null,_dashSelectedProj=new Set();

function getDashRange(){
  const p=$('dashPeriod').value;
  const now=new Date();const y=now.getFullYear();const m=now.getMonth();
  if(p==='month')return{from:dateKey(new Date(y,m,1)),to:dateKey(new Date(y,m+1,0))};
  if(p==='quarter'){const q=Math.floor(m/3)*3;return{from:dateKey(new Date(y,q,1)),to:dateKey(new Date(y,q+3,0))};}
  if(p==='year')return{from:y+'-01-01',to:y+'-12-31'};
  return{from:$('dashFrom').value||y+'-01-01',to:$('dashTo').value||dateKey(now)};
}

function loadDashboard(){
  const range=getDashRange();
  const emps=getActiveEmployees();
  const allAbs=getAllAbsences();
  const empSettings=getEmpSettings();

  let totalMin=0,totalEntries=0,krankTotal=0,unfallTotal=0;
  const ksBrk={},projBrk={},empData=[];

  emps.forEach(emp=>{
    const s=empSettings[emp.id]||{...EMP_DEFAULTS};
    const entries=getEntriesForEmployee(emp.id,range.from,range.to);
    const raucherMin=s.raucher?countUniqueDates(entries)*15:0;
    const empMin=entries.reduce((sum,e)=>sum+(e.durationMin||0),0)-raucherMin;
    const workDays=countWorkdays(range.from,range.to,emp.id);
    const sollH=calcSollHours(emp.id,range.from,range.to,s,workDays);
    const absences=allAbs.filter(a=>a.employeeId===emp.id&&a.from<=range.to&&a.to>=range.from&&a.status!=='rejected');
    const ferienDays=absences.filter(a=>a.type==='Ferien').reduce((s,a)=>s+a.days,0);
    const bfDays=countBetriebsferienDays(emp.id,range.from,range.to);
    const krankDays=absences.filter(a=>a.type==='Krankheit').reduce((s,a)=>s+a.days,0);
    const unfallDays=absences.filter(a=>a.type==='Unfall').reduce((s,a)=>s+a.days,0);
    const ferienAnspruch=Math.round(s.ferienTage*(s.pensum/100)*10)/10+(s.ferienUebertrag||0);

    totalMin+=empMin;totalEntries+=entries.length;
    krankTotal+=krankDays;unfallTotal+=unfallDays;

    entries.forEach(e=>{
      const ks=e.kostenstelle||e.costCenter||'Unbekannt';
      ksBrk[ks]=(ksBrk[ks]||0)+(e.durationMin||0);
      const proj=e.project||'Unbekannt';
      if(!projBrk[proj])projBrk[proj]={min:0,entries:0,emps:new Set(),ks:{}};
      projBrk[proj].min+=(e.durationMin||0);
      projBrk[proj].entries++;
      projBrk[proj].emps.add(emp.name);
      projBrk[proj].ks[ks]=(projBrk[proj].ks[ks]||0)+(e.durationMin||0);
    });

    empData.push({emp,entries:entries.length,istH:Math.round(empMin/6)/10,sollH:Math.round(sollH*10)/10,ferienAnspruch,ferienBez:ferienDays+bfDays,ferienRest:Math.round((ferienAnspruch-ferienDays-bfDays)*10)/10,krankDays,unfallDays,bfDays});
  });

  _dashData={range,totalMin,totalEntries,krankTotal,unfallTotal,ksBrk,projBrk,empData};

  // Build project picker checkboxes
  _dashSelectedProj=new Set(Object.keys(projBrk));
  renderDashProjPicker();

  // Render with all projects selected
  renderDashboard();

  $('dashPeriod').onchange=function(){$('dashCustomRange').style.display=this.value==='custom'?'grid':'none'};
}

function renderDashProjPicker(){
  if(!_dashData)return;
  const search=($('dashProjSearch')?$('dashProjSearch').value:'').toLowerCase();
  const allProj=Object.entries(_dashData.projBrk).sort((a,b)=>b[1].min-a[1].min);
  const filtered=search?allProj.filter(([p])=>p.toLowerCase().includes(search)):allProj;
  let html='';
  filtered.forEach(([p,d])=>{
    const checked=_dashSelectedProj.has(p)?'checked':'';
    const h=Math.round(d.min/6)/10;
    html+='<label style="display:flex;align-items:center;gap:6px;padding:3px 0;font-size:.8rem;cursor:pointer;border-bottom:1px solid var(--border)"><input type="checkbox" '+checked+' onchange="dashToggleProj(this,\''+p.replace(/'/g,"\\'")+'\')">'+'<span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+p+'</span><span style="font-family:var(--font-mono);color:var(--accent);font-size:.75rem">'+h+'h</span></label>';
  });
  if($('dashProjCheckboxes'))$('dashProjCheckboxes').innerHTML=html||'<p style="color:var(--text-dim);font-size:.8rem">Keine Projekte gefunden</p>';
  if($('dashProjCount'))$('dashProjCount').textContent=_dashSelectedProj.size+' von '+allProj.length+' Projekte gew\u00e4hlt';
}

function dashToggleProjCB(cb){const p=cb.getAttribute('data-proj').replace(/&amp;/g,'&').replace(/&quot;/g,'"').replace(/&lt;/g,'<');if(cb.checked)_dashSelectedProj.add(p);else _dashSelectedProj.delete(p);if($('dashProjCount'))$('dashProjCount').textContent=_dashSelectedProj.size+' von '+Object.keys(_dashData.projBrk).length+' Projekte gew\u00e4hlt';renderDashboard()}
function dashToggleProj(cb,proj){dashToggleProjCB(cb)}
function dashSelectAll(){if(!_dashData)return;_dashSelectedProj=new Set(Object.keys(_dashData.projBrk));renderDashProjPicker();renderDashboard()}
function dashSelectNone(){_dashSelectedProj=new Set();renderDashProjPicker();renderDashboard()}
function dashFilterProjects(){renderDashProjPicker()}

function renderDashboard(){
  if(!_dashData)return;
  const d=_dashData;
  const selProj=_dashSelectedProj;

  // Recalculate with selected projects only
  let selMin=0,selEntries=0;
  const selKsBrk={};
  const projArr=Object.entries(d.projBrk).filter(([p])=>selProj.has(p)).sort((a,b)=>b[1].min-a[1].min);
  projArr.forEach(([p,pd])=>{
    selMin+=pd.min;selEntries+=pd.entries;
    Object.entries(pd.ks).forEach(([k,m])=>{selKsBrk[k]=(selKsBrk[k]||0)+m});
  });

  // KPIs
  const totalH=Math.round(d.totalMin/6)/10;
  const selH=Math.round(selMin/6)/10;
  const emps=getActiveEmployees();
  const avgH=emps.length?Math.round(totalH/emps.length*10)/10:0;
  $('dashKPIs').innerHTML='<div class="stat-grid" style="margin:12px 0"><div class="stat-box"><div class="stat-num" style="color:var(--primary)">'+totalH+'h</div><div class="stat-label">Total Stunden</div></div><div class="stat-box"><div class="stat-num" style="color:var(--accent)">'+selH+'h</div><div class="stat-label">Gew\u00e4hlte Projekte</div></div><div class="stat-box"><div class="stat-num" style="color:var(--accent)">'+avgH+'h</div><div class="stat-label">\u00d8 pro MA</div></div><div class="stat-box"><div class="stat-num" style="color:var(--danger)">'+d.krankTotal+'</div><div class="stat-label">Krankheitstage</div></div><div class="stat-box"><div class="stat-num" style="color:var(--warning)">'+d.unfallTotal+'</div><div class="stat-label">Unfalltage</div></div><div class="stat-box"><div class="stat-num">'+selProj.size+'/'+Object.keys(d.projBrk).length+'</div><div class="stat-label">Projekte</div></div></div>';

  // KS
  $('dashKS').style.display='block';
  const ksTotal=Object.values(selKsBrk).reduce((s,v)=>s+v,0);
  $('dashKSContent').innerHTML=Object.entries(selKsBrk).sort((a,b)=>b[1]-a[1]).map(([k,m])=>{
    const pct=ksTotal?Math.round(m/ksTotal*100):0;
    return '<div class="stat-bar-item"><div class="stat-bar-label">'+k+'</div><div class="stat-bar-track"><div class="stat-bar-fill" style="width:'+pct+'%;background:'+(KS_COLORS[k]||'#666')+'"></div></div><div class="stat-bar-value">'+(Math.round(m/6)/10)+'h ('+pct+'%)</div></div>';
  }).join('')||'<p style="color:var(--text-dim);font-size:.82rem">Keine Daten</p>';

  // Projects
  $('dashProjects').style.display='block';
  $('dashProjTitle').textContent='Projekt-\u00dcbersicht ('+projArr.length+' Projekte)';
  $('dashProjectsList').innerHTML=projArr.slice(0,50).map(([p,pd])=>{
    const h=Math.round(pd.min/6)/10;
    const ksHtml=Object.entries(pd.ks).sort((a,b)=>b[1]-a[1]).map(([k,m])=>'<span style="font-size:.72rem;color:var(--text-dim)">'+k+': '+(Math.round(m/6)/10)+'h</span>').join(' \u00b7 ');
    return '<div style="padding:8px 0;border-bottom:1px solid var(--border)"><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:.85rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:65%" title="'+p+'">'+p+'</span><span style="font-family:var(--font-mono);font-weight:600;color:var(--accent)">'+h+'h</span></div><div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:2px">'+ksHtml+' \u00b7 <span style="font-size:.72rem;color:var(--text-dim)">'+pd.emps.size+' MA \u00b7 '+pd.entries+' Eintr.</span></div></div>';
  }).join('')+(projArr.length>50?'<p style="color:var(--text-dim);font-size:.8rem;padding:8px 0">...und '+(projArr.length-50)+' weitere</p>':'');

  // Absence overview
  $('dashAbsence').style.display='block';
  let absHtml='<table class="mae-table"><thead><tr><th>Mitarbeiter</th><th>Ferien Anspruch</th><th>Bezogen</th><th>BF</th><th>Rest</th><th>Krankheit</th><th>Unfall</th></tr></thead><tbody>';
  d.empData.forEach(ed=>{
    absHtml+='<tr><td>'+ed.emp.name+'</td><td>'+ed.ferienAnspruch+'</td><td>'+ed.ferienBez+'</td><td>'+ed.bfDays+'</td><td style="color:'+(ed.ferienRest>=0?'var(--success)':'var(--danger)')+';font-weight:600">'+ed.ferienRest+'</td><td style="color:var(--danger)">'+ed.krankDays+'</td><td>'+ed.unfallDays+'</td></tr>';
  });
  absHtml+='</tbody></table>';
  $('dashAbsContent').innerHTML=absHtml;
}

function exportDashboardCSV(){
  if(!_dashData){toast('Zuerst Dashboard laden','warning');return}
  const d=_dashData;
  let csv='\uFEFF';

  csv+='Projekt;Stunden;Eintr\u00e4ge;Mitarbeiter';
  const ksList=Object.keys(d.ksBrk);ksList.forEach(k=>csv+=';'+k);
  csv+='\n';
  let projArr=Object.entries(d.projBrk).filter(([p])=>_dashSelectedProj.has(p)).sort((a,b)=>b[1].min-a[1].min);
  projArr.forEach(([p,pd])=>{
    csv+=p+';'+Math.round(pd.min/6)/10+';'+pd.entries+';'+pd.emps.size;
    ksList.forEach(k=>csv+=';'+(pd.ks[k]?Math.round(pd.ks[k]/6)/10:0));
    csv+='\n';
  });
  csv+='\n\nMitarbeiter;Ist-h;Soll-h;Saldo;Ferien Anspruch;Ferien Bezogen;Ferien Rest;Krankheit;Unfall\n';
  d.empData.forEach(e=>{
    csv+=e.emp.name+';'+e.istH+';'+e.sollH+';'+Math.round((e.istH-e.sollH)*10)/10+';'+e.ferienAnspruch+';'+e.ferienBez+';'+e.ferienRest+';'+e.krankDays+';'+e.unfallDays+'\n';
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='Dashboard_'+d.range.from+'_'+d.range.to+'.csv';a.click();
  toast('CSV exportiert','success');
}

function exportDashboardHTML(){
  if(!_dashData){toast('Zuerst Dashboard laden','warning');return}
  const content=$('tab-dashboard');if(!content)return;
  const r=_dashData.range;
  const html='<!DOCTYPE html><html><head><meta charset="utf-8"><title>Dashboard Report</title><style>body{font-family:Arial,sans-serif;max-width:1000px;margin:0 auto;padding:20px;color:#333}h1{font-size:1.3rem;border-bottom:2px solid #FF6B35;padding-bottom:8px}.stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:16px 0}.stat-box{background:#f8f9fa;padding:12px;border-radius:6px;text-align:center}.stat-num{font-size:1.2rem;font-weight:700}.stat-label{font-size:.7rem;color:#666}.stat-bar-item{display:flex;align-items:center;gap:8px;margin-bottom:6px}.stat-bar-label{width:80px;font-size:.8rem}.stat-bar-track{flex:1;height:8px;background:#eee;border-radius:4px;overflow:hidden}.stat-bar-fill{height:100%;border-radius:4px}.stat-bar-value{width:100px;text-align:right;font-size:.8rem}table{width:100%;border-collapse:collapse;font-size:.82rem;margin-top:8px}th{text-align:left;padding:6px;border-bottom:2px solid #ddd;font-size:.72rem;text-transform:uppercase;color:#666}td{padding:6px;border-bottom:1px solid #eee}.card{border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px}.card-title{font-weight:700;margin-bottom:12px}@media print{.card{break-inside:avoid}}</style></head><body><h1>\u23F1 Dashboard Report \u2013 Hubler Metallbau AG</h1><p style="color:#666">'+fmtDate(r.from)+' \u2013 '+fmtDate(r.to)+' \u2022 Erstellt: '+fmtDate(dateKey(new Date()))+'</p>'+$('dashKPIs').innerHTML+'<div class="card"><div class="card-title">Kostenstellen</div>'+$('dashKSContent').innerHTML+'</div><div class="card"><div class="card-title">'+$('dashProjTitle').textContent+'</div>'+$('dashProjectsList').innerHTML+'</div><div class="card"><div class="card-title">Abwesenheiten</div>'+$('dashAbsContent').innerHTML+'</div></body></html>';
  const blob=new Blob([html],{type:'text/html;charset=utf-8'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='Dashboard_Report_'+r.from+'_'+r.to+'.html';a.click();
  toast('Report heruntergeladen','success');
}

// ==================== EMPLOYEE EDIT MODAL ====================
let _empManageId=null;
function openEmpEditModal(id){
  const emp=EMPLOYEES.find(e=>e.id===id);if(!emp)return;
  _empManageId=id;
  $('empMgId').value=emp.id;
  $('empMgName').value=emp.name;
  $('empMgEmail').value=emp.email||'';
  $('empMgRole').value=emp.admin?'admin':emp.approver?'approver':'employee';
  $('empManageModal').classList.add('show');
}

function saveEmpManageModal(){
  const emp=EMPLOYEES.find(e=>e.id===_empManageId);if(!emp)return;
  const name=$('empMgName').value.trim();
  const email=$('empMgEmail').value.trim();
  const role=$('empMgRole').value;
  if(!name){toast('Name eingeben','warning');return}
  emp.name=name;
  emp.email=email||null;
  emp.admin=role==='admin';
  emp.approver=role==='approver'||role==='admin';
  saveEmployees(EMPLOYEES);
  $('empManageModal').classList.remove('show');
  renderEmpManagement();renderEmpSettings();
  toast(name+' aktualisiert','success');
}

// ==================== PERSONAL NOTIFICATIONS ====================
function getMyNotifSettings(){
  try{return JSON.parse(localStorage.getItem(C.LS+(user?user.id+'_':'')+'my_notif'))||{morning:'06:55',morningOn:true,evening:'16:45',eveningOn:true}}catch{return{morning:'06:55',morningOn:true,evening:'16:45',eveningOn:true}}
}
function saveMyNotifSettings(s){localStorage.setItem(C.LS+(user?user.id+'_':'')+'my_notif',JSON.stringify(s))}

function initMyNotif(){
  const s=getMyNotifSettings();
  if($('myNotifMorning'))$('myNotifMorning').value=s.morning||'06:55';
  if($('myNotifMorningOn'))$('myNotifMorningOn').value=s.morningOn!==false?'1':'0';
  if($('myNotifEvening'))$('myNotifEvening').value=s.evening||'16:45';
  if($('myNotifEveningOn'))$('myNotifEveningOn').value=s.eveningOn!==false?'1':'0';
  updateMyNotifStatus();
}

function updateMyNotifStatus(){
  const el=$('myNotifStatus');if(!el)return;
  if(!('Notification' in window)){el.textContent='Nicht unterst\u00fctzt';return}
  el.textContent=Notification.permission==='granted'?'\u2705 Aktiviert':Notification.permission==='denied'?'\u274C Blockiert':'\u23F3 Noch nicht aktiviert';
}

if($('myNotifEnableBtn'))$('myNotifEnableBtn').onclick=async function(){
  if(!('Notification' in window)){toast('Browser unterst\u00fctzt keine Benachrichtigungen','error');return}
  const perm=await Notification.requestPermission();
  if(perm==='granted'){toast('Benachrichtigungen aktiviert!','success');updateMyNotifStatus();showNotif('Hubler Zeiterfassung','Benachrichtigungen aktiv!')}
  else{toast('Berechtigung abgelehnt','warning');updateMyNotifStatus()}
};

if($('myNotifTestBtn'))$('myNotifTestBtn').onclick=function(){
  if(Notification.permission!=='granted'){toast('Zuerst aktivieren','warning');return}
  showNotif('Test','Benachrichtigungen funktionieren! \uD83D\uDE80');
};

if($('myNotifSaveBtn'))$('myNotifSaveBtn').onclick=function(){
  const s={morning:$('myNotifMorning').value,morningOn:$('myNotifMorningOn').value==='1',evening:$('myNotifEvening').value,eveningOn:$('myNotifEveningOn').value==='1'};
  saveMyNotifSettings(s);
  toast('Benachrichtigungen gespeichert','success');
};

// Personal notification check (runs every minute)
function checkMyNotifications(){
  if(Notification.permission!=='granted'||!user)return;
  const s=getMyNotifSettings();
  const now=new Date();
  const hm=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  const dow=now.getDay();
  if(dow===0||dow===6)return;

  if(s.morningOn&&hm===s.morning){
    const entries=getEntries().filter(e=>e.date===todayKey());
    if(!entries.length&&!timer.on)showNotif('\u23F0 Guten Morgen!','Vergiss nicht den Timer zu starten','morning-'+todayKey());
  }
  if(s.eveningOn&&hm===s.evening){
    if(timer.on)showNotif('\uD83C\uDFE0 Feierabend?','Timer l\u00e4uft noch - nicht vergessen zu stoppen!','evening-'+todayKey());
  }
}
setInterval(checkMyNotifications,60000);

</script>
</body>
</html>